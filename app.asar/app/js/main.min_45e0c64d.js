var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,r){function s(t){try{c(n.next(t))}catch(e){r(e)}}function a(t){try{c(n["throw"](t))}catch(e){r(e)}}function c(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(s,a)}c((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,r&&(s=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,r=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){c=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){c.label=i[1];break}if(6===i[0]&&c.label<s[1]){c.label=s[1],s=i;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(i);break}s[2]&&c.ops.pop(),c.trys.pop();continue}i=e.call(t,c)}catch(n){i=[6,n],r=0}finally{o=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,r,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},Novice;!function(t){function e(t,e){var i=e?e:1,n=new Object;n[t]=i;var o=Net.ws();o.send("novicedata",{novice_map:n})}t.set=e}(Novice||(Novice={}));var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function n(n){e.call(i,n,t)}if(RES.hasRes(t)){var o=RES.getRes(t);o?n(o):RES.getResAsync(t,n,this)}else RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var Main=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.hide=!1,e}return __extends(e,t),e.prototype.createChildren=function(){var e=this;t.prototype.createChildren.call(this),egret.registerImplementation("eui.IAssetAdapter",new AssetAdapter),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),Logger.useDefaults({}),this.stage.maxTouches=1,mouse.enable(this.stage),Keyboard.init(),Wheel.init(),this.runGame().then(function(){Watcher.init()})["catch"](function(t){Logger.log(t)}),Events.register(NETWORK.out,function(){Widget.pop("PopupDialog",{content:"网络未链接，请检查网络后再次启动游戏",button:["确定"],callback:function(t){("Skin.VideoView"===Scenes.currentUI||"Skin.EscView"===Scenes.currentUI)&&(Player.exit(),Scenes.exitUI(Scenes.currentUI)),Scenes.addUI("Skin.LoginView")}})},this),Events.register("steam-listener-minimize",function(){("Skin.VideoView"===Scenes.currentUI||"Skin.EscView"===Scenes.currentUI)&&(e.timeout=setTimeout(function(){"Skin.EscView"===Scenes.currentUI&&Scenes.exitUI("Skin.EscView"),Player.exit(PlayerFlag.PS_Start),e.hide=!0,e.timeout=0},5e3))},this),Events.register("steam-listener-restore",function(){e.timeout?(clearTimeout(e.timeout),e.timeout=0):e.hide&&(Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}),e.hide=!1)},this),Events.register("steam-listener-platformExit",function(){Widget.pop("PopupDialog",{content:"Steam平台已经退出，请退出重新启动Steam",button:["确定"],callback:function(t){Steam.exitGame()}})},this),Events.register("steam-listener-dlcInstall",function(){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,Steam.getSteamInfo()];case 1:return t=e.sent(),0===t.ret&&(USER.openid=t.data.steamId,USER.ticket=t.data.ticket,USER.encryid=t.data.encryid,localStorage.setItem("steamInfo",JSON.stringify(t))),[2]}})})},this)},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.loadResource()];case 1:return t.sent(),this.createGameScene(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return t.sent(),[4,Promise.all([this.loadTheme(),this.loadLoginResource(),this.getSystemInfo()])];case 2:return t.sent(),[2]}})})},e.prototype.loadLoginResource=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,Promise.all([RES.loadGroup("popup"),RES.loadGroup("audio"),RES.loadGroup("login")])]})})},e.prototype.loadTheme=function(){var t=this;return new Promise(function(e,i){var n=new eui.Theme("resource/default.thm.json",t.stage);n.addEventListener(eui.UIEvent.COMPLETE,function(){e()},t)})},e.prototype.getSystemInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return"steam"!==Env.app?[3,2]:[4,Steam.getSystemInfo()];case 1:t=i.sent(),0===t.ret?(e=t.data,USER.bgm=e.custom.bgm,USER.effect=e.custom.effect,USER.system=e.system,USER.volume=e.custom.volume,USER.path=e.app.path):(USER.bgm=!0,USER.effect=!0,USER.volume=1),i.label=2;case 2:return[2,!0]}})})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return Toast.init(this),Scenes.init(this),Prompt.init(this),Loading.init(this),Scenes.addUI("Skin.LoginView"),[2]})})},e}(eui.UILayer);__reflect(Main.prototype,"Main");var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,n){function o(t){e.call(n,t)}function r(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),i.call(n))}var s=this;"undefined"!=typeof generateEUI?egret.callLater(function(){e.call(n,generateEUI)},this):"undefined"!=typeof generateEUI2?RES.getResByUrl("resource/gameEui.json",function(t,i){window.JSONParseClass.setData(t),o(t),egret.callLater(function(){e.call(n,generateEUI2)},s)},this,RES.ResourceItem.TYPE_JSON):(RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(t,o,this,RES.ResourceItem.TYPE_TEXT))},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Component;!function(t){function e(t){t.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){t.currentState="move"},this),t.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){t.currentState="up"},this),t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.currentState="down"},this),t.addEventListener(egret.TouchEvent.TOUCH_END,function(e){var i=e.localX<0||e.localY<0||e.localX>t.width||e.localY>t.height;t.currentState=i?"up":"move"},this)}t.buttonMousemove=e;var i=function(t){function e(){var e=t.call(this)||this;return e.skinName="ButtonIndexSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){Scenes.get("Skin.StartView").setIndex(e.name)},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"disabled"!=e.currentState&&(e.currentState="down")},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(){"disabled"!=e.currentState&&(e.currentState="move")},this)},e}(eui.Button);t.ButtonIndex=i,__reflect(i.prototype,"Component.ButtonIndex",["eui.UIComponent","egret.DisplayObject"]);var n=function(t){function e(){var e=t.call(this)||this;return e.skinName="ButtonSettingArrowSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){"disabled"!=e.currentState&&(e.currentState="move")},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){"disabled"!=e.currentState&&(e.currentState="up")},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"disabled"!=e.currentState&&(e.currentState="down")},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(){"disabled"!=e.currentState&&(e.currentState="move")},this)},e}(eui.Button);t.ButtonSettingArrow=n,__reflect(n.prototype,"Component.ButtonSettingArrow",["eui.UIComponent","egret.DisplayObject"]);var o=function(t){function e(){var e=t.call(this)||this;return e.skinName="ButtonStoryLocationSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.tips.desc.text="至当前进度点",this.tips.desc.textColor=10066329,this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.tips.visible=!0,e.currentState="move"},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.tips.visible=!1,e.currentState="up"},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.currentState="down"},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(){e.currentState="move"},this)},e}(eui.Button);t.ButtonStoryLocation=o,__reflect(o.prototype,"Component.ButtonStoryLocation",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){function e(){return new Promise(function(t){var e=[],i=[2,3,30,4,1,5,6,7,8,9,10,11,27,28,29];i.forEach(function(t){var i="ACH_"+t;e.push(function(){return console.log(i),Steam.clearAchievement(i)})});var n=new Q.PromiseQueue({concurrency:1,callback:function(){t(!0)}});n.add(e)})}var i;!function(t){t[t.LIST=0]="LIST",t[t.CHAPTER=1]="CHAPTER",t[t.COINS=2]="COINS",t[t.RESTART=3]="RESTART",t[t.TIME=4]="TIME"}(i||(i={}));var n=function(t){function n(){var e=t.call(this)||this;return e.show=!1,e.skinName="ChapterJumpSkin",e}return __extends(n,t),n.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},n.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.touchEnabled=!1,this.x=34,this.y=182,this.gJump.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onShow,this),this.btnMenu1.addEventListener(egret.TouchEvent.TOUCH_TAP,this.openSelect,this),this.btnMenu6.addEventListener(egret.TouchEvent.TOUCH_TAP,this.restart,this),this.btnMenu7.addEventListener(egret.TouchEvent.TOUCH_TAP,this.addCoins,this),this.btnMenu8.addEventListener(egret.TouchEvent.TOUCH_TAP,this.openTime,this),this.btnMenu9.addEventListener(egret.TouchEvent.TOUCH_TAP,this.openBuy,this)},n.prototype.onShow=function(){switch(this.show){case!1:this.gMenu.visible=!0,this.imgIcon.skewX=180,this.show=!0;break;case!0:this.gMenu.visible=!1,this.imgIcon.skewX=0,this.show=!1}},n.prototype.sendGM=function(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return i=Net.ws(),[4,i.send("gm",{cmd_id:t,param:e})];case 1:return[2,n.sent()]}})})},n.prototype.openSelect=function(t){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s,a=this;return __generator(this,function(c){return t=[],Object.keys(STORY.allChaptersInfo).forEach(function(e){var i=STORY.allChaptersInfo[e];(i.index||0===i.index)&&(t[i.index]=i.ChapterLabel)}),e=new eui.Rect,e.width=this.parent.width,e.height=this.parent.height,e.fillColor=0,e.fillAlpha=.7,this.parent.addChild(e),i=new eui.Image,i.width=400,i.height=300,i.source=RES.getRes("xiala_png"),i.scale9Grid=new egret.Rectangle(3,3,24,24),i.horizontalCenter=0,i.verticalCenter=0,this.parent.addChild(i),n=new eui.Group,n.width=400,n.height=300,o=new eui.List,o.dataProvider=new eui.ArrayCollection(t),r='\n        <e:Skin xmlns:e="http://ns.egret.com/eui" states="up,down" width="350" height="70"> <e:Label text="{data}" textColor.up="0xFFFFFF"  textColor.down="0x666666" height="70"/> </e:Skin>',o.itemRendererSkinName=r,o.horizontalCenter=0,n.addChild(o),s=new eui.Scroller,s.viewport=n,s.height=300,s.horizontalCenter=0,s.verticalCenter=0,this.parent.addChild(s),o.addEventListener(eui.ItemTapEvent.ITEM_TAP,function(t){a.openCharpter(o.selectedIndex)},this),e.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){a.parent.removeChild(s),a.parent.removeChild(i),a.parent.removeChild(e)},this),[2]})})},n.prototype.openCharpter=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(n){switch(n.label){case 0:return[4,this.sendGM(i.CHAPTER,[t])];case 1:return e=n.sent(),0===e.ret?Toast.show("解锁成功"):Toast.show("解锁失败"),setTimeout(function(){location.reload()},500),[2]}})})},n.prototype.openTime=function(){Widget.pop("EditTime",!0)},n.prototype.openBuy=function(){Widget.pop("EditDonate",!0)},n.prototype.restart=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return LS.set("PROMPT.award",{}),LS.set("PROMPT.achieve",{}),LS.set("PROMPT.olachieve",{}),LS.set("STORY.AwardVideoNode",[]),[4,e()];case 1:return n.sent(),[4,this.sendGM(i.RESTART)];case 2:return t=n.sent(),MALL.coin=0,Toast.show("已初始化数据"),setTimeout(function(){location.reload()},300),[2]}})})},n.prototype.addCoins=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.sendGM(i.COINS,[1e3])];case 1:return t=e.sent(),0===t.ret?(MALL.coin+=1e3,Toast.show("成功增加1000金币")):Toast.show("增加金币失败"),[2]}})})},n}(eui.Component);t.ChapterJump=n,__reflect(n.prototype,"Component.ChapterJump",["eui.UIComponent","egret.DisplayObject"]);var o=function(t){function e(){var e=t.call(this)||this;return e.skinName="EditTime",e.width=1920,e.height=1080,e.horizontalCenter=0,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.timestamp=Time.now()-Time.getDiff();var e=new Date(1e3*this.timestamp);this.Year.text=e.getFullYear().toString(),this.Month.text=(e.getMonth()+1).toString(),this.Day.text=e.getDate().toString(),this.Hour.text=e.getHours().toString(),this.Minute.text=e.getMinutes().toString(),this.btnSubmit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSubmit,this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.closePop()},this)},e.prototype.onSubmit=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return t=Net.ws(),[4,t.send("gm",{cmd_id:i.TIME,param:[parseInt(this.Year.text),parseInt(this.Month.text),parseInt(this.Day.text),parseInt(this.Hour.text),parseInt(this.Minute.text),0]}).then(function(t){0===t.ret?(Toast.show("设置成功"),setTimeout(function(){location.reload()},500)):Toast.show("设置失败")})];case 1:return e=n.sent(),[2]}})})},e}(eui.Component);t.EditTime=o,__reflect(o.prototype,"Component.EditTime",["eui.UIComponent","egret.DisplayObject"]);var r=function(t){function e(){var e=t.call(this)||this;return e.skinName="EditDonate",e.width=1920,e.height=1080,e.horizontalCenter=0,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnFlower1.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return e.onSubmit(2,1,6)},this),this.btnFlower2.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return e.onSubmit(2,6,198)},this),this.btnEgg1.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return e.onSubmit(1,7,6)},this),this.btnEgg2.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return e.onSubmit(1,12,198)},this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.closePop()},this)},e.prototype.onSubmit=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var n,o;return __generator(this,function(r){switch(r.label){case 0:return n=Net.ws(),[4,n.send("buy",{shop_id:e,item_list:[{item_type:t,count:i}],price:i})];case 1:return o=r.sent(),0===o.ret?Toast.show("购买成功"):Toast.show("购买失败"),[2]}})})},e}(eui.Component);t.EditDonate=r,__reflect(r.prototype,"Component.EditDonate",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(e){function i(t){var i=e.call(this)||this;return i.exit=!1,i.data=t,i.buttons=[],i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.init()},i.prototype.init=function(){var t=this;this.width=this.parent.width,this.height=this.parent.height,this.touchEnabled=!1;var e=this.data.info;if(e.question){var i=this.parent;this.question=new n,this.question.text=e.question,this.question.horizontalCenter=0,this.question.y=(i.height-50)/2+25,this.question.alpha=0,this.question.line.visible=!1,this.addChild(this.question),egret.Tween.get(this.question).to({alpha:1},300).wait(200).to({y:60},500).call(function(){t.question.line.visible=!0,t.addButton(),setTimeout(function(){Effect.play(AUDIO.OptionPopup_ogg)},500)},this)}else this.addButton(),setTimeout(function(){Effect.play(AUDIO.OptionPopup_ogg)},500);NOVICE[NOVICE_TYPE.choice]||this.addNovice()},i.prototype.getButton=function(t,e,i){var n=Pool.get("Component.TextButton",{data:t,callback:e,multiple:i});return n},i.prototype.cacheButton=function(t){t.parent.removeChild(t),Pool.set(t),t.data=void 0,t.callback=void 0,t.multiple=!1,t.moveable=!1,t.currentState="up",t.icon.alpha=0,t.startIcon.stop(),t.startTween.stop(),t.selectIcon.stop(),t.selectTween.stop(),t.multipleTween.stop()},i.prototype.addButton=function(){var t=this;if(!this.exit){var e=this.data.info,i=(this.data.events,this.data.idx,[]);e.buttons.forEach(function(t){!t.is_hidden&&i.push(t)});var n=i.length;i.forEach(function(i,o){var r=e.is_multiple_choice?t.getButton(i,function(){return t.choose(o)},e.is_multiple_choice):t.getButton(i,function(){return t.choose(o)});mouse.setButtonMode(r,!0),r.horizontalCenter=o%2===0?-422:422,n>4?r.y=860-(o>1?0:129)-(o>3?0:129):n>2?r.y=731+(o>1?129:0):1===n?r.horizontalCenter=0:r.y=860,r.alpha=0,t.buttons.push(r),r.init(),t.addChild(r),egret.Tween.get(r).to({alpha:1},300)})}},i.prototype.addNovice=function(){if(!NOVICE[NOVICE_TYPE.choice]){this.noviceGroup=new eui.Group,this.noviceGroup.width=1920,this.noviceGroup.horizontalCenter=0,this.noviceGroup.touchEnabled=!1;var e=new t.Exclamation;e.x=687,e.y=34;var i=new eui.Label("你可以通过选择改变剧情走向，决定角色的命运");i.x=756,i.y=52,i.textColor=16777215,i.size=22,i.fontFamily="Microsoft Yahei";var n=Movie.getMC("liuguang");n.play(-1),n.width=509,n.height=90,n.x=756,n.y=18,this.noviceGroup.addChild(n),this.noviceGroup.addChild(e),this.noviceGroup.addChild(i),this.addChild(this.noviceGroup)}},i.prototype.choose=function(t){var e=this;return new Promise(function(i,n){if(e.waiting||t>=e.buttons.length||e.exit)return void i(!1);e.waiting=!0;var o=e.data.info,r=e.data.idx,s=e.data.events,a=o.buttons[t].nodeid,c=e.buttons[t];Effect.play(AUDIO.StoryChoice_Press_ogg),c.currentState="down",c.selectIcon&&c.selectIcon.play(0),c.selectTween&&c.selectTween.play(0),NOVICE[NOVICE_TYPE.choice]||(Novice.set(NOVICE_TYPE.choice),Scenes.get("Skin.VideoView").showOn(),Scenes.get("Skin.VideoView").storyTween.play(0),e.removeChild(e.noviceGroup)),Player.listener({id:t,channel:"choice",idx:r,events:s[a]}).then(function(n){e.result=n,n?(e.animate(t),i(!0)):(c.currentState="up",e.waiting=!1,i(!1))})})},i.prototype.animate=function(t){var e=this;if(!this.exit&&this.parent){var i=this.buttons.splice(t,1)[0];this.parent.width;console.log("+++++++++++++this.buttons"),console.log(this.buttons),this.buttons.forEach(function(t){egret.Tween.get(t).to({alpha:0},200).call(function(){return e.cacheButton(t)})}),egret.Tween.get(i).wait(200).call(function(){e.exit||(e.result&&8!==Player.status()&&Player.play(),e.cacheButton(i),e.result&&e.complete())},this)}},i.prototype.complete=function(){!this.exit&&this.parent&&(this.exit=!0,Player.clearButton(),this.waiting=!1)},i}(eui.Component);t.TextChoice=e,__reflect(e.prototype,"Component.TextChoice");var i=function(t){function e(e,i,n){var o=t.call(this)||this;return o.skinName="TextButtonSkin",o.data=e,o.callback=i,n&&(o.multiple=n),o}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.multipleTween.addEventListener(egret.Event.COMPLETE,this.multipleIcon,this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.moveable&&(e.currentState="move")},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.moveable&&(e.currentState="up")},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.moveable&&(e.currentState="down")},this),this.startTween.addEventListener(egret.Event.COMPLETE,function(){e.moveable=!0},this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,function(t){e.callback(),t.stopPropagation(),t.stopImmediatePropagation()},this)},e.prototype.init=function(){var t=this;this.moveable=!1,this.currentState="up",this.icon.alpha=0,this.startIcon.stop(),this.startTween.stop(),this.selectIcon.stop(),this.selectTween.stop(),this.multipleTween.stop(),this.multiple&&!this.data.is_locked?this.multipleTween.play(0):this.data.is_locked?(this.icon.alpha=0,this.startTween.play(0)):(this.startIcon.play(0),this.startTween.play(0));var e=function(){t.currentState="down"};this.selectTween.addEventListener(egret.Event.COMPLETE,e,this),this.labelDisplay.text=this.data.name},e.prototype.multipleIcon=function(){this.icon.alpha=.3,this.moveable=!0},e}(eui.Component);t.TextButton=i,__reflect(i.prototype,"Component.TextButton");var n=function(t){function e(){var e=t.call(this)||this;return e.skinName="TextQuestionSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},Object.defineProperty(e.prototype,"text",{get:function(){return this.label.text},set:function(t){this.label.text=t},enumerable:!0,configurable:!0}),e}(eui.Component);__reflect(n.prototype,"TextQuestion");var o=function(t){function e(e,i){var n=t.call(this,e)||this;return n.radio=i,n.map={"hand.png":"QTE_shou_icon_png","icon.png":"icon_png"},n}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.addButton=function(){var t=this;if(!this.exit){var e=this.data.info,i=this.data.events,n=this.data.idx,o=[];e.buttons.forEach(function(t){!t.is_hidden&&o.push(t)});o.length;o.forEach(function(e,o){var r=t.map[e.image],s=new eui.Image(r);s.x=Math.floor((e.x-e.width/2)*t.radio),s.y=Math.floor((e.y-e.height/2)*t.radio),s.width=e.width,s.height=e.height,s.alpha=0,mouse.setButtonMode(s,!0),s.addEventListener(egret.TouchEvent.TOUCH_TAP,function(r){t.waiting||(Effect.play(AUDIO.UI_QTE_NormalPress_ogg),t.waiting=!0,Player.listener({id:o,channel:"choice",idx:n,events:i[e.nodeid]}).then(function(e){t.result=e,t.animate(o)}),r.stopPropagation(),r.stopImmediatePropagation())},t),t.buttons.push(s),t.addChild(s),egret.Tween.get(s).to({alpha:1},300)})}},e.prototype.animate=function(t){var e=this;if(!this.exit){var i=this.buttons.splice(t,1)[0];this.buttons.forEach(function(t){egret.Tween.get(t).to({alpha:0},200)}),egret.Tween.get(i).to({scaleX:1.2,scaleY:1.2},200).call(function(){e.result&&8!==Player.status()&&Player.play(),e.result&&e.removeChild(i),e.result&&e.complete()},this)}},e.prototype.complete=function(){t.prototype.complete.call(this)},e}(e);t.ImageChoice=o,__reflect(o.prototype,"Component.ImageChoice");var r=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.countDown()},e.prototype.countDown=function(){var t=this,e=this.data.info,i=e.default_button;e.limit_time+=2,this.timer=new egret.Timer(1e3,e.limit_time),this.timer.addEventListener(egret.TimerEvent.TIMER,function(){t.timeout.visible&&Effect.play(AUDIO.Timer_Display_ogg),t.timeout.text=String(e.limit_time-t.timer.currentCount)},this),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){Toast.show("超出选择时间"),t.choose(i)},this),this.addCount(e.limit_time),this.timer.start()},e.prototype.addCount=function(t){var e=this,i=this.data.info,n=[];i.buttons.forEach(function(t){!t.is_hidden&&n.push(t)});n.length;this.group=new eui.Group,this.group.width=110,this.group.height=110,this.group.horizontalCenter=0,this.group.y=808;var o=new eui.Image("daojishi_png");o.x=3,o.y=3,o.visible=!1;var r=Movie.getMC("daojishi_xulie");r.play(-1),r.width=110,r.height=110,r.visible=!1,this.timeout=new eui.Label,this.timeout.textColor=16777215,this.timeout.text=String(t),this.timeout.size=40,this.timeout.fontFamily="Microsoft Yahei",this.timeout.horizontalCenter=0,this.timeout.verticalCenter=0,this.timeout.visible=!1,setTimeout(function(){o.visible=!0,r.visible=!0,e.timeout.visible=!0},2e3),this.group.addChild(o),this.group.addChild(r),this.group.addChild(this.timeout),this.addChild(this.group)},e.prototype.choose=function(e){return this.timer&&this.timer.running&&this.timer.reset(),t.prototype.choose.call(this,e)},e.prototype.animate=function(e){this.exit||(t.prototype.animate.call(this,e),egret.Tween.get(this.group).to({alpha:0},500))},e.prototype.complete=function(){this.timer.running&&this.timer.reset(),this.timer=null,this.removeChild(this.group),t.prototype.complete.call(this)},e}(e);t.TimeChoice=r,__reflect(r.prototype,"Component.TimeChoice");var s=function(e){function i(t){var i=e.call(this)||this;return i.skinName="ConfirmButtonSkin",i.data=t,i.data.confirmMsg&&(i.btnComplete.label=i.data.confirmMsg),i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btnComplete.addEventListener(egret.TouchEvent.TOUCH_TAP,this.complete,this),t.buttonMousemove(this.btnComplete)},i.prototype.complete=function(){if(this.data.confirmMsg){var t=STORY.nodeid;if(t&&!STORY.checkAwardNode(t)){var e=STORY.AwardVideoNode;e.push(t),STORY.AwardVideoNode=e}}if(Effect.play(AUDIO.NormalButton_Press_ogg),"全剧终"===this.data.confirmMsg){var e=STORY.AwardVideoNode;-1===e.indexOf("5eb5ccb3864f444fa88080ffcad017ca")&&e.push("5eb5ccb3864f444fa88080ffcad017ca"),STORY.AwardVideoNode=e,Player.save(PlayerFlag.PS_Finish).then(function(t){Player.clearButton(),Scenes.get("Skin.VideoView").keyboard=!0,Scenes.addUI("Skin.StartView").then(function(){var t=Net.ws();t.send("getsettlereward",{chapter_id_list:[STORY.chapterid]}).then(function(t){if(t.data.settle_reward_info_map&&t.data.settle_reward_info_map[STORY.chapterid]){var e=t.data.settle_reward_info_map[STORY.chapterid];if(e.reward_list.length>0&&1==e.reward_list[0].status&&1==e.reward_list[0].type){var i=Net.ws();i.send("recvsettlereward",{chapter_id:STORY.chapterid,reward_id:e.reward_list[0].reward_id}).then(function(t){return 0!==t.ret?!1:void(MALL.coin=t.data.cur_money.coins)})}}})}),Player.exit()})}else Player.completeChapter(this.data),Player.clearButton()},i}(eui.Component);t.ConfirmButton=s,__reflect(s.prototype,"Component.ConfirmButton",["eui.UIComponent","egret.DisplayObject"]);var a=function(e){function i(t,i){var n=e.call(this)||this;return n.exit=!1,n.data=t,n.radio=i,n.init(),n}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},i.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,t.QTEinit({info:this.data.qte,events:this.data.events,callback:this.callback.bind(this)},this.radio)];case 1:return e=i.sent(),this.addChild(e),this.data.info.limit_time>0&&this.countDown(),[2]}})})},i.prototype.callback=function(t){if(!this.waiting){this.waiting=!0;var e=t?0:1,i=this.data.events,n=this.data.idx;Player.listener({id:e,channel:"choice",idx:n,events:i[t?"succ":"fail"]}).then(function(){!Player.playing()&&Player.play()}),this.complete()}},i.prototype.countDown=function(){var t=this,e=this.data.info;e.default_button;e.limit_time+=2,this.timer=new egret.Timer(1e3,e.limit_time),this.timer.addEventListener(egret.TimerEvent.TIMER,function(){t.timeout.visible&&Effect.play(AUDIO.Timer_Display_ogg),t.timeout.text=String(e.limit_time-t.timer.currentCount)},this),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){Toast.show("超出选择时间"),t.callback(!1)},this),this.addCount(e.limit_time),this.timer.start()},i.prototype.addCount=function(t){var e=this,i=this.data.info,n=[];i.buttons.forEach(function(t){!t.is_hidden&&n.push(t)});n.length;this.group=new eui.Group,this.group.width=110,this.group.height=110,this.group.top=96,this.group.right=97;var o=new eui.Image("daojishi_png");o.x=3,o.y=3,o.visible=!1;var r=Movie.getMC("daojishi_xulie");r.play(-1),r.width=110,r.height=110,r.visible=!1,this.timeout=new eui.Label,this.timeout.textColor=16777215,this.timeout.text=String(t),this.timeout.size=40,this.timeout.fontFamily="Microsoft Yahei",this.timeout.horizontalCenter=0,this.timeout.verticalCenter=0,this.timeout.visible=!1,setTimeout(function(){o.visible=!0,r.visible=!0,e.timeout.visible=!0},2e3),this.group.addChild(o),this.group.addChild(r),this.group.addChild(this.timeout),this.addChild(this.group)},i.prototype.complete=function(){!this.exit&&this.parent&&(this.timer.running&&this.timer.reset(),this.timer=null,this.removeChild(this.group),Player.clearButton(),this.exit=!1,this.waiting=!1)},i}(eui.Component);t.QTEChoice=a,__reflect(a.prototype,"Component.QTEChoice")}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="DefnChangeButtonSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.selected||(e.currentState="down")},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.selected||(e.currentState="up")},this)},e}(eui.ToggleButton);t.DefnChange=e,__reflect(e.prototype,"Component.DefnChange");var i=function(t){function e(){var e=t.call(this)||this;return e.skinName="DefnVideoRateSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e}(eui.ToggleButton);t.DefnRate=i,__reflect(i.prototype,"Component.DefnRate",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="ExclamationSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.redTween.play(0)},e}(eui.Component);t.Exclamation=e,__reflect(e.prototype,"Component.Exclamation",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(e){function i(t){var i=e.call(this)||this;return i.skinName="HiddenStoryItemSkin",i.info=t,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btnPlay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPlay,this),this.btnPause.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPause,this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),t.buttonMousemove(this.btnReturn),this.update()
},i.prototype.update=function(){this.btnReturn.label=this.info.name,this.url=this.info.video||"http://www.npcstudio.cn/videos/trailer/v1.mp4",this.play()},i.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),this.reset()},i.prototype.play=function(){var t=this;return new Promise(function(e){function i(){Loading.hide(),n.video.removeEventListener("loadeddata",i),n.btnPlay.visible=!1,n.btnPause.visible=!0,n.render=new egret.iVideo(n.video),n.render.width=n.gVideo.width,n.render.height=n.gVideo.height,n.gVideo.addChild(n.render),BGM.setVolume(0),n.video.play(),n.render.play(),o.running&&o.reset(),o=void 0,e(!0)}var n=t,o=new egret.Timer(5e3,1);t.render||(Loading.show(),t.video=document.createElement("video"),t.video.className="video",t.video.crossOrigin="anonymous",t.video.src=t.url,t.video.volume=USER.volume,document.body.appendChild(t.video)),o.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){t.video.removeEventListener("loadeddata",i),Toast.show("网络异常，视频加载视频失败，请重新尝试"),t.reset()},t),t.video.addEventListener("loadeddata",i),t.video.addEventListener("ended",t.reset.bind(t)),t.render?(t.btnPlay.visible=!1,t.btnPause.visible=!0,t.video.play(),t.render.play()):(t.video.load(),o.start()),t.waiting=!1})},i.prototype.onPlay=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.waiting?[2]:(this.waiting=!0,Effect.play(AUDIO.PlayButton_Press_ogg),this.playing=!0,[4,this.play()]);case 1:return t.sent(),[2]}})})},i.prototype.onPause=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return this.waiting?[2]:(this.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg),this.render&&this.render.pause(),setTimeout(function(){t.video&&t.video.pause(),t.waiting=!1},100),this.btnPlay.visible=!0,this.btnPause.visible=!1,[2])})})},i.prototype.reset=function(){this.btnPlay.visible=!0,this.btnPause.visible=!1,this.playing=!1,this.video&&(this.video.src=""),this.render&&this.gVideo.removeChild(this.render),this.video&&document.body.removeChild(this.video),this.render=null,this.video=null,Widget.closePop(),BGM.setVolume(USER.volume)},i}(eui.Component);t.HiddenStoryItem=e,__reflect(e.prototype,"Component.HiddenStoryItem",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="percentBarSkin",e.touchEnabled=!1,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.onChange(),Events.register("dataChange.STORY.globalExplore",this.onChange,this)},e.prototype.onChange=function(){var t=STORY.globalExplore;this.thumb.width=parseInt(t)/100*this.width},e}(eui.ProgressBar);t.PercentBar=e,__reflect(e.prototype,"Component.PercentBar",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=!1,i=function(t){function e(e){var i=t.call(this)||this;if(i.skinName="PopupDialogSkin",i.textTitle.text=e.title||"提示",i.textInfo.text=e.content,e.contentStyle){var n=e.contentStyle;for(var o in n)i.textInfo[o]=n[o]}return e.customInfo&&(i.customInfo=e.customInfo),i.callback=e.callback,e.button&&e.button.length>1?(i.btnSubmit.label=e.button[0],i.btnCancel.label=e.button[1]):1==e.button.length&&(i.btnSubmit.label=e.button[0],i.btnSubmit.x=0,i.btnCancel.visible=!1),i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;if(t.prototype.childrenCreated.call(this),Loading.isShow()&&Loading.hide(),Toast.inShow()&&Toast.hide(),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.CloseButton_Press_ogg),e.onClose()},this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.NormalButton_Press_ogg),e.onClose()},this),this.btnSubmit.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),t=this.callback,t?[4,this.callback(!0)]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return Widget.closePop(),[2]}})})},this),this.customInfo){var i=new eui.Label;if(this.customInfo.style)for(var n in this.customInfo.style)i[n]=this.customInfo.style[n];this.customInfo.textFlow&&(i.textFlow=[this.customInfo.textFlow]),this.customInfo.link&&i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return Utils.openPage(e.customInfo.link)},this),this.gPopup.addChild(i)}},e.prototype.onClose=function(){Widget.closePop(),this.callback&&this.callback(!1)},e}(eui.Component);t.PopupDialog=i,__reflect(i.prototype,"Component.PopupDialog",["eui.UIComponent","egret.DisplayObject"]);var n=function(t){function e(e){var i=t.call(this)||this;return i.skinName="PopupUnlockSkin",i.id=e,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.CloseButton_Press_ogg),e.onClose()},this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.NormalButton_Press_ogg),e.onClose()},this),this.init()},e.prototype.init=function(){var t=Math.ceil(Time.remain(Time.unlockend)/MALL.coins2Time);if(MALL.coin>t||!NOVICE[3])this.textTitle.text="加速解锁",this.textUnlock.text=t+"加速解锁，是否继续？",this.btnDash.label=t+"加速",this.btnDash.visible=NOVICE[3]?!0:!1,this.btnFree.visible=NOVICE[3]?!1:!0,NOVICE[3]?this.freeTween.stop():this.freeTween.play(0),this.gUnlock.visible=!0,this.type=1;else{var e=MALL.coin*MALL.coins2Time;this.textTitle.text="金币不足",this.textPrice.text=t+"加速解锁",this.textTime.text=MALL.coin+"，可加速"+Time.format(e)+"，是否继续？",this.btnDash.label=MALL.coin+"加速",this.btnFree.visible=!1,this.freeTween.stop(),this.gDash.visible=!0,this.type=2}this.btnDash.enabled=MALL.coin>0?!0:!1,this.btnFree.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onDash,this),this.btnDash.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onDash,this)},e.prototype.onClose=function(){Widget.closePop()},e.prototype.onDash=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o;return __generator(this,function(r){switch(r.label){case 0:return Effect.play(AUDIO.PaymentButton_Press_ogg),t=Net.ws(),[4,t.send("unlockcharpter",{chapter_id:this.id,order_id:STORY.chapterInfo(this.id).index})];case 1:return e=r.sent(),-1001==e.code||-1e3==e.code?Toast.show("网络异常，无法加速，请重新尝试"):(i=e.data,Time.setDiff(Time.now()-i.time_now),Time.setUnlockend(this.id,i.unlock_time),MALL.coin=i.now_money.coins,n=STORY.chapterInfo(i.chapter_id).ChapterLabel.split("·"),o=i.cost_money.coins*MALL.coins2Time,i.timenow<i.unlocktime?Toast.show("等待时间减少"+Time.format(o)):Toast.show("解锁章节 "+n[1]),this.gPopup.visible=!1,setTimeout(this.onClose,2e3)),[2]}})})},e}(eui.Component);t.PopupUnlock=n,__reflect(n.prototype,"Component.PopupUnlock",["eui.UIComponent","egret.DisplayObject"]);var o=function(e){function i(t){var i=e.call(this)||this;return i.skinName="PopupReviveSkin",i.id=t,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){var i=this;e.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.CloseButton_Press_ogg),i.onClose()},this),this.btnCancel.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.NormalButton_Press_ogg),i.onClose()},this),this.btnRevive.addEventListener(egret.TouchEvent.TOUCH_TAP,this.revive,this),this.btnFree.addEventListener(egret.TouchEvent.TOUCH_TAP,this.revive,this),t.buttonMousemove(this.btnCancel),t.buttonMousemove(this.btnRevive),t.buttonMousemove(this.btnFree),this.init()},i.prototype.init=function(){this.textPrice.text=MALL.reliveCost+"让",this.textBtnPrice.text=MALL.reliveCost.toString(),NOVICE[2]?(this.btnRevive.visible=!0,this.gFree.visible=!1,this.freeTween.stop()):(this.btnRevive.visible=!1,this.gFree.visible=!0,this.freeTween.play(0)),this.btnRevive.enabled=MALL.coin<MALL.reliveCost?!1:!0},i.prototype.revive=function(){var t=this;if(MALL.coin>=MALL.reliveCost||!NOVICE[2]){if(this.waiting)return;Effect.play(AUDIO.PaymentButton_Press_ogg),this.waiting=!0,Player.listener({channel:"revive",orderid:this.id}).then(function(e){t.waiting=!1,e&&(Scenes.get("Skin.BadEndView").complete(),t.onClose())})}else Effect.play(AUDIO.UI_Warn_ogg),Toast.show("金币不足，请回到故事线")},i.prototype.onClose=function(){Widget.closePop()},i.prototype.onDash=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o;return __generator(this,function(r){switch(r.label){case 0:return t=Net.ws(),[4,t.send("unlockcharpter",{chapter_id:this.id,order_id:STORY.chapterInfo(this.id).index})];case 1:return e=r.sent(),-1001==e.code||-1e3==e.code?Toast.show("网络异常，无法加速，请重新尝试"):(i=e.data,Time.setDiff(Time.now()-i.time_now),Time.setUnlockend(this.id,i.unlock_time),MALL.coin=i.now_money.coins,n=STORY.chapterInfo(i.chapter_id).ChapterLabel.split("·"),o=i.cost_money.coins*MALL.coins2Time,i.timenow<i.unlocktime?Toast.show("等待时间减少"+Time.format(o)):Toast.show("解锁章节 "+n[1]),this.gPopup.visible=!1,setTimeout(this.onClose,2e3)),[2]}})})},i}(eui.Component);t.PopupRevive=o,__reflect(o.prototype,"Component.PopupRevive",["eui.UIComponent","egret.DisplayObject"]);var r=function(t){function e(e){var i=t.call(this)||this;return i.skinName="PopupShareSkin",i.info=e,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),this.init(),this.info.type==SHARE_TYPE.goodend||this.info.type==SHARE_TYPE.badend?setTimeout(function(){e.layMask.alpha=0,e.gPopup.alpha=0,e.layMask.visible=!0,e.gPopup.visible=!0,egret.Tween.get(e.layMask).to({alpha:1},350),egret.Tween.get(e.gPopup).to({alpha:1},350)},2e3):(this.layMask.visible=!0,this.gPopup.visible=!0)},e.prototype.init=function(){var t=this,e=SHARE.localdata,i=new Object,n="https://www.npcstudio.cn/images/note/";if(this.info.type==SHARE_TYPE.goodend){var o=STORY.chapterInfo(this.info.id).index+1;e.config.some(function(n){return n.share_type==t.info.type&&n.share_param==o?(i.title=n.title,i.content=n.desc,i.icon=n.icon_name,i.url=e.url[n.h5_url_idx].url,i.bigpic=n.pic_name,i.type=t.info.type,i.showtype=t.info.showtype,!0):void 0})}else if(this.info.type==SHARE_TYPE.badend){var r=[];e.config.map(function(i){i.share_type==t.info.type&&r.push({title:i.title,content:i.desc,icon:i.icon_name,url:e.url[i.h5_url_idx].url,bigpic:i.pic_name,type:t.info.type,showtype:t.info.showtype})});var s=Math.floor(Math.random()*r.length);i=r[s]}else(this.info.type==SHARE_TYPE.videoshot||this.info.type==SHARE_TYPE.achieve)&&e.config.some(function(n){return n.share_type==t.info.type&&n.share_param==t.info.id?(i.title=n.title,i.content=n.desc,i.icon=n.icon_name,i.url=e.url[n.h5_url_idx].url,i.type=t.info.type,t.info.type==SHARE_TYPE.achieve?i.bigpic=n.pic_name:t.info.type==SHARE_TYPE.videoshot&&(i.texture=t.info.texture),!0):void 0});this.shareInfo=i,this.info.type==SHARE_TYPE.videoshot?this.imgShare.texture=this.info.texture:this.imgShare.source=this.info.image?n+this.info.image:Share.imagePath+this.shareInfo.bigpic},e.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),this.info.type==SHARE_TYPE.videoshot&&this.info.isplay&&Player.play(),Widget.closePop()},e.prototype.share=function(){Logger.log("share"),Effect.play(AUDIO.NormalButton_Press_ogg),this.info.type==SHARE_TYPE.videoshot?Share.local(this.info.texture,1):Share.sns(this.shareInfo)},e.prototype.local=function(){var t=this;Logger.log("local"),Share.sharetype=this.info.type,this.info.type==SHARE_TYPE.videoshot?Share.local(this.info.texture,0,this.shareInfo.bigpic):RES.getResByUrl(Share.imagePath+this.shareInfo.bigpic,function(e){Share.local(e,0,t.shareInfo.bigpic)},this,RES.ResourceItem.TYPE_IMAGE)},e}(eui.Component);t.PopupShare=r,__reflect(r.prototype,"Component.PopupShare",["eui.UIComponent","egret.DisplayObject"]);var s=function(t){function e(e){var i=t.call(this)||this;return i.skinName="PopupNoticeSkin",i.title=e.title,i.content=e.content,i.callback=e.callback,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.init(),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this)},e.prototype.init=function(){this.textTitle.text=this.title,this.textContent.text="\n"+this.content},e.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Widget.closePop(),this.callback()},e}(eui.Component);t.PopupNotice=s,__reflect(s.prototype,"Component.PopupNotice",["eui.UIComponent","egret.DisplayObject"]);var a=function(e){function i(t){var i=e.call(this)||this;return i.amount=[1,10,30],i.skinName="PopupGiftSkin",i.info=t,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.init(),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this)},i.prototype.init=function(){var e=this;this.currentState=this.info.type,this.textName.text=" "+this.info.name+" ";var i="flower"==this.info.type?this.gFlower:this.gEgg,n=i.$children;n.map(function(i,n){i.label=e.amount[n],i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){return e.onGift(e.amount[n])},e),t.buttonMousemove(i)}),this.order=Date.now()},i.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Widget.closePop()},i.prototype.onGift=function(t,e,i){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s,a,c=this;return __generator(this,function(h){return i=e?e:this.info.type,"flower"==i?Effect.play(AUDIO.RewardPopUp_Display_ogg):Effect.play(AUDIO.Set_Press_ogg),this.waiting?[2]:(this.waiting=!0,MALL[i]<t?(n="flower"==i?"鲜花":"鸡蛋",Widget.pop("PopupDialog",{title:"提示",content:n+"数量不足，是否前往购买？",button:["确认","取消"],callback:function(t){return __awaiter(c,void 0,void 0,function(){return __generator(this,function(e){return t&&setTimeout(function(){Widget.pop("PopupBuy",{type:"flower"===i?2:1})},100),this.waiting=!1,[2]})})}})):(o="Skin.RankView"==Scenes.currentUI?1:0,r="flower"==i?{actor_id:this.info.id,flower_count:t,order_id:this.order}:{actor_id:this.info.id,egg_count:t,order_id:this.order},s="flower"==i?"送花":"砸蛋",a=Net.ws(),a.send("doCall",r).then(function(e){if(0===e.ret&&(Toast.show(s+"成功"),c.order=Date.now(),c.info.target&&(c.info.target.text=parseInt(c.info.target.text)+t),c.info.charalist||999==c.info.id)){var n=Scenes.get("Skin.RankView");n.charaRefresh(i,c.info.id,t)}c.waiting=!1})),[2])})})},i}(eui.Component);t.PopupGift=a,__reflect(a.prototype,"Component.PopupGift",["eui.UIComponent","egret.DisplayObject"]);var c=function(e){function i(t){var i=e.call(this)||this;return i.skinName="PopupBuySkin",i.info=t,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),this.init()},i.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var e,i,n,o=this;return __generator(this,function(r){switch(r.label){case 0:return this.currentState=this.info.type,SHOP[this.info.type]?[3,2]:[4,this.getJSON()];case 1:e=r.sent(),i=[],e.map(function(t){if(t.item_list[0].type==o.info.type){var e={id:t.id,price:t.item_list[0].price,count:t.item_list[0].count,type:t.item_list[0].type,gift_count:t.gift_count};i.push(e)}}),i.sort(function(t,e){return t.id-e.id}),SHOP[this.info.type]=i,r.label=2;case 2:return n=new eui.ArrayCollection(SHOP[this.info.type]),this.listShop.dataProvider=n,this.listShop.itemRenderer=t.PopupBuyItem,this.listShop.dataProviderRefreshed(),[2]}})})},i.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Widget.closePop()},i.prototype.getJSON=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/shopData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})},i}(eui.Component);t.PopupBuy=c,__reflect(c.prototype,"Component.PopupBuy",["eui.UIComponent","egret.DisplayObject"]);var h=function(i){function n(){var t=i.call(this)||this;return t.skinName="PopupBuyItemSkin",t}return __extends(n,i),n.prototype.partAdded=function(t,e){i.prototype.partAdded.call(this,t,e)},n.prototype.childrenCreated=function(){i.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBuy,this),t.buttonMousemove(this)},n.prototype.dataChanged=function(){switch(this.textGift.visible=this.data.gift_count?!0:!1,this.textGift.text="赠 "+this.data.gift_count+(1==this.data.type?" 鸡蛋":" 鲜花"),this.textCount.text=this.data.count+(1==this.data.type?"个鸡蛋":"朵鲜花"),this.textPrice.text="￥"+this.data.price/100,console.log(this.data.count+","+this.itemIndex),this.data.type){case 1:this.imgItem.source="goumai_tongyongtanchuang_jidan_0"+(this.itemIndex+1)+"_png";break;case 2:this.imgItem.source="goumai_tongyongtanchuang_meigui_0"+(this.itemIndex+1)+"_png"}},n.prototype.onBuy=function(){return __awaiter(this,void 0,void 0,function(){var t,i,n;return __generator(this,function(o){switch(o.label){case 0:return Effect.play(AUDIO.PaymentButton_Press_ogg),e?[2]:(e=!0,t=Net.ws(),[4,Steam.micropay({shop_id:this.data.id,item_list:[{item_type:this.data.type,count:this.data.count,price:this.data.price}]})]);case 1:return i=o.sent(),0===i.ret?(n=this.data.gift_count?this.data.gift_count+this.data.count:this.data.count,Toast.show("购买成功 @"+(1==this.data.type?"鸡蛋":"鲜花")+" +"+n)):i.msg&&Toast.show(i.msg),e=!1,[2]}})})},n}(eui.ItemRenderer);t.PopupBuyItem=h,__reflect(h.prototype,"Component.PopupBuyItem",["eui.UIComponent","egret.DisplayObject"]);var u=function(e){function i(t){var i=e.call(this)||this;return i.skinName="PopupPictureSkin",i.info=t,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),this.btnSave.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSave,this),t.buttonMousemove(this.btnClose),t.buttonMousemove(this.btnSave),this.init()},i.prototype.init=function(){this.gPopup.width="Skin.RankView"==Scenes.currentUI?670:1358,this.gPopup.height="Skin.RankView"==Scenes.currentUI?976:772,this.infoPath="Skin.RankView"==Scenes.currentUI?"https://www.npcstudio.cn/images/rank/":"https://www.npcstudio.cn/images/note/",this.info.end&&(this.infoPath=""),this.imgShare.source=this.infoPath+this.info.image},i.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),this.info.type==SHARE_TYPE.videoshot&&this.info.isplay&&Player.play(),Widget.closePop()},i.prototype.onSave=function(){Logger.log("save"),Effect.play(AUDIO.NormalButton_Press_ogg),Steam.saveFile(this.infoPath+this.info.image).then(function(t){t?Toast.show("图片已保存至桌面"):Toast.show("保存失败，请重新尝试")})},i}(eui.Component);t.PopupPicture=u,__reflect(u.prototype,"Component.PopupPicture",["eui.UIComponent","egret.DisplayObject"]);var d=function(e){function i(t){var i=e.call(this)||this;return i.skinName="PopupHelpSkin",i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),NOVICE[NOVICE_TYPE.story]||this.noviceTween.play(0),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),t.buttonMousemove(this.btnClose)},i.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Widget.closePop()},i}(eui.Component);t.PopupHelp=d,__reflect(d.prototype,"Component.PopupHelp",["eui.UIComponent","egret.DisplayObject"]);var l=function(e){function i(t){var i=e.call(this)||this;return i.skinName="PopupGetItemSkin",i.info=t,i.width=1920,i.height=1080,i.horizontalCenter=0,i}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),t.buttonMousemove(this.btnSubmit),this.btnSubmit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSubmit,this),this.init()},i.prototype.init=function(){var t="",e=this.info.list;for(var i in e){var n="1"==i?"鸡蛋":"鲜花";t+=n+" X "+[e[i]]+" "}this.textItem.text=t},i.prototype.onSubmit=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i=this;return __generator(this,function(n){switch(n.label){case 0:return this.waiting?[2]:(this.waiting=!0,t=Net.ws(),[4,t.send("confirmOrder").then(function(t){if(i.waiting=!1,0===t.ret){UNGET=void 0,Widget.closePop();var e=i.textItem.text.replace("鸡蛋","@鸡蛋");e=e.replace("鲜花","@鲜花"),Toast.show("购买成功 "+e)}})]);case 1:return e=n.sent(),[2]}})})},i}(eui.Component);t.PopupGetItem=l,__reflect(l.prototype,"Component.PopupGetItem",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="PromptSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.x=0,this.y=130},e.prototype.show=function(t,e){var i=this;if(!this.promptStatus){this.promptStatus=!0;var n,o;switch(t){case 1:n=Movie.getDB("awardin"),o=Movie.getDB("awardout"),this.textPromptTitle.text="获得新奖励";break;case 2:n=Movie.getDB("achievein"),o=Movie.getDB("achieveout"),this.textPromptTitle.text="解锁成就"}n.touchEnabled=!1,o.touchEnabled=!1,this.textPrompt.text=e,this.gPromptText.width=0,this.gPromptAni.addChild(n),n.animation.play(),egret.Tween.get(this.gPromptText).wait(700).to({width:400},400).wait(3e3).to({width:0},200);var r=function(){n.removeEventListener(dragonBones.EventObject.COMPLETE,r,i),setTimeout(function(){n.animation.reset(),i.gPromptAni.removeChildren(),i.gPromptAni.addChild(o),o.animation.play()},3e3)},s=function(){o.removeEventListener(dragonBones.EventObject.COMPLETE,s,i),o.animation.reset(),i.gPromptAni.removeChildren(),i.visible=!1,setTimeout(function(){i.promptStatus=!1,Prompt.show()},500)};n.addEventListener(dragonBones.EventObject.COMPLETE,r,this),o.addEventListener(dragonBones.EventObject.COMPLETE,s,this),this.visible=!0}},e}(eui.Component);t.PromptComponet=e,__reflect(e.prototype,"Component.PromptComponet",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){function e(t,e,i,n){return 180*Math.atan2(n-e,i-t)/Math.PI}function i(t,e){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return[4,STORY.blockInfo(t)];case 1:return i=n.sent(),i&&i.qte&&i.qte.nodeid===e?[2,i.qte]:[2,null]}})})}function n(t,e){return __awaiter(this,void 0,void 0,function(){var i,n,h;return __generator(this,function(u){switch(e&&(o=e),i=t.info,n=t.events,h=t.callback,i.type){case 0:return"奖励视频"===i.tap.content||"点击继续"===i.tap.content?[2,new s(i.tap,n,h)]:[2,new r(i.tap,n,h)];case 1:return[2,new a(i.press,n,h)];case 2:return[2,new c(i.slide,n,h)]}return[2]})})}var o=1;t.QTECheck=i,t.QTEinit=n;var r=function(t){function e(e,i,n){var r=t.call(this)||this;if(r.data=e,r.callback=n,e.image)switch(e.image){case"knock.png":r.skinName="QTEknockSkin";break;case"hand.png":r.skinName="QTEhandSkin";break;case"bullet.png":r.skinName="QTEhandSkin",r.image.source="QTE_zidang_icon_png";break;default:r.skinName="QTEhandSkin"}return r.events=i,r.offset=o,r.touchEnabled=!1,r}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.init()},e.prototype.init=function(){var t=this;if(this.skinName)switch(this.skinName){case"QTEknockSkin":this.knockTween.play(0),this.trigger.x=Math.floor((this.data.button_pos.x-40)*this.offset),this.trigger.y=Math.floor((this.data.button_pos.y-40)*this.offset),this.attchEvents();break;case"QTEhandSkin":this.handtipsTween.play(0),this.trigger.x=Math.floor((this.data.button_pos.x-40)*this.offset),this.trigger.y=Math.floor((this.data.button_pos.y-40)*this.offset),this.attchEvents();break;case"QTEpressSkin":this.presstipsTween.play(0),this.trigger.x=Math.floor((this.data.button_pos.x-40)*this.offset),this.trigger.y=Math.floor((this.data.button_pos.y-40)*this.offset)}this.trigger.touchEnabled=!0,mouse.setButtonMode(this.trigger,!0),this.label=new eui.Label(this.data.content),this.label.rotation=this.data.content_angle,this.label.fontFamily="Microsoft Yahei",this.label.x=Math.floor((this.data.content_pos.x-this.label.width/2)*this.offset),this.label.y=Math.floor((this.data.content_pos.y-this.label.height/2)*this.offset),this.label.alpha=0,this.line=new eui.Image("QTE_zhishi_png"),this.line.width=0,this.line.height=2,this.line.scale9Grid=new egret.Rectangle(0,0,96,2);var e;this.label.x<this.width/2?(this.line.left=0,e=this.label.x-10):(this.line.right=0,this.line.skewY=180,e=this.width-this.label.x-this.label.width-10),this.line.y=this.label.y+this.label.height/2,this.addChild(this.label),this.addChild(this.line),egret.Tween.get(this.line).to({width:e},1e3).call(function(){egret.Tween.get(t.label).to({alpha:1},1333)}),this.created=!0},e.prototype.attchEvents=function(){this.trigger.addEventListener(egret.TouchEvent.TOUCH_TAP,this.listener,this)},e.prototype.remove=function(t){void 0===t&&(t=!1),t&&Player.listener({channel:"qte",events:this.events.succ}),Player.clearButton(),this.created=!1},e.prototype.listener=function(t){var e=this;if(Effect.play(AUDIO.UI_QTE_NormalPress_ogg),this.trigger.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.listener,this),this.label&&this.label.parent&&this.label.parent.removeChild(this.label),this.line&&this.line.parent&&this.line.parent.removeChild(this.line),this.skinName)switch(this.skinName){case"QTEknockSkin":this.removeChild(this.trigger),this.remove(!0);break;case"QTEhandSkin":this.handtipsTween.stop(),this.handclickTween.play(0),egret.Tween.get(this.trigger).to({alpha:0},500).call(function(){e.removeChild(e.trigger),e.remove(!0)});break;case"QTEpressSkin":this.removeChild(this.trigger),this.remove(!0)}this.data.shake&&Vibrator.start()},e}(eui.Component);__reflect(r.prototype,"QTEclick",["eui.UIComponent","egret.DisplayObject"]);var s=function(e){function i(t,i,n){var o=e.call(this)||this;return o.skinName="ConfirmButtonSkin",o.data=t,o.events=i,o.btnComplete.label=o.data.content,o.attchEvents(),o}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},i.prototype.attchEvents=function(){this.btnComplete.addEventListener(egret.TouchEvent.TOUCH_TAP,this.remove,this),t.buttonMousemove(this.btnComplete)},i.prototype.remove=function(t){void 0===t&&(t=!1),t&&Player.listener({channel:"qte",events:this.events.succ}),Player.clearButton(),this.created=!1},i.prototype.complete=function(){Effect.play(AUDIO.NormalButton_Press_ogg),Player.completeChapter(this.data).then(function(t){t&&Player.clearButton()})},i}(eui.Component);__reflect(s.prototype,"QTEContinue",["eui.UIComponent","egret.DisplayObject"]);var a=function(t){function e(e,i,n){var o=t.call(this,e,i)||this;return o.completeTime=1e3*parseInt(e.press_duration),o.skinName="QTEpressSkin",o.timer=new egret.Timer(100,0),o.touchEnabled=!1,o}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),t.prototype.init.call(this),this.attachEvent()},e.prototype.attachEvent=function(){var t=this;this.timer.addEventListener(egret.TimerEvent.TIMER,function(){var e=100*t.timer.currentCount;e>=t.completeTime?(t.rate=1,t.drawAnimate(),t.timer.stop(),t.check()):(t.rate=e/t.completeTime,t.drawAnimate())},this),this.trigger.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.press,this),this.trigger.addEventListener(egret.TouchEvent.TOUCH_END,this.check,this),this.trigger.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.check,this)},e.prototype.drawAnimate=function(){this.progress.width=Math.floor(340*this.rate)},e.prototype.clearAnitmate=function(){egret.Tween.get(this.progress).to({width:0},200)},e.prototype.press=function(t){this.sound=Effect.play(AUDIO.LongPressButton_Hold_ogg,!0),this.presstipsTween.stop(),this.pressclickTween.play(0),this.startX=t.stageX,this.startY=t.stageY,this.timer.reset(),this.timer.start()},e.prototype.check=function(){1!==this.rate||this.status?(this.rate=0,this.pressclickTween.play(0),this.pressclickTween.stop(),this.presstipsTween.play(0),this.clearAnitmate(),this.timer.reset(),this.timer.stop()):(this.trigger.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.press,this),this.trigger.removeEventListener(egret.TouchEvent.TOUCH_END,this.check,this),this.trigger.removeEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.check,this),this.progress.width=340,this.status=!0,this.presstipsTween.stop(),this.listener()),this.sound&&this.sound.stop()},e}(r);__reflect(a.prototype,"QTEpress");var c=function(i){function n(t,e,n){var r=i.call(this)||this;return r.status=!1,r.data=t,r.events=e,r.skinName="QTEsliderSkin",r.gAni.y="arrow_zhi.png"==t.arrow_image?58:28,r.touchEnabled=!1,r.created=!0,r.timer=new egret.Timer(100,0),r.offset=o,r.callback=n,r}return __extends(n,i),n.prototype.partAdded=function(t,e){i.prototype.partAdded.call(this,t,e)},n.prototype.childrenCreated=function(){i.prototype.childrenCreated.call(this),this.init(),this.attachEvent()},n.prototype.init=function(){var t=this;this.posStartX=this.data.button_pos.x-40,this.posStartY=this.data.button_pos.y-40,this.posEndX=this.data.target_button_pos.x-40,this.posEndY=this.data.target_button_pos.y-40,this.label.alpha=0,this.label.text=this.data.content,this.label.x=Math.floor(this.data.content_pos.x-this.label.width/2)*this.offset,this.label.y=Math.floor(this.data.content_pos.y-this.label.height/2)*this.offset;var i=new eui.Image("QTE_zhishi_png");i.width=0,i.height=2,i.scale9Grid=new egret.Rectangle(0,0,96,2);var n;this.label.x<this.width/2?(i.left=0,n=this.label.x-10):(i.right=0,i.skewY=180,n=this.width-this.label.x-this.label.width-10),i.y=this.label.y+this.label.height/2,this.addChild(i),egret.Tween.get(i).to({width:n},1e3).call(function(){egret.Tween.get(t.label).to({alpha:1},1333)});var r="arrow_zhi.png"==this.data.arrow_image?Movie.getDB("QTE_jiantou_zhi_dian"):Movie.getDB("QTE_jiantou_zhi_dian_1");r.x=0,r.y=0,r.touchEnabled=!1,this.gArrow.addChild(r),r.animation.play(void 0,0),this.offset=o,this.angle=e(this.posStartX,this.posStartY,this.posEndX,this.posEndY),this.arrow.x=Math.floor(this.posStartX*this.offset),this.arrow.y=Math.floor(this.posStartY*this.offset),this.arrow.rotation=this.angle,mouse.setButtonMode(this.arrow,!0),this.locus=new egret.Shape,this.stage.addChild(this.locus),NOVICE[NOVICE_TYPE.qteslider]||this.addNovice()},n.prototype.attachEvent=function(){this.arrow.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.start,this),this.arrow.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.move,this),this.arrow.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.check,this),this.arrow.addEventListener(egret.TouchEvent.TOUCH_END,this.check,this)
},n.prototype.start=function(t){this.image.alpha=1,Effect.play(AUDIO.UI_QTE_Slide_ogg),t.localX<200&&(this.timer.reset(),this.timer.start(),this.locus.graphics.lineStyle(10,16777215),this.locus.graphics.moveTo(t.stageX,t.stageY),this.draw=!0)},n.prototype.move=function(t){this.draw&&(this.locus.graphics.lineTo(t.stageX,t.stageY),this.lastX=t.localX,this.lastY=t.localY)},n.prototype.check=function(t){this.draw&&this.lastX&&(this.lastX<this.arrow.width-150||this.lastX>this.arrow.width||this.lastY<0||this.lastY>this.arrow.height?(Toast.show("操作失败，请沿箭头方向按鼠标左键快速划线。"),Effect.play(AUDIO.UI_Warn_ogg)):this.timer.currentCount>10?(Toast.show("请在1秒内完成互动操作"),Effect.play(AUDIO.UI_Warn_ogg)):this.status||(this.status=!0,this.listener())),this.locus.graphics.endFill(),this.locus.graphics.clear(),this.draw=!1,this.lastX=void 0,this.lastY=void 0,this.timer.reset(),this.timer.stop()},n.prototype.addNovice=function(){if(!NOVICE[NOVICE_TYPE.qteslider]){this.noviceGroup=new eui.Group,this.noviceGroup.horizontalCenter=0,this.noviceGroup.touchEnabled=!1;var e=new t.Exclamation;e.x=0,e.y=34;var i=new eui.Label("使用鼠标左键沿箭头方向划动");i.x=69,i.y=52,i.textColor=16777215,i.size=22,i.fontFamily="Microsoft Yahei";var n=Movie.getMC("liuguang");n.play(-1),n.width=509,n.height=90,n.x=756,n.y=18,this.noviceGroup.addChild(n),this.noviceGroup.addChild(e),this.noviceGroup.addChild(i),this.addChild(this.noviceGroup)}},n.prototype.listener=function(){this.data.shake&&Vibrator.start(),this.callback?this.callback(!0):Player.listener({channel:"qte",events:this.events.succ}),this.remove()},n.prototype.remove=function(){var t=this;this.image.visible=!1,this.created=!1;var e=Movie.getMC("dianji");e.gotoAndPlay(0),e.width=300,e.height=300,e.x=-150,e.y=-150,this.gAni.addChild(e);var i=function(){e.removeEventListener(egret.Event.COMPLETE,i,t),t.gAni.removeChild(e),t.gArrow.removeChildren(),Player.clearButton()};e.addEventListener(egret.Event.COMPLETE,i,this),NOVICE[NOVICE_TYPE.qteslider]||(Novice.set(NOVICE_TYPE.qteslider),this.removeChild(this.noviceGroup))},n}(eui.Component);__reflect(c.prototype,"QTEslide",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="RankListItemSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.dataChanged=function(){this.gRank.visible=this.data.rank?!0:!1,this.gDonate.width=this.data.donate?190:0,this.textValue.textAlign=this.data.donate?"left":"center"},e}(eui.ItemRenderer);t.RankListItem=e,__reflect(e.prototype,"Component.RankListItem",["eui.UIComponent","egret.DisplayObject"]);var i=function(e){function i(){var t=e.call(this)||this;return t.skinName="RankCharaItemSkin",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btnFlower.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onGift,this),this.btnEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onGift,this),this.imgAvatar.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onAvatar,this),t.buttonMousemove(this.btnFlower),t.buttonMousemove(this.btnEgg)},i.prototype.dataChanged=function(){this.currentState=this.data.type,this.imgAvatar.source=this.data.thumb?"https://www.npcstudio.cn/images/rank/"+this.data.thumb:"paihangbang_xianhuabang_touxiangxiangmuzu_png"},i.prototype.onGift=function(){Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("PopupGift",{id:this.data.id,name:this.data.name,type:this.data.type,target:this.textValue,charalist:!0,index:this.itemIndex})},i.prototype.onAvatar=function(){Widget.pop("PopupPicture",{image:this.data.image})},i}(eui.ItemRenderer);t.RankCharaItem=i,__reflect(i.prototype,"Component.RankCharaItem",["eui.UIComponent","egret.DisplayObject"]);var n=function(t){function e(){var e=t.call(this)||this;return e.skinName="RankUserItemSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.dataChanged=function(){this.gRank.visible=this.data.rank?!0:!1,this.imgRank.visible=!1,this.textRank.visible=!0,this.currentState=this.data.type},e}(eui.ItemRenderer);t.RankUserItem=n,__reflect(n.prototype,"Component.RankUserItem",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t.skinName="Record_PersonListItem",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){var i=this;e.prototype.childrenCreated.call(this),this.btnFlower.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("PopupGift",{id:i.data.id,name:i.data.name,type:"flower"})},this),this.btnEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("PopupGift",{id:i.data.id,name:i.data.name,type:"egg"})},this),t.buttonMousemove(this.btnFlower),t.buttonMousemove(this.btnEgg)},i.prototype.dataChanged=function(){var e=this;this.gContent.visible=this.data.unlock?!0:!1,this.gDonate.visible=this.data.unlock?!0:!1,this.btnFlower.visible=7==this.data.id?!1:!0,this.btnEgg.visible=5==this.data.id?!1:!0,this.imgPerson.visible=!1;var i=this.data.image?"https://www.npcstudio.cn/images/note/"+this.data.image:"dangan_renwu_01_png";if(this.data.unlock&&RES.getResByUrl(i,function(t){e.imgPerson.source=t,e.imgPerson.visible=!0},this,RES.ResourceItem.TYPE_IMAGE),this.data.unlock){this.gValue0.visible=!1,this.gValue1.visible=!1,this.gDesc0.visible=!1,this.gDesc1.visible=!1,this.gDesc2.visible=!1,this.gDesc3.visible=!1,this.gDesc4.visible=!1,this.imgStatus.visible=!1;var n=this.data.value,o=this.data.desc;if(n.length>0){var r;n.length>1&&(n=n.sort(function(t,e){return t.value_id-e.value_id})),n.map(function(t,i){var n=RECORD.localdata.person.value[t.value_id-1];n.tag_list.map(function(e){e.tag_value>0&&(t.value>e.tag_value||t.value==e.tag_value)&&(r=e.tag_name)}),e["textValue"+i].text=n.value_name+(t.value<0?t.value:"+"+t.value)})}o.length>0&&(o.length>1&&(o=o.sort(function(t,e){return t-e})),o.map(function(t,i){RECORD.localdata.person.desc.some(function(n){n.desc_id==t&&(e["textDesc"+i].text=n.desc_str,e["gDesc"+i].visible=!0)})}));var s=[],a=RECORD.localdata.person.story,c=RECORD.hiddenstory;RECORD.redpoint;a.map(function(t){if(t.person_id==e.data.id){var i=c.indexOf(t.id)>-1?!0:!1,n={id:t.id,unlock:i,name:t.story_name,tips:t.unlock_tips,image:t.story_pic,video:t.vedio_name,redpoint:t.red_point_id};s.push(n)}});var h=new eui.ArrayCollection(s);this.listStory.dataProvider=h,this.listStory.itemRenderer=t.Record_HiddenStoryItem,this.listStory.dataProviderRefreshed()}},i}(eui.ItemRenderer);t.Record_PersonListItem=e,__reflect(e.prototype,"Component.Record_PersonListItem",["eui.UIComponent","egret.DisplayObject"]);var i=function(t){function e(){var e=t.call(this)||this;return e.skinName="Record_EventListItem",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.dataChanged=function(){this.gTitle.visible=1==this.data.state?!0:!1,this.imgMask.visible=2==this.data.state?!0:!1,this.imgEvent.source=this.data.image?"https://www.npcstudio.cn/images/note/"+this.data.image:"dangan_guanjianshijian_yulan01_png"},e}(eui.ItemRenderer);t.Record_EventListItem=i,__reflect(i.prototype,"Component.Record_EventListItem",["eui.UIComponent","egret.DisplayObject"]);var n=function(e){function i(){var t=e.call(this)||this;return t.skinName="Record_AchieveListItem",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),t.buttonMousemove(this)},i.prototype.dataChanged=function(){var t=this,e="https://www.npcstudio.cn/images/note/";this.gContent.visible=this.data.unlock,this.gMask.visible=!this.data.unlock,this.textDesc.visible=!this.data.unlock,this.imgAchieve.source=this.data.smallpic?e+this.data.smallpic:"dangan_chengjiuyulan01_png",this.quest=void 0,this.questid=this.data.quest,this.gAwardShow.visible=!1,this.gAwardHide.visible=!1;var i=0,n=0;if(this.data.quest>0){var o=RECORD.questinfo[this.data.quest];o.progress<o.upper_limit?(i=o.progress||0,n=o.upper_limit):this.data.unlock&&this.data.group>0&&RECORD.localdata.achieve.some(function(e){return e.group_id==t.data.group&&e.id>t.data.id?(o=RECORD.questinfo[e.quest_id],i=o.progress||0,n=o.upper_limit,!0):void 0}),this.data.group>0&&RECORD.localdata.achieve.some(function(e){if(e.group_id==t.data.group){var i=RECORD.questreward.some(function(i){return console.log(e.name+":"+e.quest_id+",group:"+e.group_id+",groupquest:"+i.quest_id),i.quest_id==e.quest_id?(t.questid=i.quest_id,!0):void 0});return i}})}var r=[];if(RECORD.questreward.map(function(e){e.quest_id==t.questid&&r.push(e)}),r.length>0&&RECORD.questinfo[this.questid].status<2){var s=(RECORD.questinfo,this.data.unlock&&this.data.quest==this.questid?this.gAwardShow:this.gAwardHide),a=this.data.unlock&&this.data.quest==this.questid?this.gAwardinfoShow:this.gAwardinfoHide;a.removeChildren(),this.textAward||(this.textAward=new eui.Label,this.textAward.fontFamily="Microsoft Yahei",this.textAward.size=20),this.textAward.textColor=this.data.unlock&&this.data.quest==this.questid?0:10066329,this.textAward.text=this.data.quest!=this.questid?"100%可获得":this.data.unlock?"可领取":"解锁可获得",a.addChild(this.textAward),r.map(function(e){var i=new eui.Image;i.width=t.data.unlock&&t.data.quest==t.questid?49:29,i.height=t.data.unlock&&t.data.quest==t.questid?49:29,t.data.unlock&&t.data.quest==t.questid?i.source=1==e.reward_type?"paihangbang_dajidan_icon_png":"paihangbang_dahua_icon_png":i.source=1==e.reward_type?"paihangbang_xiaojidan_icon_png":"paihangbang_xiaoxianhua_icon_png",a.addChild(i);var n=new eui.Label;n.fontFamily="Microsoft Yahei",n.size=20,n.textColor=t.data.unlock&&t.data.quest==t.questid?0:10066329,n.text=e.reward_count.toString(),a.addChild(n)}),s.visible=!0,this.quest={id:this.questid,data:RECORD.questinfo[this.questid]}}n>0?(this.textRate.text=1==this.data.progresstype?i+"/"+n:Math.floor(i/10)/10+"%/"+n/100+"%",this.textDesc.visible=!0,this.textRate.visible=!0):this.textRate.visible=!1,RECORD.redpoint.indexOf(this.data.redpoint)>-1?this.iconNew.visible=!0:this.iconNew.visible=!1},i.prototype.onClick=function(){return __awaiter(this,void 0,void 0,function(){var t,e,t,i,n,e,e,o=this;return __generator(this,function(r){return console.log("this quest:"+this.data.quest+",group quest"+this.questid),this.data.unlock?(Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("PopupPicture",{id:this.data.id,type:SHARE_TYPE.achieve,image:this.data.bigpic}),this.quest&&1==this.quest.data.status&&(t=Net.ws(),e=t.send("questreward",{quest_id:this.quest.id}).then(function(t){if(0==t.ret){var e="领取成功";t.data.list_data.map(function(t){e+=" @"+(1==t.reward_type?"鸡蛋":"鲜花")+" +"+t.reward_count}),Toast.show(e),o.gAwardShow.visible=!1}})),this.iconNew.visible&&(this.iconNew.visible=!1,t=Net.ws(),this.data.group>0?(i=RECORD.localdata.achieve,n=[],i.map(function(t){t.group_id==o.data.group&&RECORD.redpoint.indexOf(t.red_point_id)>-1&&n.push(t.red_point_id)}),e=t.send("redpointhidden",{red_point:n})):e=t.send("redpointhidden",{red_point:[this.data.redpoint]})),[2]):(Logger.log("成就未解锁"),[2])})})},i}(eui.ItemRenderer);t.Record_AchieveListItem=n,__reflect(n.prototype,"Component.Record_AchieveListItem",["eui.UIComponent","egret.DisplayObject"]);var o=function(t){function e(){var e=t.call(this)||this;return e.skinName="Record_HiddenStoryItemSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.gTips.visible=!0,"disabled"!=e.currentState&&(e.currentState="move")},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.gTips.visible=!1,"disabled"!=e.currentState&&(e.currentState="up")},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"disabled"!=e.currentState&&(e.currentState="down")},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(t){var i=t.localX<0||t.localY<0||t.localX>e.width||t.localY>e.height;"disabled"!=e.currentState&&(e.currentState=i?"up":"move")},this)},e.prototype.dataChanged=function(){var t=this;this.currentState=this.data.unlock?"up":"disabled",this.imgThumb.visible=!1;var e=this.data.image?"https://www.npcstudio.cn/images/note/"+this.data.image:"https://www.npcstudio.cn/images/story/cover/zjk001.jpg";RES.getResByUrl(e,function(e){t.imgThumb.source=e,t.imgThumb.visible=!0},this,RES.ResourceItem.TYPE_IMAGE);var i=RECORD.redpoint,n=this.data.unlock&&i.indexOf(this.data.redpoint)>-1?!0:!1;this.iconNew.visible=n,this.desc.text=this.data.name},e.prototype.onClick=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){return this.data.unlock?(Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("HiddenStoryItem",{id:this.data.id,name:this.data.name,video:this.data.video}),this.iconNew.visible&&(RECORD.redpoint.indexOf(this.data.redpoint)>-1&&(t=Net.ws(),e=t.send("redpointhidden",{red_point:[this.data.redpoint]})),this.iconNew.visible=!1),[2]):(Toast.show(this.data.tips),Logger.log("人物未解锁"),[2])})})},e}(eui.ItemRenderer);t.Record_HiddenStoryItem=o,__reflect(o.prototype,"Component.Record_HiddenStoryItem",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="PlayerSliderSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.currentState="down"},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.currentState="up"},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.currentState="down"},this)},e.prototype.onChange=function(){},e}(eui.HSlider);t.PlayerSlider=e,__reflect(e.prototype,"Component.PlayerSlider",["eui.UIComponent","egret.DisplayObject"]);var i=function(t){function e(){var e=t.call(this)||this;return e.skinName="VideoVSliderSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.currentState="down"},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.currentState="up"},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.currentState="down"},this)},e.prototype.onChange=function(){},e}(eui.VSlider);t.VideoVSlider=i,__reflect(i.prototype,"Component.VideoVSlider",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){function e(){var t=new egret.Timer(1e4,1);t.addEventListener(egret.TimerEvent.COMPLETE,function(){i=!1},this),t.start()}var i=!1,n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(eui.Component);__reflect(n.prototype,"Storyline_node",["eui.UIComponent","egret.DisplayObject"]);var o=function(n){function o(){var t=n.call(this)||this;return t.status=0,t.skinName="Storyline_badendSkin",t}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){var e=this;n.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),this.btn.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.btn.currentState="up"},this),this.btn.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.btn.currentState="down"},this),t.buttonMousemove(this.btnPlay)},o.prototype.currentOn=function(){this.gCurrent.visible=!0,this.iconBee.visible=!1,this.currentTween.play(0)},o.prototype.currentOff=function(){this.gCurrent.visible=!1,this.iconBee.visible=-1===STORY.beBlockid.indexOf(this.info.id)?!1:!0,this.currentTween.stop(),this.image0.alpha=0,this.image1.alpha=1,this.image1.y=11},o.prototype.onClick=function(){if(!i&&(Logger.log("id:"+this.info.id+",canreplay:"+this.info.CanReplay),this.info.id==STORY.blockid||this.info.CanReplay))switch(i=!0,e(),this.status){case 0:this.gPlay.visible=!0,this.status=1,i=!1;break;case 1:Effect.play(AUDIO.PlayButton_Press_ogg),this.gPlay.visible=!1,this.status=0;({block_id:this.info.id});Logger.log("currentBlock beginfrom->"+this.info.id),Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(t){i=!1,t&&Scenes.exitUI("Skin.StoryView")})}},o}(eui.Component);t.Storyline_badend=o,__reflect(o.prototype,"Component.Storyline_badend",["eui.UIComponent","egret.DisplayObject"]);var r=function(n){function o(){var t=n.call(this)||this;return t.status=0,t.skinName="storyline_badend_currSkin",t}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){var e=this;n.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),this.btn.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.btn.currentState="up"},this),this.btn.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.btn.currentState="down"},this),t.buttonMousemove(this.btnPlay)},o.prototype.currentOn=function(){this.gCurrent.visible=!0,this.iconBee.visible=!1,this.currentTween.play(0)},o.prototype.currentOff=function(){this.gCurrent.visible=!1,this.iconBee.visible=-1===STORY.beBlockid.indexOf(this.info.id)?!1:!0,this.currentTween.stop(),this.image0.alpha=0,this.image1.alpha=1,this.image1.y=11},o.prototype.onClick=function(){if(!i&&(Effect.play(AUDIO.LocationButton_Press_ogg),Logger.log("id:"+this.info.id+",canreplay:"+this.info.CanReplay),this.info.id==STORY.blockid||this.info.CanReplay))switch(i=!0,e(),this.status){case 0:this.gPlay.visible=!0,this.status=1,i=!1;break;case 1:Effect.play(AUDIO.PlayButton_Press_ogg),this.gPlay.visible=!1,this.status=0;({block_id:this.info.id});Logger.log("currentBlock beginfrom->"+this.info.id),Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(t){i=!1,t&&Scenes.exitUI("Skin.StoryView")})}},o}(eui.Component);t.Storyline_badend_curr=r,__reflect(r.prototype,"Component.Storyline_badend_curr",["eui.UIComponent","egret.DisplayObject"]);var s=function(t){function e(){var e=t.call(this)||this;return e.skinName="Storyline_cannotSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},e.prototype.onTap=function(){Logger.log("blockid:"+this.info.id)},e}(eui.Component);t.Storyline_cannot=s,__reflect(s.prototype,"Component.Storyline_cannot",["eui.UIComponent","egret.DisplayObject"]);var a=function(t){function e(){var e=t.call(this)||this;return e.skinName="Storyline_cannot_currSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},e.prototype.onTap=function(){Logger.log("blockid:"+this.info.id)},e}(eui.Component);t.Storyline_cannot_curr=a,__reflect(a.prototype,"Component.Storyline_cannot_curr",["eui.UIComponent","egret.DisplayObject"]);var c=function(n){function o(){var t=n.call(this)||this;return t.skinName="Storyline_curblockSkin",t}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){n.prototype.childrenCreated.call(this),this.btnCurrent.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this),this.btnPlay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSeek,this),t.buttonMousemove(this.btnCurrent),t.buttonMousemove(this.btnPlay),this.currentTween.play(0)},o.prototype.onTap=function(){Logger.log("id:"+this.info.id),this.btnCurrent.visible=!1,this.btnPlay.visible=!0,Effect.play(AUDIO.LocationButton_Press_ogg),Logger.log(this.info.id+",blockid:"+STORY.blockid)},o.prototype.onSeek=function(){if(!i){Effect.play(AUDIO.PlayButton_Press_ogg),i=!0,e();({block_id:this.info.id});Logger.log("currentBlock beginfrom->"+this.info.id),Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(t){i=!1,t&&Scenes.exitUI("Skin.StoryView")})}},o}(eui.Component);t.Storyline_curblock=c,__reflect(c.prototype,"Component.Storyline_curblock",["eui.UIComponent","egret.DisplayObject"]);var h=function(t){function e(){var e=t.call(this)||this;return e.skinName="Storyline_notReachedButShowSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},e.prototype.onTap=function(){Logger.log("blockid:"+this.info.id)},e}(eui.Component);t.Storyline_notReachedButShow=h,__reflect(h.prototype,"Component.Storyline_notReachedButShow",["eui.UIComponent","egret.DisplayObject"]);var u=function(e){function i(){var t=e.call(this)||this;return t.skinName="Storyline_reachedSkin",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),t.buttonMousemove(this.btn)},i.prototype.currentOn=function(){this.gCurrent.visible=!0,this.currentTween.play(0)},i.prototype.currentOff=function(){this.gCurrent.visible=!1,this.currentTween.stop(),this.image0.alpha=0,this.image1.alpha=1,this.image1.y=11},i.prototype.onClick=function(t){Logger.log("-------thisBlockId:"+this.info.id),Effect.play(AUDIO.NormalButton_Press_ogg);var e=Scenes.get("Component.Storyline_pop");e.gPopup.x=t.stageX-e.gPopup.width/2,e.gPopup.y=this.y+this.height-e.gPopup.height,e.gPopup.x=e.gPopup.x+e.gPopup.width>1920?1920-e.gPopup.width:e.gPopup.x<50?50:e.gPopup.x,e.gPopup.y=e.gPopup.y<100?100:e.gPopup.y+e.gPopup.height>this.parent.height-100?this.parent.height-100-e.gPopup.height:e.gPopup.y,e.textTitle.text=this.info.title,e.textInfo.text=this.info.text,e.id=this.info.id,e.chapterid=this.info.chapterid,e.type="reached",e.imgThumb.visible=!1,Scenes.mainStage.addChild(e),Scenes.get("Skin.StoryView").cachePop(e);var i=this.image.replace("jd","tc");"none"===this.image?(e.imgThumb.source="gushixian_yulansuonuetu_png",e.imgThumb.visible=!0):RES.getResByUrl("http://www.npcstudio.cn/images/story/node1/"+i+".png",function(t){e.imgThumb.source=t,e.imgThumb.visible=!0},this,RES.ResourceItem.TYPE_IMAGE),Logger.log(this.imgThumb.source)},i}(eui.Component);t.Storyline_reached=u,__reflect(u.prototype,"Component.Storyline_reached",["eui.UIComponent","egret.DisplayObject"]);var d=function(e){function i(){var t=e.call(this)||this;return t.skinName="Storyline_reached_currSkin",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.btn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this),t.buttonMousemove(this.btn)},i.prototype.currentOn=function(){this.gCurrent.visible=!0,this.currentTween.play(0)},i.prototype.currentOff=function(){this.gCurrent.visible=!1,this.currentTween.stop(),this.image0.alpha=0,this.image1.alpha=1,this.image1.y=11},i.prototype.onClick=function(t){this.gCurrent.visible?Effect.play(AUDIO.LocationButton_Press_ogg):Effect.play(AUDIO.NormalButton_Press_ogg),Logger.log("-------thisBlockId:"+this.info.id);var e=Scenes.get("Component.Storyline_pop");e.gPopup.x=t.stageX-e.gPopup.width/2,e.gPopup.y=this.y+this.height-e.gPopup.height,e.gPopup.x=e.gPopup.x+e.gPopup.width>1920?1920-e.gPopup.width:e.gPopup.x<50?50:e.gPopup.x,e.gPopup.y=e.gPopup.y<100?100:e.gPopup.y+e.gPopup.height>this.parent.height-100?this.parent.height-100-e.gPopup.height:e.gPopup.y,e.textTitle.text=this.info.title,e.textInfo.text=this.info.text,e.id=this.info.id,e.chapterid=this.info.chapterid,e.type="reached",e.imgThumb.visible=!1,Scenes.mainStage.addChild(e),Scenes.get("Skin.StoryView").cachePop(e);var i=this.image.replace("jd","tc");"none"===this.image?(e.imgThumb.source="gushixian_yulansuonuetu_png",e.imgThumb.visible=!0):RES.getResByUrl("http://www.npcstudio.cn/images/story/node1/"+i+".png",function(t){e.imgThumb.source=t,e.imgThumb.visible=!0},this,RES.ResourceItem.TYPE_IMAGE),Logger.log(this.imgThumb.source)},i}(eui.Component);t.Storyline_reached_curr=d,__reflect(d.prototype,"Component.Storyline_reached_curr",["eui.UIComponent","egret.DisplayObject"]);var l=function(n){function o(){var t=n.call(this)||this;return t.skinName="Storyline_popSkin",t.width=1920,t.height=1080,t.horizontalCenter=0,t}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){n.prototype.childrenCreated.call(this),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),this.btnSeek.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSeek,this),t.buttonMousemove(this.btnSeek),t.buttonMousemove(this.btnClose),this.playTween.play(0)},o.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Scenes.get("Skin.StoryView").clearPop()},o.prototype.onSeek=function(){var t=this;if(!i){Effect.play(AUDIO.PlayButton_Press_ogg),i=!0,e();({block_id:this.id});this.id==STORY.blockid?(Logger.log("currentBlock beginfrom->"+this.id),Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(e){t.onClose(),i=!1,e&&Scenes.exitUI("Skin.StoryView")})):(Logger.log(this.type+(" beginfrom->"+this.id)),Scenes.addUI("Skin.VideoView",{cmd:"beginfrom",params:{block_id:this.id,chapter_id:this.chapterid}}).then(function(e){t.onClose(),i=!1,e&&Scenes.exitUI("Skin.StoryView")}))}},o}(eui.Component);t.Storyline_pop=l,__reflect(l.prototype,"Component.Storyline_pop",["eui.UIComponent","egret.DisplayObject"]);var p=function(n){function o(){var t=n.call(this)||this;return t.chars="序一二三四五六七八七八九十终六",t}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){n.prototype.childrenCreated.call(this),t.buttonMousemove(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.openStory,this)},o.prototype.fillData=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o;return __generator(this,function(r){switch(r.label){case 0:return t=STORY.chapterInfo(this.id),e=t.fromBlockid,i=-1===STORY.chapterUnlock.indexOf(this.index),i?[3,2]:[4,DLC.checkChapter(this.index)];case 1:i=!r.sent(),r.label=2;case 2:return i?this.unlocked=!1:(this.unlocked||t.unlocked||STORY.allPath.indexOf(this.id)>-1||STORY.currentPath.indexOf(this.id)>-1||STORY.allPath.indexOf(e)>-1&&!STORY.undoneNode(e))&&(this.unlocked=!0,t.unlocked=!0),this.textTitle.visible=this.unlocked?!0:!1,this.textTitle.text=this.title,this.imgThumb.source=this.image?"http://www.npcstudio.cn/images/story/cover/"+this.image+".png":this.imgThumb.source,this.gNumber.visible=this.unlocked?!0:!1,this.textNumber.text=this.chars.charAt(this.index),this.imgMask.visible=this.unlocked?!1:!0,this.imgLock.visible=this.unlocked?!1:!0,this.gPercent.visible=this.unlocked?!0:!1,this.unlocked&&(this.imgPercent.width=parseInt(STORY.chapterExplore(this.id))/100*234+16),n=STORY.chapterInfo(this.index).parents[0],o=STORY.allPath.indexOf(n)>-1,this.unlocked?[4,DLC.checkChapter(this.index)]:[3,4];case 3:return r.sent()?(this.imgNew.visible=STORY.allPath.indexOf(this.id)>-1?!1:!0,this.imgPre.visible=!1):this.imgPre.visible=!0,[3,5];case 4:this.imgPre.visible=o?!0:!1,r.label=5;case 5:return[2]}})})},o.prototype.currentOn=function(){this.gCurrent.visible=!0,this.currentTween.play(0)},o.prototype.currentOff=function(){this.gCurrent.visible=!1,this.currentTween.stop(),this.image0.alpha=0,this.image1.alpha=1,this.image1.y=11},o.prototype.openStory=function(){return __awaiter(this,void 0,void 0,function(){var t,t,n=this;return __generator(this,function(o){return console.log(this.id),i?[2]:(i=!0,e(),this.imgNew.visible?(Effect.play(AUDIO.NormalButton_Press_ogg),Logger.log("解锁id:"+STORY.nextChapterid),Scenes.addUI("Skin.VideoView",{cmd:"beginfrom",params:{block_id:this.id,chapter_id:this.id}}).then(function(t){n.imgNew.visible=!1,i=!1})):this.imgPre.visible?(Effect.play(AUDIO.NormalButton_Press_ogg),t=new f({id:this.id,time:this.time,image:this.image,pre:this.imgPre.visible}),Scenes.get("Skin.ChapterView").addChild(t),Scenes.get("Skin.ChapterView").cachePop(t),i=!1):STORY.chapterInfo(this.index).unlocked?(Effect.play(AUDIO.NormalButton_Press_ogg),Scenes.addUI("Skin.StoryView",{chapterId:this.id}).then(function(t){i=!1,t&&Scenes.exitUI("Skin.ChapterView")})):this.time<1?(Effect.play(AUDIO.UI_Unlock_ogg),Toast.show("章节未开启 需通关前一章"),i=!1):(Effect.play(AUDIO.NormalButton_Press_ogg),t=new f({id:this.id,time:this.time,image:this.image}),Scenes.get("Skin.ChapterView").addChild(t),Scenes.get("Skin.ChapterView").cachePop(t),i=!1),[2])})})},o.prototype.unlockCount=function(){var t=this;if(Logger.log("查询当前解锁倒计时的章节ID是否是："+this.id),this.id==Time.unlockid){Time.countdown(this.textTime,function(){return t.countFinish()})}else this.textTime.text=Time.format(this.time)},o.prototype.countFinish=function(){this.id==Time.unlockid&&(this.textTime.text="已开启",this.gNumber.visible=!0,this.imgLock.visible=!1,this.gTime.visible=!1,this.unlocked=!0,this.textTitle.visible=!0,this.imgMask.visible=!1,this.imgPre.visible=!1,this.imgNew.visible=!0,Scenes.get("Skin.ChapterView").currentLine(this.id))},o}(eui.Component);t.Chapter_item=p,__reflect(p.prototype,"Component.Chapter_item",["eui.UIComponent","egret.DisplayObject"]);var g=function(e){function i(){var t=e.call(this)||this;return t.skinName="Chapter_eggSkin",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){var i=this;e.prototype.childrenCreated.call(this),t.buttonMousemove(this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){"红色芳华"==i.label?i.imgThumb.alpha=1:(i.imgPlay.visible=STORY.checkAwardNode(i.id),i.imgThumb.alpha=0)},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){i.imgPlay.visible=!1,i.imgThumb.alpha=1},this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClick,this)},i.prototype.fillData=function(){switch(this.imgMask.visible=!STORY.checkAwardNode(this.id),this.textTitle.text=this.label,this.label){case"扶桑安魂曲":this.imgThumb.source="zhangjie_jieju_huizhang_fusanganhun_png";break;case"美丽世界":this.imgThumb.source="zhangjie_jieju_huizhang_meili_png";break;case"丧钟为谁而鸣":this.imgThumb.source="zhangjie_jieju_huizhang_sangzhong_png";break;case"红色芳华":this.imgThumb.source="zhangjie_jieju_huizhang_hongsefanghua_png"}},i.prototype.onClick=function(){Effect.play(AUDIO.PlayButton_Press_ogg),STORY.checkAwardNode(this.id)?"红色芳华"==this.label?Widget.pop("PopupPicture",{end:!0,image:"https://www.npcstudio.cn/images/bg/end.png"}):Widget.pop("HiddenStoryItem",{id:this.id,name:this.label,video:"https://www.npcstudio.cn/videos/mv/"+this.id+".mp4"}):Toast.show("结局达成解锁")},i}(eui.Component);t.Chapter_egg=g,__reflect(g.prototype,"Component.Chapter_egg",["eui.UIComponent","egret.DisplayObject"]);
var f=function(n){function o(t){var e=n.call(this)||this;return e.skinName="Chapter_popSkin",e.info=t,e.width=1920,e.height=1080,e.horizontalCenter=0,e}return __extends(o,n),o.prototype.partAdded=function(t,e){n.prototype.partAdded.call(this,t,e)},o.prototype.childrenCreated=function(){n.prototype.childrenCreated.call(this),this.init(),this.btnClose.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onClose,this),this.btnPreviewPlay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPreviewPlay,this),this.btnPreviewPause.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPreviewPause,this),this.layMask.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPreviewPause,this),this.dlcGroup.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toSteam,this),t.buttonMousemove(this.btnClose),t.buttonMousemove(this.btnPreviewPlay),t.buttonMousemove(this.btnPreviewPause),this.reset=this.reset.bind(this)},o.prototype.init=function(){var t=this,e=STORY.chapterInfo(this.info.id),i=e.ChapterLabel.split("·");this.textTitle.text=i.length>1?i[0]+"　"+i[1]:i[0],this.imgCover.source=this.info.image?"http://www.npcstudio.cn/images/story/cover/"+this.info.image+".jpg":"";STORY.chapterInfo();this.btnGroup.visible=!1,STORY.chapterUnlock.length>0&&-1===STORY.chapterUnlock.indexOf(e.index)?(this.dlcGroup.visible=!1,this.comingGroup.visible=!0,this.preGroup.visible=!1):DLC.checkChapter(e.index).then(function(e){e?(t.dlcGroup.visible=!1,t.comingGroup.visible=!1,t.preGroup.visible=!0):(t.dlcGroup.visible=!0,t.comingGroup.visible=!1,t.preGroup.visible=!1)})},o.prototype.countFinish=function(){STORY.chapterInfo(this.info.id).unlocked=!0,this.textTime.text="已开启",this.btnDash.visible=!1,this.btnPlay.visible=!0,this.imgLock.visible=!1,NOVICE[3]&&(this.gNoviceunlock.visible=!1),this.btnPlay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPlay,this)},o.prototype.onClose=function(){Effect.play(AUDIO.CloseButton_Press_ogg),this.playing&&this.onPreviewPause(),this.parent.removeChild(this),Scenes.get("Skin.ChapterView").chapterPop=void 0},o.prototype.onDash=function(){Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("PopupUnlock",this.info.id)},o.prototype.onPlay=function(){var t=this;i||(i=!0,e(),Effect.play(AUDIO.PlayButton_Press_ogg),Logger.log("解锁id:"+STORY.nextChapterid),Scenes.addUI("Skin.VideoView",{cmd:"beginfrom",params:{block_id:this.info.id,chapter_id:this.info.id}}).then(function(e){i=!1,e&&t.onClose()}))},o.prototype.toSteam=function(){Steam.toSteamStore()},o.prototype.previewPlay=function(){var t=this;return new Promise(function(e){function i(){Loading.hide(),n.video.removeEventListener("loadeddata",i),n.imgCover.visible=!1,n.btnPreviewPlay.visible=!1,n.btnPreviewPause.visible=!0,n.render=new egret.iVideo(n.video),n.render.width=n.gVideo.width,n.render.height=n.gVideo.height,n.gVideo.addChildAt(n.render,0),BGM.setVolume(0),n.video.play(),n.render.play(),n.timer.running&&n.timer.reset(),n.timer=void 0,e(!0)}var n=t,o=STORY.chapterInfo(n.info.id).index;t.video=document.createElement("video"),t.video.className="video",t.video.crossOrigin="anonymous",t.video.src="http://www.npcstudio.cn/videos/trailer/"+o+".mp4",t.video.volume=USER.volume,document.body.appendChild(t.video),t.timer=new egret.Timer(5e3,1),t.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){t.video.removeEventListener("loadeddata",i),Toast.show("网络异常，视频加载视频失败，请重新尝试"),t.reset()},t),t.video.addEventListener("loadeddata",i),t.video.addEventListener("ended",t.reset),t.video.load(),t.timer.start()})},o.prototype.onPreviewPlay=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return Effect.play(AUDIO.PlayButton_Press_ogg),Loading.show(),this.playing=!0,[4,this.previewPlay()];case 1:return t.sent(),this.gTips.visible=!1,[2]}})})},o.prototype.onPreviewPause=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.playing&&(Effect.play(AUDIO.NormalButton_Press_ogg),this.render&&this.render.pause(),this.video&&this.video.pause(),this.reset()),[2]})})},o.prototype.reset=function(){BGM.setVolume(USER.volume),this.imgCover.visible=!0,this.gTips.visible=!0,this.btnPreviewPlay.visible=!0,this.btnPreviewPause.visible=!1,this.video&&(this.video.src=""),this.render&&this.gVideo.removeChild(this.render),this.video&&document.body.removeChild(this.video),this.render=null,this.video=null,this.playing=!1,this.timer&&(this.timer.reset(),this.timer=void 0)},o}(eui.Component);t.Chapter_pop=f,__reflect(f.prototype,"Component.Chapter_pop",["eui.UIComponent","egret.DisplayObject"]);var v=function(t){function e(e){var i=t.call(this)||this;return i.skinName="Storyline_TipsSkin",i.desc.text=e,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e}(eui.Component);t.Storyline_Tips=v,__reflect(v.prototype,"Component.Storyline_Tips",["eui.UIComponent","egret.DisplayObject"]);var _=function(e){function i(){var t=e.call(this)||this;return t.status=!1,t.skinName="Storyline_KeyEventSkin",t}return __extends(i,e),i.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},i.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.icon.addEventListener(mouse.MouseEvent.MOUSE_OVER,this.showKeyEvent,this),this.icon.addEventListener(mouse.MouseEvent.MOUSE_OUT,this.hideKeyEvent,this)},i.prototype.showKeyEvent=function(){console.log(this.keyEventDesc),this.tips=new t.Storyline_Tips(this.keyEventDesc),this.tips.x=Math.floor(this.x-this.tips.width/2),this.tips.y=Math.floor(this.y-this.height/2-16),this.status=!0,this.parent.addChild(this.tips)},i.prototype.hideKeyEvent=function(){this.status=!1,this.parent.removeChild(this.tips)},i}(eui.Component);t.Storyline_KeyEvent=_,__reflect(_.prototype,"Component.Storyline_KeyEvent",["eui.UIComponent","egret.DisplayObject"]);var m=function(t){function e(e){void 0===e&&(e={});var i=t.call(this)||this;return i.opt=e,i.skinName="Storyline_StoryEndSkin",i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.setDesc=function(t){var e=/【(.*?)】/,i=t.match(e);this.tips.text=i[0]+"结局达成"},e.prototype.setIcon=function(t){var e=Movie.getDB(t,t);e.x=0,e.y=0,e.touchEnabled=!1,this.gDB.removeChildren(),this.gDB.addChild(e),e.animation.play(void 0,0)},e}(eui.Component);t.Storyline_StoryEnd=m,__reflect(m.prototype,"Component.Storyline_StoryEnd",["eui.UIComponent","egret.DisplayObject"]);var y=function(t){function e(e){void 0===e&&(e={});var i=t.call(this)||this;return i.opt=e,i.skinName="Storyline_ChapterEndSkin",i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.tips.text=this.opt.desc},e.prototype.setDesc=function(t){this.tips.text=t},e}(eui.Component);t.Storyline_ChapterEnd=y,__reflect(y.prototype,"Component.Storyline_ChapterEnd",["eui.UIComponent","egret.DisplayObject"]);var b=function(t){function e(){var e=t.call(this)||this;return e.skinName="Storyline_ExporeLockdSkin",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.getReward,this),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){"Storyline_ExploreReceivedSkin"!==e.skinName&&(e.tips.desc.text=e.coins+" 金币",e.tips.visible=!0),"Storyline_ExploreUnlockSkin"===e.skinName&&(e.currentState="move")},this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){"Storyline_ExploreReceivedSkin"!==e.skinName&&(e.tips.visible=!1),"Storyline_ExploreUnlockSkin"===e.skinName&&(e.currentState="up")},this),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"Storyline_ExploreUnlockSkin"===e.skinName&&(e.currentState="down")},this),this.addEventListener(egret.TouchEvent.TOUCH_END,function(t){if("Storyline_ExploreUnlockSkin"===e.skinName){var i=t.localX<0||t.localY<0||t.localX>e.width||t.localY>e.height;e.currentState=i?"up":"move"}},this)},e.prototype.getReward=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return"Storyline_ExploreUnlockSkin"!==this.skinName?[3,2]:(t=Net.ws(),[4,t.send("recvsettlereward",{chapter_id:this.chapterid,reward_id:this.rewardid})]);case 1:return e=i.sent(),0===e.ret?(Effect.play(AUDIO.UI_Accept_ogg),MALL.coin=e.data.cur_money.coins,this.skinName="Storyline_ExploreReceivedSkin",Toast.show("获得 "+e.data.add_money.coins+" 金币"),[2,!0]):[3,3];case 2:"Storyline_ExploreLockdSkin"===this.skinName&&(Effect.play(AUDIO.UI_Warn_ogg),Toast.show("奖励还未解锁")),i.label=3;case 3:return[2,!1]}})})},e}(eui.Component);t.Storyline_ExploreButton=b,__reflect(b.prototype,"Component.Storyline_ExploreButton",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i.icons={"@鲜花":"paihangbang_xiaoxianhua_icon_png","@鸡蛋":"paihangbang_xiaojidan_icon_png"},i.list=[],i.skinName="ToastSkin",i.text=e,i.init(),i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.init=function(){this.width=1920,this.height=1080,this.horizontalCenter=0,this._label=new eui.Label,this._label.size=22,this._label.fontFamily="Microsoft YaHei",this._label.textColor=16777215,this._label.x=0,this.gContent.addChild(this._label)},e.prototype.reset=function(){this._label.visible=!1,this.gContent.removeChildren(),this.list=[]},e.prototype.text2image=function(t){var e=this;if(t){this.reset();var i=/@金币|@钻石|@体力|@鲜花|@鸡蛋/g,n=String(t).match(i);if(n&&n.length>0){var o=t.split(i);o.forEach(function(t,i){if(t){var o=new eui.Label;o.text=t,o.size=22,o.fontFamily="Microsoft YaHei",o.textColor=16777215,e.gContent.addChild(o),e.list.push(o)}var r=n[i];if(r){var s=new eui.Image(e.icons[r]);e.gContent.addChild(s),e.list.push(s)}})}else this._label.parent||this.gContent.addChild(this._label),this.showText(t)}},e.prototype.showText=function(t){this._label.visible=!0,this._label.text=t},Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(t){this._text=t,this.text2image(t)},enumerable:!0,configurable:!0}),e}(eui.Component);t.ToastComponet=e,__reflect(e.prototype,"Component.ToastComponet",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Component;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.skinName="TopbarSkin",e.right=0,e.top=0,e.touchEnabled=!1,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.moneyInit(),this.addEventListener(mouse.MouseEvent.MOUSE_OVER,this.onTips,this),this.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.gTips.visible=!1},this),Events.register("dataChange",this.moneyChange,this)},e.prototype.onTips=function(){this.textTips.text="通关章节或完成探索度奖励可免费获得金币，用于帮助。",this.gTips.visible=!0},e.prototype.moneyInit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,Coins.init()];case 1:return t.sent(),this.moneyChange(),[2]}})})},e.prototype.moneyChange=function(){this.textGold.text=MALL.coin.toString()},e}(eui.Component);t.Topbar=e,__reflect(e.prototype,"Component.Topbar",["eui.UIComponent","egret.DisplayObject"]);var i=function(t){function e(){var e=t.call(this)||this;return e.skinName="Topbar2Skin",e.right=0,e.top=0,e.touchEnabled=!1,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.gFlower.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){return e.onTips(1)},this),this.gFlower.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.gTips.visible=!1},this),this.gFlower.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("PopupBuy",{type:2})},this),this.gEgg.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){return e.onTips(2)},this),this.gEgg.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.gTips.visible=!1},this),this.gEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Effect.play(AUDIO.NormalButton_Press_ogg),Widget.pop("PopupBuy",{type:1})},this),this.moneyChange(),Events.register("dataChange",this.moneyChange,this)},e.prototype.onTips=function(t){this.textTips.text=1==t?"鲜花道具，用于给剧情角色送花":"鸡蛋道具，用于向剧情角色砸蛋",this.gTips.visible=!0},e.prototype.moneyChange=function(){this.textFlower.text=MALL.flower.toString(),this.textEgg.text=MALL.egg.toString()},e}(eui.Component);t.Topbar2=i,__reflect(i.prototype,"Component.Topbar2",["eui.UIComponent","egret.DisplayObject"])}(Component||(Component={}));var Bright;!function(t){function e(){return new Promise(function(t,e){Env.tvideo&&TenvideoJSBridge.invoke("getBrightness",null,function(e){e="string"==typeof e?JSON.parse(e):e,(0===e.errCode||"0"===e.errCode)&&t(e.result.brightness)})})}function i(t){Env.tvideo&&TenvideoJSBridge.invoke("setBrightness",{brightness:t})}t.get=e,t.set=i}(Bright||(Bright={}));var USER={set avatar(t){Memory.set("USER.avatar",t)},get avatar(){return Memory.get("USER.avatar")},set appid(t){Memory.set("USER.appid",t)},get appid(){return Memory.get("USER.appid")},set path(t){t=t.replace("app.asar",""),Memory.set("USER.path",t)},get path(){return Memory.get("USER.path")},set openid(t){Memory.set("USER.openid",t)},get openid(){return Memory.get("USER.openid")||""},set ticket(t){Memory.set("USER.ticket",t)},get ticket(){return Memory.get("USER.ticket")},set encryid(t){Memory.set("USER.encryid",t)},get encryid(){return Memory.get("USER.encryid")},set sessionKey(t){Memory.set("USER.sessionKey",t)},get sessionKey(){return Memory.get("USER.sessionKey")},set nickname(t){Memory.set("USER.nickname",t)},get nickname(){return Memory.get("USER.nickname")},set loginType(t){Memory.set("USER.loginType",t)},get loginType(){return Memory.get("USER.loginType")},get use4G(){return Memory.get("USER.use4G")||!1},set use4G(t){Memory.set("USER.use4G",t)},get defn(){return parseInt(localStorage.getItem("USER.defn"))||1},set defn(t){localStorage.setItem("USER.defn",String(t))},get bgm(){var t=localStorage.getItem("USER.bgm")&&"false"===localStorage.getItem("USER.bgm")?!1:!0;return t},set fullscreen(t){Memory.set("USER.fullscreen",t)},get fullscreen(){return Memory.get("USER.fullscreen")},set bgm(t){localStorage.setItem("USER.bgm",String(t))},set pageHide(t){Memory.set("USER.pageHide",t)},get pageHide(){return Memory.get("USER.pageHide")||!1},set hideTime(t){Memory.set("USER.hideTime",t)},get hideTime(){return Memory.get("USER.hideTime")},set bright(t){Memory.set("USER.bright",t)},get bright(){return Memory.get("USER.bright")||0},set volume(t){Memory.set("USER.volume",t)},get volume(){var t=void 0===Memory.get("USER.volume")?1:Memory.get("USER.volume");return t},set rank(t){Memory.set("USER.rank",t)},get rank(){return Memory.get("USER.rank")},set Friends(t){LS.set("USER_Friends",JSON.stringify(t))},get Friends(){var t=LS.get("USER_Friends");return t?t:[]},get system(){return Memory.get("USER.system")},set system(t){Memory.set("USER.system",t)},set effect(t){Memory.set("USER.effect",t)},get effect(){return Memory.get("USER.effect")}},MALL={set coin(t){Database.set("MALL.coin",t)},get coin(){return Database.get("MALL.coin")||0},set reliveCost(t){Database.set("MALL.reliveCost",t)},get reliveCost(){return Database.get("MALL.reliveCost")||100},set coins2Time(t){Database.set("MALL.coins2Time",t)},get coins2Time(){return Database.get("MALL.coins2Time")||300},set flower(t){Database.set("MALL.flower",t)},get flower(){return Database.get("MALL.flower")||0},set egg(t){Database.set("MALL.egg",t)},get egg(){return Database.get("MALL.egg")||0},set flowerUsedDay(t){Database.set("MALL.flowerUsedDay",t)},get flowerUsedDay(){return Database.get("MALL.flowerUsedDay")||0},set eggUsedDay(t){Database.set("MALL.eggUsedDay",t)},get eggUsedDay(){return Database.get("MALL.eggUsedDay")||0},set flowerUsedWeek(t){Database.set("MALL.flowerUsedWeek",t)},get flowerUsedWeek(){return Database.get("MALL.flowerUsedWeek")||0},set eggUsedWeek(t){Database.set("MALL.eggUsedWeek",t)},get eggUsedWeek(){return Database.get("MALL.eggUsedWeek")||0},set flowerUsedTotal(t){Database.set("MALL.flowerUsedTotal",t)},get flowerUsedTotal(){return Database.get("MALL.flowerUsedTotal")||0},set eggUsedTotal(t){Database.set("MALL.eggUsedTotal",t)},get eggUsedTotal(){return Database.get("MALL.eggUsedTotal")||0}},STORY={set node2Block(t){Memory.set("STORY.node2Block",t)},get node2Block(){return Memory.get("STORY.node2Block")},set nodeid(t){Database.set("STORY.nodeid",t)},get beBlockid(){return Memory.get("STORY.beBlockid")||[]},set beBlockid(t){Memory.set("STORY.beBlockid",t)},get nodeid(){return Database.get("STORY.nodeid")},set chapterid(t){Database.set("STORY.chapterid",t)},get chapterid(){var t=Database.get("STORY.chapterid");return t||Object.keys(STORY.allChaptersInfo).forEach(function(e){0===STORY.allChaptersInfo[e].index&&(t=STORY.allChaptersInfo[e].id)}),t},get preChapterid(){return STORY.allChaptersInfo&&STORY.allChaptersInfo[STORY.chapterid]&&STORY.allChaptersInfo[STORY.chapterid].childs.length>0?STORY.allChaptersInfo[STORY.chapterid].parents[0]:""},get nextChapterid(){return STORY.allChaptersInfo&&STORY.allChaptersInfo[STORY.chapterid]&&STORY.allChaptersInfo[STORY.chapterid].childs.length>0?STORY.allChaptersInfo[STORY.chapterid].childs:[]},set allChaptersInfo(t){Database.set("STORY.allChaptersInfo",t)},get allChaptersInfo(){return Database.get("STORY.allChaptersInfo")||{}},set blockid(t){Database.set("STORY.blockid",t)},get blockid(){return Database.get("STORY.blockid")},set currentPath(t){Database.set("STORY.currentPath",t)},get currentPath(){return Database.get("STORY.currentPath")||[]},set allPath(t){Database.set("STORY.allPath",t)},get allPath(){return Database.get("STORY.allPath")||[]},get data(){return Database.get("STORY.data")},set data(t){Database.set("STORY.data",t)},set lastPlayTime(t){Database.set("STORY.lastPlayTime",t)},get lastPlayTime(){return Database.get("STORY.lastPlayTime")},get globalExplore(){return STORY.allChaptersInfo.global?STORY.allChaptersInfo.global.explore:"0%"},set exportData(t){t.forEach(function(t){if("global"===t.chapter_id){var e=t.chapter_percent/100;STORY.allChaptersInfo.global={id:"global",explore:e+"%"},Database.set("STORY.globalExplore",e)}else if(STORY.allChaptersInfo[t.chapter_id]){var e=Math.floor(t.chapter_percent/1e4*100)+"%";e!==STORY.allChaptersInfo[t.chapter_id].explore&&"Skin.VideoView"===Scenes.currentUI&&Events.dispatch("explore_change",{chapterid:t.chapter_id,explore:Math.floor(t.chapter_percent/1e4*100)}),STORY.allChaptersInfo[t.chapter_id].explore=e}})},chapterExplore:function(t){return STORY.allChaptersInfo[t]&&STORY.allChaptersInfo[t].explore?STORY.allChaptersInfo[t].explore:"0%"},chapterInfo:function(t){if("string"==typeof t)return STORY.allChaptersInfo[t]?STORY.allChaptersInfo[t]:{};var e;return Object.keys(STORY.allChaptersInfo).forEach(function(i){STORY.allChaptersInfo[i].index===t&&(e=i)}),e?STORY.allChaptersInfo[e]:{}},blockInfo:function(t,e,i){return void 0===e&&(e=STORY.chapterid),void 0===i&&(i=!1),__awaiter(this,void 0,void 0,function(){var n,o,r,s,a,c,h,u,d,l;return __generator(this,function(p){switch(p.label){case 0:return STORY.chapterInfo(e)?!STORY.chapterInfo(e).nodes||STORY.chapterInfo(e).nodes&&0===STORY.chapterInfo(e).nodes.length?[4,StoryData.getBlockInfo(e)]:[3,2]:[2];case 1:p.sent(),p.label=2;case 2:for(n=STORY.chapterInfo(e).nodes,o=null,r=0,s=n.length;s>r;r++)n[r].id===t&&(o=n[r]);return o||!o&&i?[2,o]:[3,3];case 3:a=[];for(c in STORY.allChaptersInfo)a.push(c);h=0,p.label=4;case 4:return h<a.length?(u=a[h],d=STORY.allChaptersInfo[u],"global"===u||"GeEggNode"===d.type?[3,6]:[4,STORY.blockInfo(t,u,!0)]):[3,7];case 5:if(l=p.sent())return o=l,[3,7];p.label=6;case 6:return h++,[3,4];case 7:return[2,o]}})})},nodeInfo:function(t,e){return void 0===e&&(e=STORY.chapterid),__awaiter(this,void 0,void 0,function(){var i,n,o;return __generator(this,function(r){switch(r.label){case 0:return STORY.chapterInfo(e)?!STORY.chapterInfo(e).nodes||STORY.chapterInfo(e).nodes&&0===STORY.chapterInfo(e).nodes.length?[4,StoryData.getBlockInfo(e)]:[3,2]:[2];case 1:r.sent(),r.label=2;case 2:for(i=STORY.chapterInfo(e).nodes,n=0,o=i.length;o>n;n++)if(i[n].nodeid&&i[n].nodeid.indexOf(t)>-1)return[2,i[n]];return[2]}})})},get chapterhasnew(){var t=Object.keys(STORY.allChaptersInfo).some(function(t){return STORY.chapterInfo(t).index>4?!1:STORY.chapterInfo(t).unlocked&&STORY.allPath.indexOf(t)<0&&STORY.currentPath.indexOf(t)<0?!0:void 0});return t},get canUnlock(){return Memory.get("STORY.canUnlock")||0},set canUnlock(t){Memory.set("STORY.canUnlock",t)},get chapterUnlock(){return Memory.get("STORY.chapterUnlock")||[]},set chapterUnlock(t){Memory.set("STORY.chapterUnlock",t)},get AwardVideoNode(){return LS.get("STORY.AwardVideoNode")||[]},set AwardVideoNode(t){LS.set("STORY.AwardVideoNode",t)},undoneNode:function(t){var e=LS.get("STORY.undoneNode")||[];return-1===e.indexOf(t)?!1:!0},addUndoneNode:function(t){var e=LS.get("STORY.undoneNode")||[];return-1===e.indexOf(t)&&e.push(t),LS.set("STORY.undoneNode",e),!0},removeUndoneNode:function(t){var e=LS.get("STORY.undoneNode")||[],i=e.indexOf(t);return i>-1&&e.splice(i,1),LS.set("STORY.undoneNode",e),!0},checkAwardNode:function(t){return t?-1!==STORY.AwardVideoNode.indexOf(t):!1}},RECORD={set localdata(t){Database.set("RECORD.localdata",t)},get localdata(){return Database.get("RECORD.localdata")||{}},set questinfo(t){var e=t.quest_map;if(t.is_all)Database.set("RECORD.questinfo",e);else{var i=RECORD.questinfo,n=RECORD.questreward;Object.keys(e).map(function(t){i[t]=e[t];var o=n.some(function(e){return e.quest_id==t?!0:void 0});o&&"Skin.RecordView"==Scenes.currentUI&&(2==Scenes.get("Skin.RecordView").index?Scenes.get("Skin.RecordView").achieveList(!0):Scenes.get("Skin.RecordView").achieveStatus=!1)}),Database.set("RECORD.questinfo",i)}},get questinfo(){return Database.get("RECORD.questinfo")||{}},set personinfo(t){var e=[];if(t.person_info_list.map(function(t){t.person_id&&e.push(t)}),t.is_all)Database.set("RECORD.personinfo",e);else{var i=RECORD.personinfo;e.map(function(t){var e=i.some(function(e,n){return e.person_id==t.person_id?(i[n]=t,!0):void 0});e||i.push(t)}),Database.set("RECORD.personinfo",i)}},get personinfo(){return Database.get("RECORD.personinfo")||[]},set hiddenstory(t){var e=[];if(t.hidden_story_info_list.map(function(t){t.id>0&&e.push(t.id)}),t.is_all)Database.set("RECORD.hiddenstory",e);else{var i=RECORD.hiddenstory;e.map(function(t){i.indexOf(t)>-1||i.push(t)}),Database.set("RECORD.hiddenstory",i)}},get hiddenstory(){return Database.get("RECORD.hiddenstory")||[]},set importantevent(t){var e=[];if(t.important_event_info_list.map(function(t){t.id&&e.push(t)}),t.is_all)Database.set("RECORD.importantevent",e);else{var i=RECORD.importantevent;e.map(function(t){var e=i.some(function(e,n){return e.id==t.id?(i[n]=t,!0):void 0});e||i.push(t)}),Database.set("RECORD.importantevent",i)}},get importantevent(){return Database.get("RECORD.importantevent")||[]},set achievement(t){var e=[];if(t.achievement_info_list.map(function(t){t.achievement_id>0&&e.push(t)}),t.is_all)Database.set("RECORD.achievement",e);else{var i=RECORD.achievement;Logger.log(e),e.map(function(t){var e=i.some(function(e,n){return e.achievement_id==t.achievement_id?(i[n]=t,!0):void 0});e||i.push(t)}),Database.set("RECORD.achievement",i)}Events.dispatch("achieve_unlock",{achieve:e,is_all:t.is_all})},get achievement(){return Database.get("RECORD.achievement")||[]},set redpoint(t){var e=[];t&&t.red_point_list&&t.red_point_list.map(function(t){t>0&&e.push(t)}),Database.set("RECORD.redpoint",e)},get redpoint(){return Database.get("RECORD.redpoint")||[]},set questreward(t){t&&t.list_data&&Database.set("RECORD.questreward",t.list_data)},get questreward(){return Database.get("RECORD.questreward")||[]}},PlayerFlag;!function(t){t[t.PS_NULL=0]="PS_NULL",t[t.PS_Start=1]="PS_Start",t[t.PS_Pause=2]="PS_Pause",t[t.PS_Finish=3]="PS_Finish",t[t.PS_Story=4]="PS_Story",t[t.PS_Jump=5]="PS_Jump",t[t.PS_Home=6]="PS_Home",t[t.PS_Record=7]="PS_Record"}(PlayerFlag||(PlayerFlag={}));var UNGET,CGI={get proto(){return Env.qq?"http://"+Env.server.qqServer+"/datapkg":Env.wechat?"http://"+Env.server.wxServer+"/datapkg":"http://"+Env.server.guestServer+"/datapkg"},get socket(){var t=void 0;return t=Env.qq?Env.server.qqServer:Env.wechat?Env.server.wxServer:Env.server.qqServer,"ws://"+t+"?account_value="+USER.openid+"&account_type=4098&appid=102123&token=a8723123adf13212313"}},SHOP={},AUDIO={NormalButton_Press_ogg:"NormalButton_Press_ogg",SlideBehavior_Slide_ogg:"SlideBehavior_Slide_ogg",HintPopUp_Display_ogg:"HintPopUp_Display_ogg",StoryChoice_Press_ogg:"StoryChoice_Press_ogg",PlayButton_Press_ogg:"PlayButton_Press_ogg",LocationButton_Press_ogg:"LocationButton_Press_ogg",PaymentButton_Press_ogg:"PaymentButton_Press_ogg",RewardFlash_FX_ogg:"RewardFlash_FX_ogg",ProgressBar_FX_ogg:"ProgressBar_FX_ogg",CloseButton_Press_ogg:"CloseButton_Press_ogg",Storyline_Slide_ogg:"Storyline_Slide_ogg",TitleText_Display_ogg:"TitleText_Display_ogg",LongPressButton_Hold_ogg:"LongPressButton_Hold_ogg",RewardPopUp_Display_ogg:"RewardPopUp_Display_ogg",Timer_Display_ogg:"Timer_Display_ogg",WeaponButton_Press_ogg:"WeaponButton_Press_ogg",BEUI_BGM_ogg:"BEUI_BGM_ogg",CompleteUI_BGM_ogg:"CompleteUI_BGM_ogg",LoginUI_BGM_ogg:"LoginUI_BGM_ogg",MainMenu_BGM_ogg:"MainMenu_BGM_ogg",VictoryUI_BGM_ogg:"VictoryUI_BGM_ogg",LoginUI_Jingle_ogg:"LoginUI_Jingle_ogg",UI_back_ogg:"UI_back_ogg",AllChapButton_Press_ogg:"AllChapButton_Press_ogg",BigButton_Press_ogg:"BigButton_Press_ogg",Capture_Press_ogg:"Capture_Press_ogg",CharacterInfo_appear_ogg:"CharacterInfo_appear_ogg",CharacterName_appear_ogg:"CharacterName_appear_ogg",CountDown_ogg:"CountDown_ogg",GiftButton_Press_ogg:"GiftButton_Press_ogg",Set_Press_ogg:"Set_Press_ogg",UI_Accept_ogg:"UI_Accept_ogg",UI_Give_ogg:"UI_Give_ogg",UI_Pause_ogg:"UI_Pause_ogg",UI_QTE_AreaActive_ogg:"UI_QTE_AreaActive_ogg",UI_QTE_LongPress_ogg:"UI_QTE_LongPress_ogg",UI_QTE_NormalPress_ogg:"UI_QTE_NormalPress_ogg",UI_QTE_Slide_ogg:"UI_QTE_Slide_ogg",UI_Receive_ogg:"UI_Receive_ogg",UI_Resume_ogg:"UI_Resume_ogg",UI_StartPress_ogg:"UI_StartPress_ogg",UI_Unlock_ogg:"UI_Unlock_ogg",UI_Warn_ogg:"UI_Warn_ogg",OptionPopup_ogg:"OptionPopup_ogg"},NOVICE={},NOVICE_TYPE;!function(t){t[t.start=70]="start",t[t.choice=71]="choice",t[t.badend=72]="badend",t[t.revive=73]="revive",t[t.story=74]="story",t[t.chapter=75]="chapter",t[t.queue=76]="queue",t[t.next=77]="next",t[t.reward=78]="reward",t[t.allchapter=79]="allchapter",t[t.firstchapter=80]="firstchapter",t[t.qteslider=81]="qteslider",t[t.startegg=82]="startegg"}(NOVICE_TYPE||(NOVICE_TYPE={}));var SHARE={set localdata(t){Database.set("SHARE.localdata",t)},get localdata(){return Database.get("SHARE.localdata")||{}},set value(t){var e=new Object;t.var_list.map(function(t){e[t.key]=t.value}),Database.set("SHARE.value",e)},get value(){return Database.get("SHARE.value")||{}}},SHARE_TYPE;!function(t){t[t.videoshot=1]="videoshot",t[t.goodend=2]="goodend",t[t.badend=3]="badend",t[t.achieve=4]="achieve",t[t.ranklist=5]="ranklist"}(SHARE_TYPE||(SHARE_TYPE={}));var VAR_ID;!function(t){t[t.rankpic=9]="rankpic",t[t.ranktext=10]="ranktext",t[t.achievepic=11]="achievepic",t[t.achievetext=12]="achievetext"}(VAR_ID||(VAR_ID={}));var VIDEO;!function(t){t.showChoice="VIDEO.showChoice",t.selectChoice="VIDEO.selectChoice",t.loading="VIDEO.loading",t.waiting="VIDEO.waiting",t.reset="VIDEO.reset",t.defn="VIDEO.defn"}(VIDEO||(VIDEO={}));var NETWORK;!function(t){t.change="NETWORK.change",t.notice="NETWORK.notice",t.WIFI="NETWORK.WIFI",t.lostWIFI="NETWORK.lostWIFI",t.out="NETWORK.out",t.reconnect="NETWORK.reconnect"}(NETWORK||(NETWORK={}));var STEAMWIN;!function(t){t.minimize="minimize",t.restore="restore"}(STEAMWIN||(STEAMWIN={}));var Cookie;!function(t){function e(t){if(document.cookie&&""!=document.cookie)for(var e,i=document.cookie.split("; "),n=0,o=i.length,t=encodeURIComponent(t);o>n;n++)if(e=i[n].split("="),t==e[0])return decodeURIComponent(e[1]||"");return null}function i(t,e,i){return void 0===i&&(i={domain:"npcstudio.cn",path:"/",expires:86400}),t&&e?(document.cookie=[encodeURIComponent(t),"=",encodeURIComponent(e),i&&i.domain?"; domain="+i.domain:"",i&&i.path?"; path="+i.path:"",i&&i.expires?"; expires="+new Date((new Date).getTime()+1e3*i.expires).toUTCString():"",i&&i.secure?"; secure":""].join(""),!0):!1}t.getCookie=e,t.setCookie=i}(Cookie||(Cookie={}));var Database;!function(t){function e(t){return o[t]}function i(t,e){e||"object"!=typeof t?(o[t]!==e&&(r[t]=o[t],o[t]=e,Events.dispatch("dataChange."+t,{data:o[t],orign:r[t]})),Events.dispatch("dataChange",{data:o,orign:r})):(Object.keys(t).forEach(function(e){o[e]!==t[e]&&(r[e]=o[e],o[e]=t[e],Events.dispatch("dataChange."+e,{data:o[e],orign:r[e]}))}),Events.dispatch("dataChange",{data:o,orign:r}))}function n(t,n){var o=e(t);o&&i(t,o+n)}var o={},r={};t.get=e,t.set=i,t.clac=n}(Database||(Database={}));var Memory;!function(t){function e(t){return n[t]||null}function i(t,e){n[t]=e}var n={};t.get=e,t.set=i}(Memory||(Memory={}));var LS;!function(t){function e(t){var e=JSON.parse(localStorage.getItem("DATA_"+USER.openid))||{};return e[t]||null}function i(t,e){if(USER.openid){var i=JSON.parse(localStorage.getItem("DATA_"+USER.openid))||{};i[t]=e,localStorage.setItem("DATA_"+USER.openid,JSON.stringify(i))}}t.get=e,t.set=i}(LS||(LS={}));var DLC;!function(t){function e(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,Utils.getJSON("dlc.json")];case 1:return t=e.sent(),t&&(Memory.set("DLC.chapters",t.chapterid),Memory.set("DLC.appid",t.appid)),[2]}})})}function i(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,Steam.checkDLC(t)];case 1:return e=i.sent(),[2,e]}})})}function n(){return Memory.get("DLC.appid")}function o(){return Memory.get("DLC.chapters")}function r(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return o().indexOf(e)>-1?[4,t.hasDLC(n())]:[3,2];case 1:return[2,i.sent()];case 2:return[2,!0]}})})}t.init=e,t.hasDLC=i,t.getAppid=n,t.chappters=o,t.checkChapter=r}(DLC||(DLC={}));var Env;!function(t){function e(){return new Promise(function(e,i){switch(t.app){case"minigame":wx.getNetworkType({success:function(t){t.networkType&&e(f[t.networkType])},fail:function(){e(1)}});break;case"tvideo":TenvideoJSBridge.invoke("getNetworkState",null,function(t){if("string"==typeof t&&(t=JSON.parse(t)),0==t.errCode){var i=t.result;"string"==typeof i&&(i=JSON.parse(i)),e(i.state)}else e(5)});break;case"steam":e(navigator.onLine?1:0);break;default:e(navigator.onLine?navigator.onLine?1:0:1)}})}function i(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){switch(i.label){case 0:return[4,e()];case 1:return t=i.sent(),[2,1===t]}})})}function n(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,e()]})})}var o,r,s,a=/QQLiveBrowser/,c=/\bMicroMessenger\/([\d\.]+)/,h=/\bQQ\/([\d\.]+)/,u=/MiniGame/,d=/TBS\/(\d+)/,l=egret.Capabilities.os,p=navigator.userAgent,g=document.documentElement.clientWidth>document.documentElement.clientHeight?document.documentElement.clientWidth/document.documentElement.clientHeight:document.documentElement.clientHeight/document.documentElement.clientWidth,f={wifi:1,"4g":4,"3g":3,"2g":2,none:0,unknown:5};
"iOS"===l?r=0:"Android"===l?r=1:"Windows PC"==l?r=2:"Mac OS"==l&&(r=3),c.test(p)?o=u.test(p)?"minigame":"weichat":h.test(p)?o="qq":a.test(p)?o="tvideo":-1!=p.indexOf("Electron")&&(o="steam"),t.isMobile=egret.Capabilities.isMobile,t.isPc=2===r,t.isDesktop=2===r||3===r,t.isX5=t.andriod&&d.test(p)?!0:!1,t.iOS=0===r,t.andriod=1===r,t.wechat="weichat"===o,t.qq="qq"===o,t.tvideo="tvideo"===o,t.minigame="minigame"===o,t.platformOS=l,t.platformid=r,t.app=o,t.online=navigator.onLine,t.superWide=g>1.78,t.ultraWide=g>2,t.isWifi=i,t.getNetwork=n,t.debug="test"===s,t.boss="boss"===s,t.product="product"===s,t.version="5.0.0.0",t.server={serverName:"product",qqServer:"ws.npcstudio.cn:8844",wxServer:"ws.npcstudio.cn:8844",guestServer:"ws.npcstudio.cn:8844",releaseServer:1,dirPath:""}}(Env||(Env={}));var Events;!function(t){var e={};t.dispatch=function(e,i){void 0===i&&(i=null),t.__ins.dispatchEvent(new t.CustomEvent(e,i))},t.register=function(i,n,o){var r=o.skinName||o.name||o.__class__;r?e[r+"@"+i]||(t.__ins.addEventListener(i,n,o),e[r+"@"+i]=!0):t.__ins.addEventListener(i,n,o)},t.remove=function(i,n,o){var r=o.skinName||o.name||o.__class__;r&&(e[r+"@"+i]=!1),t.__ins.removeEventListener(i,n,o)};var i=function(t){function e(e,i,n,o){void 0===n&&(n=!1),void 0===o&&(o=!1);var r=t.call(this,e,n,o)||this;return r.data=i,r}return __extends(e,t),e}(egret.Event);t.CustomEvent=i,__reflect(i.prototype,"Events.CustomEvent"),t.__ins=new egret.EventDispatcher}(Events||(Events={}));var Friends;!function(t){function e(t){var e=LS.get("USER_Friends");t.forEach(function(t){e[t.openid]={nickname:t.nick,avatar:t.pic,openid:t.openid}}),LS.set("USER_Friends",JSON.stringify(e))}function i(t){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return i=LS.get("USER_Friends"),n=t.map(function(t){return i[t]?void 0:t}),n.length>0?(o=Net.ws(),[4,o.send("getFriendInfo",{openid_list:n})]):[3,2];case 1:r=a.sent(),0===r.ret&&r.data&&r.data.info_list&&r.data.info_list.length>0&&e(r.data.info_list),a.label=2;case 2:return i=LS.get("USER_Friends"),s=t.map(function(t){return i[t]}),[2,s]}})})}function n(t){return __awaiter(this,void 0,void 0,function(){var e,i,n;return __generator(this,function(o){switch(o.label){case 0:return e=s.rank,!e[t]||e[t]&&Date.now()>e[t].expireTime?(i=Net.ws(),[4,i.send("getRank",{rank_type:1,page_num:t})]):[3,2];case 1:n=o.sent(),0===n.ret&&(e[t]=n.data),o.label=2;case 2:return[2,e[t]]}})})}function o(t){return __awaiter(this,void 0,void 0,function(){var e,i,n;return __generator(this,function(o){switch(o.label){case 0:return e=s.together,!e[t]||e[t]&&Date.now()>e[t].expireTime?(i=Net.ws(),[4,i.send("getRank",{rank_type:3,chapter_id:t})]):[3,2];case 1:n=o.sent(),0===n.ret&&(e[t]=n.data),o.label=2;case 2:return[2,e[t]]}})})}function r(t){}var s={rank:{},together:{}};t.getFriendInfo=i,t.getRank=n,t.getTogether=o,t.setCache=r}(Friends||(Friends={}));var Keyboard;!function(t){function e(){document.addEventListener("keyup",function(t){if(!Loading.isShow()){var e=Scenes.get(Scenes.currentUI),i=t.keyCode;if(27===i&&Widget.hasPop()){if("Component.PopupGetItem"==egret.getQualifiedClassName(Widget.currentPop))return;return void("Component.HiddenStoryItem"==egret.getQualifiedClassName(Widget.currentPop)?Widget.currentPop.onClose():Widget.closePop())}return 13===i&&Widget.hasPop()?"Component.PopupPicture"==egret.getQualifiedClassName(Widget.currentPop)?void Widget.currentPop.onSave():void Widget.confirmPop():void(e&&e.keyboard&&e.onKeyboard(i))}})}t.init=e}(Keyboard||(Keyboard={}));var Load;!function(t){function e(t){return"story"===t||"setting"===t?"shezhi_bg1920_1080_jpg":["login","start","end"].indexOf(t)>-1?t+"_bg_jpg":null}function i(t){return e(t)?Promise.all([RES.getRes(e(t)),RES.loadGroup(t)]):RES.loadGroup(t)}function n(){var t=0,e=0;return Object.keys(a).forEach(function(i){e+=a[i].loaded,t+=a[i].total}),0===t&&0==e?"100%":Math.round(e/t*100)+"%"}function o(t){return new Promise(function(e,n){var o=t.map(function(t){return r(t)?void 0:i(t)});Promise.all(o).then(function(){a={},e(!0)})})}function r(t){return RES.isGroupLoaded(t)}function s(){return new Promise(function(t,e){})}var a={};t.showProcess=n,t.group=o,t.isLoaded=r,t.loadALLGroup=s}(Load||(Load={}));var Loading;!function(t){function e(t){var e=this;return void 0===t&&(t="loading_png"),new Promise(function(t,i){RES.getResAsync("loading_png",function(){p=!0,t(!0)},e)})}function i(t){h=new LoadingUI,h.text=t,u.addChild(h),l=!0}function n(){return l}function o(t){!l&&e(),u=t,d=new egret.Timer(1e4,1),d.addEventListener(egret.TimerEvent.TIMER,a,this)}function r(t){return void 0===t&&(t="加载中"),u?p?(l?(h.text=t,h.checkMask(),d.reset()):i(t),d.start(),h):(e().then(function(){d.start(),i(t)}),h):void console.error("Loading 必须先初始化")}function s(t,e){l||i("0%"),h.setProgress(t,e)}function a(){l&&(l=!1,u.removeChild(h),d.reset())}function c(){l&&(d.running&&d.reset(),d.start())}var h,u,d,l=!1,p=!1;t.isShow=n,t.init=o,t.show=r,t.setProgress=s,t.hide=a,t.reset=c}(Loading||(Loading={}));var Login;!function(t){function e(t){return void 0===t&&(t="wx"),new Promise(function(e,n){TenvideoJSBridge.invoke("actionLogin",{type:t}),TenvideoJSBridge.on("onActionLoginFinish",function(t){if(t="string"==typeof t?JSON.parse(t):t,0==t.errCode)if(Env.iOS)i().then(function(){e({code:0,loginType:"wx"})});else{var o=t.result,r="string"==typeof o.userInfo?JSON.parse(o.userInfo):o.userInfo;USER.loginType=o.type,USER.avatar=r.headImgUrl,USER.nickname=r.nickname,USER.openid=r.openId,e({code:0})}else n({code:-1,msg:"登录失败"})})})}function i(t){return void 0===t&&(t="wx"),new Promise(function(e,i){TenvideoJSBridge.invoke("getUserInfo",{type:[t]},function(i){if(i="string"==typeof i?JSON.parse(i):i,0==i.errCode&&i.result){var n=i.result;n&&n[t]?(USER.loginType=t,USER.avatar=n[t].headImgUrl,USER.nickname=n[t].nickname,USER.openid=n[t].openId,Logger.log("检查登录"),e({code:0,loginType:t})):(Logger.log("检查未登录"),e({code:-1,loginType:null}))}else Logger.log("检查未登录"),e({code:-1,loginType:null})})})}function n(){return new Promise(function(t){wx.login({success:function(e){var i=e.code;t(i)}})})}function o(t){return new Promise(function(e,i){wx.request({url:"https://api.weixin.qq.com/sns/jscode2session",data:{jscode:t},dataType:"json",method:"GET",success:function(t){var i=t.statusCode;if(200==i){var n=t.data;USER.openid=n.openid,USER.sessionKey=n.session_key,e(n)}}})})}function r(){return new Promise(function(t,e){wx.getUserInfo({success:function(e){var i=e.userInfo;USER.avatar=i.avatarUrl,USER.nickname=i.nickName,t(e)},fail:function(){}})})}function s(t){return void 0===t&&(t="wx"),__awaiter(this,void 0,void 0,function(){var t,e,i,n,o;return __generator(this,function(r){switch(r.label){case 0:try{t=localStorage.getItem("steamInfo")?JSON.parse(localStorage.getItem("steamInfo")):null}catch(s){t=null}return[4,Steam.getSteamId()];case 1:return e=r.sent(),i=e.id,n=e.appid,!t||t&&!t.data||t&&t.expireTime&&Date.now()>Math.floor(t.expireTime)||t&&t.data.steamId!==i||t&&t.data.appid!==n?[4,Steam.getSteamInfo()]:[3,3];case 2:t=r.sent(),r.label=3;case 3:return 0!==t.ret?[3,5]:(USER.openid=t.data.steamId,USER.ticket=t.data.ticket,USER.encryid=t.data.encryid,USER.appid=t.data.appid,localStorage.setItem("steamInfo",JSON.stringify(t)),[4,Net.ws().login()]);case 4:return o=r.sent(),[2,o];case 5:return[2,{code:-1,loginType:"steam",msg:"通信失败，请1分钟后尝试重新连接。"}]}})})}function a(){return e("qq")}function c(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){switch(i.label){case 0:return"tvideo"!==Env.app?[3,1]:[2,e("wx")];case 1:return"minigame"!==Env.app?[3,3]:[4,n()];case 2:return t=i.sent(),[2,Promise.all([o(t),r()])];case 3:return[2]}})})}function h(){return e("tv")}function u(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t="Skin.VideoView"===Scenes.currentUI||"Skin.EscView"===Scenes.currentUI,t?[4,Player.exit()]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return[4,Net.ws().logout()];case 3:return e.sent(),Scenes.addUI("Skin.LoginView").then(function(){"Skin.EscView"===Scenes.currentUI&&(Scenes.exitUI(),Player.exit()),Widget.pop("PopupDialog",{title:"提示",content:"您的帐号已下线，请重新登录",button:["确认"],callback:function(){Steam.relauchGame()}})}),[2]}})})}function d(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t="Skin.VideoView"===Scenes.currentUI||"Skin.EscView"===Scenes.currentUI,t?[4,Player.exit()]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return[4,Net.ws().logout()];case 3:return e.sent(),Scenes.addUI("Skin.LoginView").then(function(){Widget.pop("PopupDialog",{title:"提示",content:"您的帐号已在其他地方登录，请重新登录",button:["确认"],callback:function(){Steam.relauchGame()}})}),[2]}})})}t.check=s,t.qqLogin=a,t.wxLogin=c,t.tvLogin=h,t.logout=u,t.kickOff=d}(Login||(Login={}));var Movie;!function(t){function e(e){if(t.pool[e])return t.pool[e];var i=RES.getRes(e+"_json"),n=RES.getRes(e+"_png"),o=new egret.MovieClipDataFactory(i,n),r=new egret.MovieClip(o.generateMovieClipData(e));return t.pool[e]=r,r}function i(e,i,n){if(t.pool[e])return t.pool[e];var o=RES.getRes(e+"_ske_json"),r=RES.getRes(e+"_tex_json"),s=n?RES.getRes(n+"_tex_png"):RES.getRes(e+"_tex_png"),a=new dragonBones.EgretFactory;a.parseDragonBonesData(o),a.parseTextureAtlasData(r,s);var c=i?i:"armatureName",h=a.buildArmatureDisplay(c);return t.pool[e]=h,h}t.pool=new Object,t.getMC=e,t.getDB=i}(Movie||(Movie={}));var Net;!function(t){function e(){return i||(i=new s),i}var i,n=[2026],o={getcoins:{cmd:"C2G_Req_Get_Currency",struct:"CSReqGetCurrency",sendKey:"reqCSGetCurrency",reviceKey:"resCSGetCurrency"},unlockcharpter:{cmd:"C2G_Req_Unlock_Chapter",struct:"CSReqUnlockChapter",sendKey:"reqCSUnlockChapter",reviceKey:"resCSUnlockChapter"},getcharpter:{cmd:"C2G_Req_Get_Charpter",struct:"CSReqGetCharpterInfo",sendKey:"reqGetCharpterInfo",reviceKey:"resGetCharpterInfo"},gm:{cmd:"C2G_Req_GM_Command",struct:"CSResGMCommand",sendKey:"reqCSGMCommand",reviceKey:"resCSGMCommand"},login:{cmd:"C2G_Req_Account_Login",struct:"CSReqAccountLogin",sendKey:"reqCSAccountLogin",reviceKey:"resCSAccountLogin"},logout:{cmd:"C2G_Req_Account_Logout",struct:"CSReqAccountLogout",sendKey:"reqCSAccountLogout",reviceKey:"resCSAccountLogout"},heartbeat:{cmd:"C2G_Req_Heartbeat",struct:"CSReqHeartbeat",sendKey:"reqCSHeartbeat",reviceKey:"resCSHeartbeat"},choice:{cmd:"C2G_Req_Story_Choose",struct:"CSReqStoryChoose",sendKey:"reqCSStoryChoose",reviceKey:"resCSStoryChoose"},restart:{cmd:"C2G_Req_Restart",struct:"CSReqRestart",sendKey:"reqCSRestart",reviceKey:"resCSRestart"},unlock:{cmd:"C2G_Req_Unlock_Chapter",struct:"CSReqUnlockChapter",sendKey:"reqCSUnlockChapter",reviceKey:"resCSUnlockChapter"},blockpath:{cmd:"C2G_Req_Block_Path",struct:"CSReqBlockPath",sendKey:"reqCSBlockPath",reviceKey:"resCSBlockPath"},loadgame:{cmd:"C2G_Req_Load_Game",struct:"CSReqLoadGame",sendKey:"reqCSLoadGame",reviceKey:"resCSLoadGame"},savegame:{cmd:"C2G_Req_Save_Game",struct:"CSReqSaveGame",sendKey:"reqCSSaveGame",reviceKey:"resCSSaveGame"},beginfrom:{cmd:"C2G_Req_Begin_From_Block",struct:"CSReqBeginFromBlock",sendKey:"reqCSBeginFromBlock",reviceKey:"resCSBeginFromBlock"},revive:{cmd:"C2G_Req_Relive",struct:"CSReqRelive",sendKey:"reqCSRelive",reviceKey:"resCSRelive"},getsettlereward:{cmd:"C2G_Req_Get_SettleReward",struct:"CReqGetSettleReward",sendKey:"reqGetSettleReward",reviceKey:"resGetSettleReward",timeout:"网络异常，无法获取奖励信息，请重新尝试",retry:1,callback:function(){"Skin.GoodEndView"===Scenes.currentUI&&(Scenes.exitUI(),Scenes.addUI("Skin.startView").then(function(t){t&&Player.exit()}))}},recvsettlereward:{cmd:"C2G_Req_Receive_SettleReward",struct:"CReqReceiveSettleReward",sendKey:"reqRecvSettleReward",reviceKey:"resRecvSettleReward",timeout:"网络异常，无法领取奖励，请重新尝试",retry:1,callback:function(){"Skin.GoodEndView"===Scenes.currentUI&&(Scenes.exitUI(),Scenes.addUI("Skin.startView").then(function(t){t&&Player.exit()}))}},novicedata:{cmd:"C2G_Req_Novice_Data",struct:"NoviceDataReq",sendKey:"novice_data_req",reviceKey:"novice_data_res"},redpointhidden:{cmd:"C2G_Req_RedPoint_Hidden",struct:"RedPointHiddenReq",sendKey:"red_point_hidden_req",reviceKey:"red_point_hidden_res"},sharereport:{cmd:"C2G_Req_Report_Share",struct:"CSReqReportShare",sendKey:"reqReportShare",reviceKey:"resReportShare"},getRank:{cmd:"C2G_Req_Get_Rank",struct:"CSReqGetRank",sendKey:"reqCSGetRank",reviceKey:"rank_list_ntf"},getFriendInfo:{cmd:"C2G_Req_Get_Player_LiteInfo",struct:"CSReqGetPlayerLiteInfo",sendKey:"reqCSGetPlayerLiteInfo",reviceKey:"resCSGetPlayerLiteInfo"},sendCoins:{cmd:"C2G_Req_Send_Friend_Coins",struct:"CSReqSendFriendCoins",sendKey:"reqCSSendFriendCoins",reviceKey:"resCSSendFriendCoins"},revcMail:{cmd:"C2G_Req_Recv_Mails",struct:"CSReqRecvMails",sendKey:"reqCSRecvMails",reviceKey:"resCSRecvMails"},getMail:{cmd:"C2G_Req_Get_Mails",struct:"CSReqGetMails",sendKey:"reqCSGetMails",reviceKey:"resCSGetMails"},setnick:{cmd:"C2G_Req_Set_Nick",struct:"CSReqSetNick",sendKey:"reqCSSetNick",reviceKey:"resCSSetNick"},doCall:{cmd:"C2G_Req_Do_Call",struct:"CSReqDoCall",sendKey:"reqCSDoCall",reviceKey:"resCSDoCall"},buy:{cmd:"C2G_Req_Buy",struct:"CSReqBuy",sendKey:"reqCSBuy",reviceKey:"resCSBuy"},finishBuy:{cmd:"C2G_Req_Fin_Buy",struct:"CSReqFinBuy",sendKey:"reqCSFinBuy",reviceKey:"resCSFinBuy"},cancelBuy:{cmd:"C2G_Req_Cancel_Buy",struct:"CSReqCancelBuy",sendKey:"reqCSCancelBuy",reviceKey:"resCSCancelBuy"},confirmOrder:{cmd:"C2G_Req_Recv_Confirm_Order",struct:"CSReqRecvConfirmOrder",sendKey:"reqCSRecvConfirmOrder",reviceKey:"resCSRecvConfirmOrder"},questreward:{cmd:"C2G_Req_Quest_Reward_Recv",struct:"CSQuestRewardRecvReq",sendKey:"reqQuestRewardRecv",reviceKey:"resQuestRewardRecv"}},r=function(){function t(t){void 0===t&&(t={url:CGI.proto,timeout:5}),this.url=t.url,this.timeout=t.timeout}return t.prototype.serialize=function(t){var e="";return Object.keys(t).map(function(i){e+="&"+i+"="+encodeURIComponent(t[i])}),e},t.prototype.get=function(t,e){var i=this;return new Promise(function(n,o){new egret.HttpRequest;e&&(t+=-1!==t.indexOf("?")?i.serialize(e):"?"+i.serialize(e)),i.send({method:"GET",url:t,success:function(e){try{var i=JSON.parse(e);n(i)}catch(o){n({code:1002,ret:1002,msg:"JSON格式化失败，错误信息："+o}),Logger.log("接口信息 :"+t+",JSON格式化失败，错误信息："+o)}},failed:function(e){n({code:e.code||1e3,ret:1e3,msg:"请求接口失败,接口信息 :"+t+",错误信息："+e.msg})}})})},t.prototype.post=function(t,e){var i=this;return new Promise(function(n,o){i.send({method:"POST",url:t,contentType:"application/x-www-form-urlencoded",data:i.serialize(e),success:function(e){try{var i=JSON.parse(e);n(i)}catch(o){n({code:1002,ret:1002,msg:"JSON格式化失败，错误信息："+o}),Logger.log("接口信息 :"+t+",JSON格式化失败，错误信息："+o)}},failed:function(e){n({code:e.code||1e3,ret:1e3,msg:"请求接口失败,接口信息 :"+t+",错误信息："+e.msg})}})})},t.prototype.jsonp=function(t,e){var i=this;return new Promise(function(n,o){function r(){s.parentNode&&s.parentNode.removeChild(s),h&&clearTimeout(h),window[a]=void 0}var s=(document.head,document.createElement("script")),a="_jsonp_"+Date.now(),c=(~t.indexOf("?")?"&":"?")+i.serialize(e)+"="+encodeURIComponent(a),h=setTimeout(function(){r(),n({code:2e3,ret:2e3,msg:"请求接口超时,接口信息 :"+t})},1e3*i.timeout);s.src=c.replace("?&","?"),document.getElementsByTagName("head")[0].appendChild(s),window[a]=function(t){n(t),r()}})},t.prototype.proto=function(t,e){var i=this;return void 0===e&&(e={}),new Promise(function(n,r){var s=o[t]||null;if(!s)return void n({code:1e3,ret:1e3,msg:"未定义的结构体 ,请在 action 里检查定义的结构体"});var a=s.url,c=s.timeout,h=s.retry,u=protobuf.roots["default"],d=u.deploy;if(!d)return void n({code:1e3,ret:1e3,msg:"未定义命名空间 ,请在 proto 里检查定义的结构体"});var l=d.Msg,p=l.create();p.head=d.MsgHead.create({Cmd:l.Cmd_C2G[s.cmd.trim()],openid:USER.openid}),p.body=d.MsgBody.create(),p.body[s.sendKey]=d[s.struct].create(e);var g=l.verify(p);if(Logger.log("<----------"+s.cmd+"--发包------------->"),Logger.log(p),g)return void n({code:1e3,ret:1e3,msg:g});var f=l.encode(p).finish();"minigame"===Env.app&&(f=f.buffer.slice(f.byteOffset,f.byteOffset+f.byteLength)),i.send({method:"POST",url:a||i.url,httpResponseType:"arraybuffer",contentType:"application/octet-stream",data:f,credentials:!1,auto:"savegame"===t?1:0,success:function(o){var r=s.reviceKey,a=new Uint8Array(o),c=l.decode(a);Logger.log("<-----------"+s.cmd+" 收包-------------------->"),Logger.log(c);var h=c.head;0!==h.ret?2003===h.ret?(Toast.show("2003 - 正在重连..."),i.proto("login").then(function(o){0===o.ret?i.proto(t,e).then(function(t){Toast.hide(),n(t)}):n({code:2e3,ret:2e3,msg:"请求接口失败,接口信息 :"+s.cmd+",错误信息：服务端无法重连"})})):h.error_str&&Widget.pop("PopupDialog",{title:"提示",content:h.ret+" - "+h.error_str,button:["确认"],callback:function(t){return __awaiter(i,void 0,void 0,function(){return __generator(this,function(t){return n({code:1e3,ret:h.ret,msg:h.error_str}),[2]})})}}):n(c.body?{code:0,data:c.body[r],ret:h.ret}:{code:0,ret:h.ret,data:{}})},failed:function(o){c?Widget.pop("PopupDialog",{title:"提示",content:c,button:h?["点击重试","返回"]:["确认"],callback:function(r){return __awaiter(i,void 0,void 0,function(){return __generator(this,function(i){return h&&r?this.proto(t,e).then(function(t){n(t)}):n({code:o.code||2e3,ret:2e3,msg:"请求接口失败,接口信息 :"+s.cmd+",错误信息："+o.msg}),[2]})})}}):n({code:2e3,ret:2e3,msg:"网络异常，请稍后再试"})}})})},t.prototype.send=function(t){var e=new egret.Timer(1e3*this.timeout,1),i=new egret.Timer(1e3,1),n=!1,o=!1;if("minigame"===Env.app){var r={url:t.url,data:t.data,method:t.method||"GET",dataType:t.httpResponseType||"TEXT",header:{},success:function(r){n||(n=!0,e.stop(),o?Loading.hide():i.stop(),t.success&&t.success(r.data))},fail:function(){n||(n=!0,e.stop(),o?Loading.hide():i.stop(),t.failed&&t.failed({code:2e3,ret:2e3,msg:"io Error,Error Type is "+JSON.stringify(event.type),type:event.type}))}};t.contentType&&(r.header["Content-Type"]=t.contentType),t.httpResponseType&&(r.responseType=t.httpResponseType);var s=wx.request(r)}else{var s=new egret.HttpRequest;s.responseType=t.httpResponseType||egret.HttpResponseType.TEXT,s.withCredentials=void 0!==t.credentials?t.credential:!0,s.open(t.url,t.method||egret.HttpMethod.GET),s.addEventListener(egret.Event.COMPLETE,function(r){var s=r.currentTarget;n||(n=!0,e.stop(),o?Loading.hide():i.stop(),t.success&&t.success(s.response))},this),s.addEventListener(egret.IOErrorEvent.IO_ERROR,function(r){n||(n=!0,e.stop(),o?Loading.hide():i.stop(),t.failed&&t.failed({code:1e3,msg:"io Error,Error Type is "+JSON.stringify(r.type),type:r.type}))},this),t.method&&"post"===t.method.toLowerCase()?s.send(t.data):s.send()}i.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){Loading.show("loadingTime"),o=!0},this),e.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){n||(n=!0,o&&Loading.hide(),t.failed&&t.failed({code:2e3,ret:2e3,msg:"服务器返回超时"}))},this),e.start(),i.start()},t}();t.http=r,__reflect(r.prototype,"Net.http"),t.ws=e;var s=function(){function t(t){void 0===t&&(t=CGI.socket),this.retry=0,this.retrying=!1,this.queue=[],this.waiting=!1,this.loginQueue=[],this.loginWaiting=!1,this.url=t,this.cache={},this.sn=0,this.message=this.message.bind(this),this._close=this._close.bind(this),this.error=this.error.bind(this)}return t.prototype.send=function(t,e){return __awaiter(this,void 0,void 0,function(){var i,n;return __generator(this,function(o){switch(o.label){case 0:return this.status?[3,2]:[4,this.init()];case 1:if(i=o.sent(),0!==i.ret)return[2,i];o.label=2;case 2:return this.logined?[3,4]:[4,this.login()];case 3:if(n=o.sent(),0!==n.ret)return[2,n];o.label=4;case 4:return[2,this._send(t,e)]}})})},t.prototype.close=function(){this.userclose=!0,this.ws.close()},t.prototype.login=function(){var t=this;return new Promise(function(e){return __awaiter(t,void 0,void 0,function(){var t,i,n;return __generator(this,function(o){switch(o.label){case 0:return this.status?[3,2]:[4,this.init()];case 1:if(t=o.sent(),Logger.log(t),0!==t.ret)return[2,e(t)];o.label=2;case 2:return this.loginWaiting?(this.loginQueue.push(e),[3,5]):[3,3];case 3:return this.loginWaiting=!0,[4,this._send("login",{openid:USER.openid,ticket:USER.ticket,app_ticket:USER.encryid,client_info:{}})];case 4:if(i=o.sent(),0===i.ret){if(this.logined=!0,i.data.ticket_expire&&"steam"===Env.app){n=void 0;try{n=localStorage.getItem("steamInfo")?JSON.parse(localStorage.getItem("steamInfo")):null}catch(r){n=null}n&&(n.expireTime=1e3*i.data.ticket_expire+18e5,localStorage.setItem("steamInfo",JSON.stringify(n)))}i.data.server_timestamp&&Time.setDiff(Time.now()-i.data.server_timestamp),i.data.nick?USER.nickname=i.data.nick:Logger.log("没有昵称！")}else localStorage.setItem("steamInfo",JSON.stringify({}));e(i),this.loginQueue.length>0&&(this.loginQueue.forEach(function(t){t(i)}),this.loginQueue=[]),this.loginWaiting=!1,o.label=5;case 5:return[2]}})})})},t.prototype.logout=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.userclose=!0,this.timer&&clearTimeout(this.timer),this.timer=void 0,[4,this._send("logout")];case 1:return t=e.sent(),0===t.ret&&(this.logined=!1,this.close()),[2,t]}})})},t.prototype.errorHandler=function(t){var e=this;this.status=!1,this.logined=!1,Object.keys(this.cache).length>0&&Object.keys(this.cache).forEach(function(t){e.cache[t]&&e.cache[t].resolve({code:2e3,ret:2e3,msg:"请求接口失败,接口信息 :"+e.cache[t].cmd+",错误信息："+event})}),!this.retrying&&!this.userclose&&Widget.pop("PopupDialog",{title:"提示",content:t,button:["确认"],callback:function(t){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(t){return("Skin.VideoView"===Scenes.currentUI||"Skin.EscView"===Scenes.currentUI)&&(Player.exit(),"Skin.EscView"===Scenes.currentUI&&Scenes.exitUI("Skin.EscView")),Scenes.addUI("Skin.LoginView"),[2]})})}}),this.status=!1,this.logined=!1,this.cache={},clearInterval(this.timer),this.timer=0},t.prototype._send=function(t,e){var i=this;return new Promise(function(n,r){var s=o[t]||null;if(!s)return void n({code:1e3,ret:1e3,msg:"未定义的结构体 ,请在 action 里检查定义的结构体"});var a=(s.url,s.timeout),c=s.reviceKey,h=s.retry,u=++i.sn,d=function(){a?i.dialog=Widget.pop("PopupDialog",{title:"提示",content:a,button:h?["点击重试","返回"]:["确认"],sn:u,callback:function(t){return __awaiter(i,void 0,void 0,function(){return __generator(this,function(e){return h&&t?this.ws.send(g):(s.callback&&s.callback(),n({code:2e3,ret:2e3,msg:"请求接口失败,接口信息 :"+s.cmd+",错误信息：网络超时"})),[2]})})}}):(Toast.show("网络异常，请求超时"),n({code:2e3,ret:2e3,msg:"网络异常，请求超时"}))},l=i.msg.create();l.head=i.roots.MsgHead.create({Cmd:i.msg.Cmd_C2G[s.cmd.trim()],openid:USER.openid,pkgSN:u,version_id_str:Env.version}),l.body=i.roots.MsgBody.create(),l.body[s.sendKey]=i.roots[s.struct].create(e);var p=i.msg.verify(l);if(Logger.log("<----------"+s.cmd+"--发包------------->"),Logger.log(l),p)return void n({code:1,ret:1,msg:p});var g=i.msg.encode(l).finish();try{i.ws.send(g)}catch(f){return i.status=!1,i.logined=!1,i.cache={},void d()}if("heartbeat"!==t){var v=new egret.Timer(15e3,1),_=new egret.Timer(1e3,1);v.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){i.cache[u]&&d()},i),_.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){Loading.show()},i),v.start(),_.start(),i.cache[u]={cmd:t,timestamp:Date.now(),resolve:n,buffer:g,retry:h,reviceKey:c,timer:v,loadingTimer:_}}})},t.prototype.reader=function(t){return new Promise(function(e){var i=new FileReader;i.readAsArrayBuffer(t),i.onload=function(t){var n=new Uint8Array(i.result);e(n)}})},t.prototype.message=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,o,r,s,a,c,h,u,d,l,p,g=this;return __generator(this,function(f){switch(f.label){case 0:if(e=t.data,"string"!=typeof e)return[3,1];switch(e=JSON.parse(e),Logger.log(e),e.tws_notify_type){case"pass":this.status=!0,this.queue.forEach(function(t){t.timer&&t.timer.reset(),t.resolve({code:0,ret:0,msg:"Socket Pass"})}),this.queue=[],this.waiting=!1;break;case"queue":break;case"close":this.ws.close(),this.status=!1}return[3,3];case 1:return[4,this.reader(e)];case 2:if(i=f.sent(),o=this.msg.decode(i),r=o.head,s=r.pkgSN,Widget.hasPop(s)&&Widget.closePop(),Logger.log("-------------------------websocket response-----------------------"),Logger.log(o),a=function(t){switch(t){case 10002:RECORD.questinfo=o.body.ntfQuestInfo;break;case 10003:RECORD.personinfo=o.body.person_info_ntf;break;case 10004:RECORD.hiddenstory=o.body.hidden_story_info_ntf;break;case 10005:RECORD.importantevent=o.body.important_event_info_ntf;break;case 10007:2059===r.ret?Login.kickOff():Login.logout();break;case 10006:RECORD.achievement=o.body.achievement_info_ntf;break;case 10010:SHARE.value=o.body.var_list_ntf;break;case 10011:RECORD.redpoint=o.body.red_point_ntf;break;case 10012:var e=o.body.novice_data_ntf;e.is_all?NOVICE=e.novice_map:Object.keys(e.novice_map).map(function(t){var i=NOVICE[t];NOVICE[t]=e.novice_map[t],Logger.log("novice map的"+t+"由"+i+"变成了"+e.novice_map[t])});break;case 10016:o.body.ntfAttrData&&(MALL.flower=o.body.ntfAttrData.flower_count,MALL.egg=o.body.ntfAttrData.egg_count);break;case 10017:o.body.statistics_data_ntf&&(MALL.flowerUsedDay=o.body.statistics_data_ntf.flower_day_count,MALL.flowerUsedWeek=o.body.statistics_data_ntf.flower_week_count,MALL.flowerUsedTotal=o.body.statistics_data_ntf.flower_total_count,MALL.eggUsedDay=o.body.statistics_data_ntf.egg_day_count,MALL.eggUsedWeek=o.body.statistics_data_ntf.egg_week_count,MALL.eggUsedTotal=o.body.statistics_data_ntf.egg_total_count);break;case 10018:o.body.unrecv_confirm_order_ntf&&o.body.unrecv_confirm_order_ntf.item_map&&(UNGET=o.body.unrecv_confirm_order_ntf.item_map);break;case 10019:if(o.body.charpter_switch_ntf&&o.body.charpter_switch_ntf.chapterid){var i=[];o.body.charpter_switch_ntf.chapterid.forEach(function(t){i.push(t-1)}),STORY.chapterUnlock=i}break;case 10026:RECORD.questreward=o.body.quest_reward_ntf;break;case 10028:if(o.body.be_node_id_ntf.be_node_id_list&&o.body.be_node_id_ntf.be_node_id_list.node_id)if(o.body.be_node_id_ntf.is_all)STORY.beBlockid=o.body.be_node_id_ntf.be_node_id_list.node_id.map(function(t){return STORY.node2Block[t]});else{var n=o.body.be_node_id_ntf.be_node_id_list.node_id.map(function(t){return STORY.node2Block[t]});STORY.beBlockid=STORY.beBlockid.concat(n)}}},r.ntf_cmd_list.length>0&&(Logger.log(r.ntf_cmd_list),r.ntf_cmd_list.map(function(t){return a(t)})),this.cache[s])if(c=this.cache[s].reviceKey,h=this.cache[s].resolve,u=this.cache[s].cmd,d=this.cache[s].buffer,l=this.cache[s].timer,p=this.cache[s].loadingTimer,p.running?p.reset():Loading.isShow()&&Loading.hide(),l.running&&l.reset(),0!==r.ret){switch(r.ret){case 2003:Toast.show("正在重连..."),this.send("login").then(function(t){0===t.ret?(l.start(),g.ws.send(d)):(l.stop(),g.cache[s]=void 0,h({code:2e3,ret:2e3,msg:"请求接口失败,接口信息 :"+u+",错误信息：服务端无法重连"}))});break;case 2026:Widget.pop("PopupDialog",{title:"提示",content:"2026 - 章节还未解锁",button:["确认"],callback:function(t){h({code:r.ret,ret:r.ret,msg:r.error_str})}});break;case 2044:h({code:r.ret,ret:r.ret,msg:r.error_str}),Login.logout();break;case 2054:Widget.pop("PopupDialog",{title:"提示",content:"2054 - 客户端版本号有误，请返回steam更新游戏或重新下载",button:["确认"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(t){return this.cache={},this.logout(),LS.set("steamInfo",""),"steam"===Env.app&&Steam.exitGame(),[2]})})}}),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2055:Widget.pop("PopupDialog",{title:"提示",content:"帐号异常，请重新登录Steam",button:["确认"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(t){return this.cache={},Login.logout(),LS.set("steamInfo",""),"steam"===Env.app&&Steam.exitGame(),[2]})})}}),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2059:h({code:r.ret,ret:r.ret,msg:r.error_str}),Login.kickOff();break;case 2049:"Component.PopupGift"==egret.getQualifiedClassName(Widget.currentPop)?Toast.show("重复请求，请稍后再试"):Widget.pop("PopupDialog",{title:"提示",content:"数据异常，请重新启动游戏",button:["确认"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(t){return this.cache={},this.userclose=!0,Login.logout(),h({code:r.ret,ret:r.ret,msg:r.error_str}),[2]})})}});break;case 2060:Toast.show("2060 - 名字包含敏感词汇，请重新输入"),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2061:Toast.show("2061 - 该名字已被使用，请重新输入"),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2070:Widget.pop("PopupDialog",{title:"提示",content:"2070 - 未完待续，预计3月5日前解锁",button:["确认"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(t){return Player.exit(PlayerFlag.PS_Home),Scenes.addUI("Skin.StartView"),[2]})})}}),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2075:Widget.pop("PopupDialog",{title:"提示",content:"2075 - 请前往商店购买DLC并安装",button:["确认","取消"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(e){return t&&(Steam.toSteamStore(),localStorage.setItem("steamInfo","")),localStorage.setItem("steamInfo",""),Player.exit(),Scenes.addUI("Skin.StartView"),[2]})})}}),h({code:r.ret,ret:r.ret,msg:r.error_str});break;case 2076:h({code:r.ret,ret:r.ret,msg:"steam已离线，请登陆后再次尝试"}),Toast.show("2076 - steam已离线，请登陆后再次尝试");break;default:r.error_str&&-1===n.indexOf(r.ret)?Widget.pop("PopupDialog",{title:"提示",content:r.ret+" - "+r.error_str,button:["确认"],callback:function(t){return __awaiter(g,void 0,void 0,function(){return __generator(this,function(t){return h({code:r.ret,ret:r.ret,msg:r.error_str}),[2]})})}}):h({code:r.ret,ret:r.ret,msg:r.error_str})}this.cache[s].timer&&(this.cache[s].timer.reset(),this.cache[s].timer.stop(),this.cache[s].timer=void 0),this.cache[s]=void 0}else h(o.body?{code:0,data:o.body[c],ret:r.ret}:{code:0,ret:r.ret,data:{}}),this.cache[s].timer&&(this.cache[s].timer.reset(),this.cache[s].timer.stop(),this.cache[s].timer=void 0),this.cache[s]=void 0;f.label=3;case 3:return[2]}})})},t.prototype.init=function(){var t=this;return new Promise(function(e,i){var n=protobuf.roots["default"],o=n.deploy;if(!o)return void e({code:1e3,ret:1e3,msg:"未定义命名空间 ,请在 proto 里检查定义的结构体"});if(t.waiting)t.queue.push({resolve:e});else{t.waiting=!0,t.roots=o,t.msg=o.Msg,t.ws=new WebSocket(t.url),t.userclose=!1;var r=new egret.Timer(15e3,1),s=function(i){r.running&&r.reset(),t.ws.removeEventListener("error",s),t.ws.close(),t.ws=void 0,e(i.code||i.data?{code:-1,ret:-1,msg:"网络异常，链接报错，请稍后重试 - "+i.code+" | "+i.data}:{code:-1,ret:-1,msg:"网络异常，链接报错，请稍后重试"}),t.queue.length>0&&t.queue.forEach(function(t){t.timer&&t.timer.reset(),i.code||i.data?t.resolve({code:-1,ret:-1,msg:"网络异常，链接报错，请稍后重试 - "+i.code+"  | "+i.data}):t.resolve({code:-1,ret:-1,msg:"网络异常，链接报错，请稍后重试"})}),i.code||i.data?Toast.show(i.code+" | "+i.data+" - 网络异常，链接报错，请稍后重试"):Toast.show("网络异常，链接报错，请稍后重试"),Loading.hide(),t.queue=[],t.waiting=!1};r.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){t.ws&&t.ws.removeEventListener("error",s),e({code:-1,ret:-1,msg:"网络超时，链接建立失败，请稍后重试"}),t.queue.length>0&&t.queue.forEach(function(t){t.timer&&t.timer.reset(),t.resolve({code:-1,ret:-1,msg:"网络超时，链接建立失败，请稍后重试"})}),t.queue=[],t.waiting=!1},t),t.ws.addEventListener("open",function(){t.queue.push({timestamp:Date.now(),resolve:e,timer:r}),t.ws.removeEventListener("error",s),t.ws.addEventListener("error",t.error),t.ws.addEventListener("message",t.message),t.ws.addEventListener("close",t._close),t.timer&&clearInterval(t.timer),t.timer=setInterval(function(){t.send("heartbeat")},25e3)}),t.ws.addEventListener("error",s),r.start()}})},t.prototype._close=function(t){var e=this,i=t.code;this.ws.close(),this.status=!1,this.logined=!1,this.ws.removeEventListener("error",this.error),this.ws.removeEventListener("message",this.message),this.ws.removeEventListener("close",this._close);var n=i?i+" - 网络异常，链接已断开，请重试 - "+t.reason:"网络异常，请检查网络后重试";Env.getNetwork().then(function(t){Logger.log(t),t?e.retrying||e.userclose||(e.retrying=!0,e.login().then(function(t){e.retrying=!1,0!==t.ret&&(clearInterval(e.timer),e.errorHandler(n))
})):e.errorHandler(n)})},t.prototype.error=function(t){this.status=!1,this.logined=!1,this.errorHandler("网络异常，链接已断开，请稍后再试。")},t}();__reflect(s.prototype,"socket")}(Net||(Net={}));var Notice;!function(t){function e(t){if("number"==typeof t)return t;var e=t.split("-"),i=new Date;return i.setFullYear(parseInt(e.shift())),i.setMonth(parseInt(e.shift())-1),i.setDate(parseInt(e.shift())),i.getTime()}function i(){var t=this;return new Promise(function(e){RES.getResByUrl("https://www.npcstudio.cn/json/notice/data.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})}function n(){return new Promise(function(t){if(0===r.length)t(!0);else{var e=r.pop();Widget.pop("PopupNotice",{title:e.title,content:e.content,callback:function(){n().then(function(){t(!0)})}})}})}function o(){return __awaiter(this,void 0,void 0,function(){var t,o,s;return __generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,i()];case 1:return t=a.sent(),[3,3];case 2:return o=a.sent(),t={notice:[]},[3,3];case 3:return t&&t.notice?(s=Date.now(),r=t.notice.filter(function(t){return t.startTime=e(t.startTime),t.endTime=e(t.endTime),(t.startTime<s||t.startTime==s)&&(t.endTime>s||t.endTime==s)}),[2,n()]):[2,!0]}})})}var r=[];t.init=o}(Notice||(Notice={}));var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.bgLoading=new eui.Rect,e.imgLoading=new eui.Image("bofang_loading_png"),e.textLoading=new eui.Label("0"),e.width=1920,e.height=1080,e.horizontalCenter=0,e.verticalCenter=0,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.width=1920,this.height=1080,this.horizontalCenter=0,this.bgLoading.left=0,this.bgLoading.right=0,this.bgLoading.top=0,this.bgLoading.bottom=0,this.bgLoading.fillAlpha=0,this.bgLoading.touchEnabled=!0,this.bgLoading.width=this.width,this.bgLoading.height=this.height,this.addChild(this.bgLoading),this.imgLoading.verticalCenter=0,this.imgLoading.horizontalCenter=0,egret.Tween.get(this.imgLoading,{loop:!0}).to({rotation:360},4e3),this.addChild(this.imgLoading),this.checkMask()},e.prototype.checkMask=function(){Scenes.currentUI&&(this.bgLoading.visible="Skin.VideoView"==Scenes.currentUI?!1:!0)},e.prototype.onCancel=function(){Loading.hide()},e.prototype.setProgress=function(t,e){this.textLoading.text=Math.floor(t/e*100)+"%"},Object.defineProperty(e.prototype,"text",{set:function(t){this.textLoading.text=t},enumerable:!0,configurable:!0}),e}(eui.Component);__reflect(LoadingUI.prototype,"LoadingUI",["eui.UIComponent","egret.DisplayObject"]);var Pay;!function(t){function e(){n=Env.isDesktop?"//midas.gtimg.cn/midas/minipay_v2/jsapi/cashier.js":"//midas.gtimg.cn/h5pay/js/api/midas.js",Logger.log(n)}function i(t){Env.isMobile?Midas.rechargeGameCurrency({appid:"1450013933",pf:"vip_m-qf-html5",zoneid:"1",n:t,as:1,account:"qq",sandbox:!0,onSuccess:function(){Toast.show("success")},onClose:function(){Toast.show("close")}}):Env.isDesktop&&midas.minipay.buyGame({methods:{onSuccess:function(){}}},{appid:"1450013969",pf:"qq_m_qq-2001-html5-2011-xxxx",zoneid:"1",sandbox:"1",buy_quantity:100,game_type:"default",step:100})}var n;t.init=e,t.Recharge=i}(Pay||(Pay={}));var Coins;!function(t){function e(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return t=Net.ws(),[4,t.send("getcoins")];case 1:return e=i.sent(),0===e.ret&&(MALL.coin=e.data.coins,e.data.base_cfg&&(MALL.reliveCost=e.data.base_cfg.coins_for_resu,MALL.coins2Time=e.data.base_cfg.time_per_coin)),[2]}})})}t.init=e}(Coins||(Coins={}));var Player;!function(t){function e(t){if(void 0===t&&(t=USER.defn),!U)switch(t){case 1:U=new N;break;case 2:case 3:U=new j}return U}function i(){return e().screenshot()}function n(){return e().type}function o(){e().play()}function r(){e().pause()}function s(t){return e().exit(t)}function a(){e().skip()}function c(){return e().choosing}function h(){return!0}function u(){return e().bufferEnd}function d(){return e().status}function l(){return e().isPlaying}function p(){return e().destroy()}function g(t){return e().save(t)}function f(t){return e().listener(t)}function v(t,i){return e().init(t,i)}function _(t){return t?void(e().currentTime=t):e().currentTime}function m(t){e().volume=t}function y(){return e().currentVid}function b(){return e().defn}function S(t){if(t===USER.defn)return Promise.resolve(!0);if(USER.defn=t,"hls"===U.type&&t>1)return e().setDefn(t);var i=U.stage;return U.removeEvent(),U.destroy(),U=null,e().init(i)}function E(){return e().dragStart}function w(){return e().dragEnd}function T(){return e().dragable}function C(){return e().duration}function k(t){return t||0===t?void(e().currentTimeRate=t):e().currentTimeRate}function R(t){return t?void(e().playbackRate=t):e().playbackRate}function O(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,e().checkNetWork()]})})}function P(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(i){return[2,e().complete(t)]})})}function x(){e().clearButton()}var L,U=null,I={},A=[],M=function(t){if(!t)return null;var e=/(\w+)\.(\d+)\.ts\.m3u8/,i=t.match(e);return i?i[1]:null};!function(t){t[t.created=0]="created",t[t.loading=1]="loading",t[t.loaded=2]="loaded",t[t.preloading=3]="preloading",t[t.preloaded=4]="preloaded",t[t.waiting=5]="waiting",t[t.playing=6]="playing",t[t.switching=7]="switching",t[t.paused=8]="paused",t[t.seeking=9]="seeking",t[t.seeked=10]="seeked",t[t.ended=11]="ended",t[t.error=12]="error"}(L||(L={}));var N=function(){function e(t){void 0===t&&(t="MP4"),this.waitingSeek=!1,this.source="MP4",this.idx=0,this.media=document.querySelector("#video"),this.media.crossOrigin="anonymous",this.seekTo=0,this.drag=[],this.pf=5,this.playRate=1,this.defn=USER.defn,this.status=L.created,this.blob={},this.event={},this.queue=new Q.PromiseQueue({concurrency:1}),this.w=WebWorker.fn,this.source=t,this.type="video",this.attachEvent()}return Object.defineProperty(e.prototype,"currentSrc",{get:function(){return this.media.currentSrc},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return Number(Number(this.media.currentTime).toFixed(5))},set:function(t){isNaN(t)||(t=Number(Number(t).toFixed(5)),this.seekTo=t,this.media.currentTime=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentVid",{get:function(){return this.vid},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentTimeRate",{get:function(){return 0===this.duration?0:parseFloat((this.currentTime/this.duration).toFixed(2))},set:function(t){var e;e=1===t||t>1?this.duration-.1:this.duration*t,this.currentTime=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentDefn",{get:function(){return this.defn},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playbackRate",{get:function(){return this.media.playbackRate},set:function(t){t!==this.media.playbackRate&&(this.playRate=t,this.media.playbackRate=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"seekEnd",{get:function(){if(0===this.media.seekable.length)return 0;var t=this.media.seekable.length-1;return this.media.seekable.end(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferEnd",{get:function(){if(0===this.media.buffered.length)return 0;var t=this.media.buffered.length-1;return this.media.buffered.end(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this.media.duration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragStart",{get:function(){return this.drag[0]||0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragEnd",{get:function(){return this.drag[1]||this.duration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragable",{get:function(){var t=this.currentTime;return t>this.dragStart&&t<this.dragEnd},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){return!!(this.currentTime>0&&!this.media.paused&&!this.media.ended&&this.media.readyState>2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.vol},set:function(t){(t||0===t)&&(this.vol=t,this.media.volume=t)},enumerable:!0,configurable:!0}),e.prototype.attachEvent=function(){Events.register(NETWORK.lostWIFI,this.netWorkListener,this),Events.register(NETWORK.out,this.netWorkListener,this),this.timer=new egret.Timer(1e3,0),this.timer.addEventListener(egret.TimerEvent.TIMER,this.handleTimer,this),this.waitingSeekTimer=new egret.Timer(15e3,0),this.waitingSeekTimer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.handleWaitingSeek,this),this.handleEnd=this.handleEnd.bind(this),this.handleWaiting=this.handleWaiting.bind(this),this.errorListener=this.errorListener.bind(this),this.attachMedia(this.media)},e.prototype.removeEvent=function(){Events.remove(NETWORK.lostWIFI,this.netWorkListener,this),Events.remove(NETWORK.out,this.netWorkListener,this),this.timer.removeEventListener(egret.TimerEvent.TIMER,this.handleTimer,this),this.waitingSeekTimer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.handleWaitingSeek,this),this.media.removeEventListener("ended",this.handleEnd),this.media.removeEventListener("waiting",this.handleWaiting),this.removeRender()},e.prototype.init=function(t,e){return void 0===e&&(e={cmd:"choice",data:{choice:-1,idx:0}}),__awaiter(this,void 0,void 0,function(){var i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return this.stage=t,i=e.cmd,n=e.data,Loading.show(),[4,this.send(e.cmd,e.data)];case 1:if(o=a.sent(),!o)return[3,9];switch(r=e.cmd){case"beginfrom":return[3,2];case"choice":return[3,4];case"revive":return[3,6]}return[3,8];case 2:return[4,this.beginfrom(o)];case 3:return a.sent(),[3,8];case 4:return[4,this.choice(o)];case 5:return a.sent(),[3,8];case 6:return[4,this.revive(o)];case 7:return a.sent(),[3,8];case 8:return[2,!0];case 9:return Toast.inShow()||Widget.hasPop()||(s=o&&o.ret?o.ret+" - 网络异常，请求超时":"网络异常，请求超时",Toast.show(s)),[2,!1]}})})},e.prototype.play=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r=this;return __generator(this,function(s){switch(s.label){case 0:return t=function(e){return void 0===e&&(e=0),new Promise(function(i){if(e)setTimeout(function(){t(0).then(function(t){i(t)})},e);else{var n=r.media.play();void 0!==n?n.then(function(){i(!0)})["catch"](function(t){Logger.error(t),i(!1)}):i(!0)}})},e=function(){egret.startTick(r.heartbeat,r),r.render&&r.render.play(),r.stage.playAction(),r.playWaiting=!1,r.status=L.playing,r.save(PlayerFlag.PS_Start)},i=function(){Logger.error(r.media.error),r.playWaiting=!1,r.errorListener(4)},this.playWaiting?[2,!0]:(this.playWaiting=!0,[4,t()]);case 1:return(n=s.sent())?(e(),[2,!0]):[3,2];case 2:return this.media.error?(i(),[2,!1]):[3,3];case 3:return Loading.show(),[4,t(50)];case 4:return o=s.sent(),console.log("----------> retry "+o),o?e():i(),[2,o]}})})},e.prototype.pause=function(t){return void 0===t&&(t=!0),__awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){return this.pauseTimer?[2]:this.playWaiting?(this.pauseTimer=setTimeout(function(){e.playWaiting||e.pause(),e.pauseTimer=void 0},10),[2]):(this.media.pause(),t&&this.save(PlayerFlag.PS_Pause),egret.stopTick(this.heartbeat,this),this.render&&this.render.pause(),this.timer.running&&(this.timer.reset(),this.timer.stop(),Widget.closePop()),this.status=L.paused,this.stage.pauseAction(),[2,!0])})})},e.prototype.checkNetWork=function(){return new Promise(function(t){Env.getNetwork().then(function(e){1===e||USER.use4G&&(3===e||4===e)?t(!0):0===e||5===e?Widget.pop("PopupDialog",{content:"您现在没有网络连接，请打开网络连接后再尝试。",button:["确定"],callback:function(e){t(!1)}}):Widget.pop("PopupDialog",{content:"您现在处于"+e+"G网络状态，观看将会耗费流量。",button:["继续观看","取消"],callback:function(e){e&&(USER.use4G=!0,t(!0))}})})})},e.prototype.skip=function(t,e){if(void 0===t&&(t=STORY.blockid),void 0===e&&(e=STORY.nodeid),this.checkNode(t,e)){var i=this.event[e+"@ended"];i&&i.length>0&&(this.currentTime=this.duration-1),this.save(PlayerFlag.PS_Jump),!this.isPlaying&&this.play()}else!this.choosing&&Toast.show("曾经看完过的视频才能使用跳过功能")},e.prototype.save=function(t,e){return void 0===t&&(t=PlayerFlag.PS_NULL),void 0===e&&(e=3),__awaiter(this,void 0,void 0,function(){var i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return 0>=e?[2]:(Logger.log("savegame ---- "+t),i=STORY.blockid,n=STORY.nodeid,i&&n?(t!==PlayerFlag.PS_Start&&t!==PlayerFlag.PS_Home&&t!==PlayerFlag.PS_Story||-1!==STORY.allPath.indexOf(i)||STORY.addUndoneNode(i),o=Net.ws(),[4,o.send("savegame",{last_play_time:this.currentTime,cur_play_block:i,block_played:[i],cur_play_node:n,node_played:[n],flag:t})]):[2]);case 1:return r=a.sent(),0===r.ret?(Logger.log("blockid = "+i+"执行上报成功"),s=r.data?r.data.complete_percent:{},s&&s.chapter_percent&&s.chapter_percent.length>0&&(STORY.exportData=s.chapter_percent),s&&s.whole_percent&&(STORY.exportData=[{chapter_id:"global",chapter_percent:s.whole_percent}]),(t===PlayerFlag.PS_Finish||t===PlayerFlag.PS_Home||t===PlayerFlag.PS_Story)&&(-1===STORY.allPath.indexOf(i)&&STORY.allPath.push(i),t===PlayerFlag.PS_Finish&&STORY.removeUndoneNode(i)),r.data&&r.data.total_online_count&&(PROMPT.concurrentusers=r.data.total_online_count),[2,r.data]):(this.save(t,--e),[2,!1])}})})},e.prototype.complete=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,o,o;return __generator(this,function(r){switch(r.label){case 0:return t.blockid&&(STORY.blockid=t.blockid),t.nodeid&&(STORY.nodeid=t.nodeid),[4,this.save(PlayerFlag.PS_Finish)];case 1:return(e=r.sent())?(this.stage.keyboard=!0,i=e.show_type,n=!1,1!==t.type?[3,4]:[4,STORY.blockInfo(STORY.blockid)]):[3,10];case 2:return o=r.sent(),[4,Scenes.addUI("Skin.BadEndView",{data:o,showType:i})];case 3:return n=r.sent(),[3,9];case 4:return 0!==t.type?[3,6]:[4,Scenes.addUI("Skin.GoodEndView",{id:STORY.chapterid,type:t.type,showType:i})];case 5:return n=r.sent(),[3,9];case 6:return 2!==t.type?[3,9]:[4,STORY.blockInfo(STORY.blockid)];case 7:return o=r.sent(),[4,Scenes.addUI("Skin.StoryEndView",{data:o,showType:i,id:STORY.chapterid})];case 8:n=r.sent(),r.label=9;case 9:return n?(this.isPlaying&&this.pause(),this.stage.clearButton(),[2,!0]):(this.exit(PlayerFlag.PS_Home),[2,!1]);case 10:return[2,!1];case 11:return[2]}})})},e.prototype.exit=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.media.src&&this.currentTime&&(STORY.lastPlayTime=this.currentTime),this.destroy(),t?[4,this.save(t)]:[3,2];case 1:e.sent(),e.label=2;case 2:return Events.dispatch("playerEvents",{channel:"exit"}),"Skin.EscView"!==Scenes.currentUI?[3,4]:[4,Scenes.exitUI("Skin.EscView")];case 3:e.sent(),e.label=4;case 4:return[2,Scenes.exitUI("Skin.VideoView")]}})})},e.prototype.removeRender=function(){this.render&&(this.stage.removeChild(this.render),this.render=void 0)},e.prototype.destroy=function(){this.media.src&&this.currentTime&&(STORY.lastPlayTime=this.currentTime),this.playbackRate=1,egret.stopTick(this.heartbeat,this),this.render&&(this.render.pause(),this.render.visible=!1),this.stage.pauseAction(),this.media.pause(),this.media.src="",this.status=L.created,this.event={},this.clear(),I={},this.timer&&(this.timer.reset(),this.timer.stop()),this.queue.clear(),this.w.clear(),this.stage&&this.stage.clear()},e.prototype.clearButton=function(){this.stage.clearButton()},e.prototype.setDefn=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return this.defn===t?[2]:(Loading.show(),STORY.lastPlayTime=this.currentTime,this.defn=USER.defn=t,this.pause(),this.media.src="",this.status=L.created,this.event={},this.clear(),I={},this.render.visible=!1,this.timer.reset(),this.timer.running&&this.timer.stop(),this.queue.clear(),this.w.clear(),[4,this.init(this.stage)]);case 1:return e=i.sent(),e&&Loading.hide(),[2,e]}})})},e.prototype.listener=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,o,r,s,a=this;return __generator(this,function(c){switch(c.label){case 0:switch(e=t.events,e&&e.destroy&&e.destroy.length>0&&e.destroy.forEach(function(t){a.unregister("playing",t.time)}),e&&e.action&&e.action.length>0&&e.action.forEach(function(t){!t.time&&!t.after||t.time&&Math.abs(t.time-a.currentTime)<.04||t.after&&a.currentTime>t.after?a.action(t):t.time?a.register(t):t.after&&setTimeout(function(){a.action(t)},1e3*(t.after-a.currentTime))}),this.w.clear(),this.queue.clear(),this.clear("-"+STORY.nodeid),i=t.channel){case"beginfrom":return[3,1];case"choice":return[3,5];case"revive":return[3,7];case"next":return[3,11]}return[3,15];case 1:return this.destroy(),[4,this.send("beginfrom",{block_id:t.id})];case 2:return n=c.sent(),n?[4,this.beginfrom(n)]:[3,4];case 3:return[2,c.sent()];case 4:return[2,!1];case 5:return[4,this.send("choice",{choice:t.id,idx:t.idx})];case 6:return o=c.sent(),o?(this.save(PlayerFlag.PS_Start),this.reset(o),[2,!0]):[2,!1];case 7:return this.destroy(),[4,this.send("revive",{pf:this.pf,defn:this.defn,order_id:t.orderid})];case 8:return r=c.sent(),r?[4,this.revive(r)]:[3,10];case 9:return[2,c.sent()];case 10:return[2,!1];case 11:return[4,this.send("choice",{choice:-1,idx:0})];case 12:return s=c.sent(),s?[4,this.choice(s)]:[3,14];case 13:return[2,c.sent()];case 14:return[2,!1];case 15:return[2]}})})},e.prototype.screenshot=function(){return this.render.bitmapData},e.prototype.initRender=function(){this.render?(this.render["switch"](this.media),this.render.visible=!0):(this.render=new egret.iVideo(this.media),this.render.width=this.stage.width,this.render.height=this.stage.height,this.stage.addChildAt(this.render,1))},e.prototype.attachMedia=function(t){t.addEventListener("ended",this.handleEnd),t.addEventListener("waiting",this.handleWaiting)},e.prototype.heartbeat=function(t){var e=this;if(this.isPlaying){Loading.isShow()&&Loading.hide(),this.timer.running&&(this.timer.reset(),this.timer.stop()),this.stage.errorStatus&&this.stage.removeVideoError(),this.waitingSeekTimer.running&&this.waitingSeekTimer.reset(),this.waitingSeek&&(this.waitingSeek=!1),this.render&&this.render.visible||this.initRender(),this.render.running()||this.render.play(),this.status=L.playing;var i=this.event[STORY.nodeid+"@playing"];return i&&i.length>0&&i.forEach(function(t){var i=Env.andriod?.2:1/30;!t.status&&(e.currentTime>t.time||e.currentTime<t.time&&e.currentTime+i>t.time)&&(e.action(t),t.status=!0)}),!0}return!this.media.paused||this.media.ended||this.media.error||this.play(),!1},e.prototype.reset=function(t){var e=this;return this.event={},t.event.forEach(function(t){e.register(t)}),!0},e.prototype.format=function(e){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s,a,c,h,u,d,l,p,g,f,v,_,m,y,b,S,E,w,T,C,k,R,O,P,x,L,U,I=this;return __generator(this,function(A){switch(A.label){case 0:return this.idx=e.idx,i=STORY.chapterInfo(STORY.chapterid),n=i&&"steam"===Env.app,n?[4,DLC.checkChapter(i.index)]:[3,2];case 1:n=!A.sent(),A.label=2;case 2:if(n)return Widget.pop("PopupDialog",{title:"提示",content:"请前往商店购买并安装",button:["确认","取消"],callback:function(e){return __awaiter(I,void 0,void 0,function(){return __generator(this,function(i){return e&&Steam.toSteamStore(),t.exit(PlayerFlag.PS_Home),Scenes.addUI("Skin.StartView"),[2]})})}}),[2,null];if(!e.button_control)return[3,11];for(o={drag:[],node:[],event:[]},r=e.button_control,s=!1,a="","MP4"===this.source?(r.mcache_node&&r.mcache_node.length>0&&r.mcache_node.forEach(function(t){t.m3u8&&t.m3u8_md5&&(t.m3u8="https://www.npcstudio.cn/videos/dev/"+t.m3u8_md5)}),r.button_info&&r.button_info.buttons&&r.button_info.buttons.length>0&&r.button_info.buttons.forEach(function(t){t.m3u8&&t.m3u8_md5&&(t.m3u8="https://www.npcstudio.cn/videos/dev/"+t.m3u8_md5)})):(r.mcache_node&&r.mcache_node.length>0&&r.mcache_node.forEach(function(t){t.vedio_info&&t.vedio_info.url&&(t.m3u8=t.vedio_info.url.pop())}),r.button_info&&r.button_info.buttons&&r.button_info.buttons.length>0&&r.button_info.buttons.forEach(function(t){t.vedio_info&&t.vedio_info.url&&(t.m3u8=t.vedio_info.url.pop())})),c=0,h=r.mcache_node.length;h>c;c++)u=r.mcache_node[c],!u.m3u8&&u.blockid&&u.node_id?(-1===STORY.allPath.indexOf(u.blockid)&&STORY.allPath.push(u.blockid),d=Net.ws(),d.send("savegame",{last_play_time:0,cur_play_block:u.blockid,cur_play_node:u.node_id,block_played:[u.blockid],node_played:[u.node_id],flag:PlayerFlag.PS_Finish})):(o.node.push({m3u8:u.m3u8,duration:u.duration,blockid:u.blockid,nodeid:u.node_id}),u.vedio_info&&u.vedio_info.url&&u.vedio_info.ppic?(l=M(u.vedio_info.url[0]),o.event.push({type:"playing",blockid:u.blockid,nodeid:u.node_id,data:{time:0,action:"thumb",data:Object.assign({vid:l},u.vedio_info.ppic)}})):(s=!0,a="没有找到视频地址"),u.chapter_id!==STORY.chapterid&&o.event.push({type:"playing",blockid:u.blockid,nodeid:u.node_id,data:{time:0,action:"updateChapter",chapterid:u.chapter_id}}));if(p=o.node.length,0===p)return[2,null];g=o.node[p-1],f=g.blockid,v=g.nodeid,_=o.node[0],m=p>2?o.node[p-2]:_,p>1&&o.event.push({type:"playing",blockid:_.blockid,nodeid:_.nodeid,data:{time:5,action:"preload",blockid:u.blockid,node:o.node.slice(1,p)}}),y=0,b=o.node.length,A.label=3;case 3:return b>y?(S=o.node[y],E=o.node[y+1],E?[4,Component.QTECheck(S.blockid,S.nodeid)]:[3,5]):[3,6];case 4:w=A.sent(),w?(T={succ:{action:[],destroy:[]},fail:{action:[],destroy:[]}},T.succ.action.push({action:"switch",blockid:E.blockid,nodeid:E.nodeid,m3u8:E.m3u8,autoPlay:!0}),o.event.push({type:"playing",blockid:w.blockid,nodeid:w.nodeid,data:{action:"qte",time:0,info:w,events:T}}),o.event.push({type:"ended",blockid:w.blockid,nodeid:w.nodeid,data:{action:"loop",loop:!0}})):o.event.push({type:"ended",blockid:S.blockid,nodeid:S.nodeid,data:{action:"switch",blockid:E.blockid,nodeid:E.nodeid,m3u8:E.m3u8,autoPlay:!0}}),A.label=5;case 5:return y++,[3,3];case 6:return r.button_info&&r.button_info.buttons&&r.button_info.buttons.length>0?(C=r.button_info,k=[],R={},O="textChoice",r.button_info.limit_time>0&&(-1===r.button_info.default_button&&(r.button_info.default_button=0),O="timeChoice"),[4,Component.QTECheck(f,v)]):[3,8];case 7:P=A.sent(),P&&(P.buttons?(x=[],r.button_info.buttons.forEach(function(t,e){r.button_info.buttons[e]=Object.assign(P.buttons[e],t),t.imgage&&x.push(t.imgage)}),O="imageChoice",x.length>0&&x.forEach(function(t){t&&RES.getResByUrl("https://www.npcstudio.cn/images/qte/"+t,function(){},I)})):O="qteChoice"),"qteChoice"===O?(R={succ:{action:[],destroy:[]},fail:{action:[],destroy:[]}},C.buttons.forEach(function(t,e){var i=t.blockid,n=t.node_id;if(t.nodeid=n,0===e){if(R.succ.action.push({action:"switch",blockid:i,nodeid:n,m3u8:t.m3u8,autoPlay:!1}),t.vedio_info&&t.vedio_info.url&&t.vedio_info.ppic){var o=M(t.vedio_info.url[0]);R.succ.action.push({action:"thumb",blockid:i,nodeid:n,data:Object.assign({vid:o},t.vedio_info.ppic)})}k.push({blockid:i,nodeid:n,m3u8:t.m3u8})}else if(1===e){if(R.fail.action.push({action:"switch",blockid:i,nodeid:n,m3u8:t.m3u8,autoPlay:!1}),t.vedio_info&&t.vedio_info.url&&t.vedio_info.ppic){var o=M(t.vedio_info.url[0]);R.fail.action.push({action:"thumb",blockid:i,nodeid:n,data:Object.assign({vid:o},t.vedio_info.ppic)})}k.push({blockid:i,nodeid:n,m3u8:t.m3u8})}})):C.buttons.forEach(function(t){var e=t.blockid,i=t.node_id;if(t.nodeid=i,R[i]={action:[],destroy:[]},R[i].action.push({action:"switch",blockid:e,nodeid:i,m3u8:t.m3u8,autoPlay:!1}),t.vedio_info&&t.vedio_info.url&&t.vedio_info.ppic){var n=M(t.vedio_info.url[0]);R[i].action.push({action:"thumb",blockid:e,nodeid:i,data:Object.assign({vid:n},t.vedio_info.ppic)})}k.push({blockid:e,nodeid:i,m3u8:t.m3u8})}),o.event.push({type:"playing",blockid:m.blockid,nodeid:m.nodeid,data:{time:5,action:"preload",node:k}}),L=C.show_time,L>10?(L=L,o.event.push({type:"playing",blockid:f,nodeid:v,data:{time:L,idx:this.idx+1,action:O,events:R,info:C}}),o.event.push({type:"playing",blockid:f,nodeid:v,data:{action:"pause",time:C.deadline-2}})):(o.event.push({type:"playing",blockid:f,nodeid:v,data:{time:0,idx:this.idx+1,action:O,events:R,info:C,qte:P}}),o.event.push({type:"ended",blockid:f,nodeid:v,data:{action:"loop",loop:!0}})),A.label=8;case 8:return r.is_end?[4,STORY.blockInfo(f)]:[3,10];case 9:U=A.sent(),o.event.push({type:"ended",blockid:f,nodeid:v,data:{action:0!==r.end_type&&2!==r.end_type||!U.cmd||-1===U.cmd.indexOf("ConfirmAtEnd")?"complete":"confirm",type:r.end_type,blockid:g.blockid,confirmMsg:U.confirmMsg}}),A.label=10;case 10:return[2,o];case 11:return[2]}})})},e.prototype.preload=function(t){var e=this;if(this.status>L.loaded){t.map(function(t){var i=t.m3u8,n=t.nodeid;e.queue.add(function(){return new Promise(function(t){e.w.loader(i,n).then(function(i){i&&i.nodeid&&i.blob&&(Logger.info(i.nodeid+"-->完成"),e.blob[i.nodeid]={status:"done",data:i.blob}),t(!0)})})})});Logger.log(this.queue)}},e.prototype.send=function(t,e){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s,a=this;return __generator(this,function(c){switch(c.label){case 0:return Logger.log("开始请求后台---命令字=>"+t),i=performance.now(),n=Net.ws(),[4,n.send(t,Object.assign({defn:this.defn,pf:this.pf},e))];case 1:return o=c.sent(),0!==o.ret?[3,8]:(r=o.data,"choice"!==t?[3,3]:[4,this.format(r)]);case 2:return[2,c.sent()];case 3:return"beginfrom"!==t?[3,5]:(r.chapter_id&&STORY.chapterid!==r.chapter_id&&(STORY.chapterid=r.chapter_id,this.stage.updataChapter()),r.change_value&&A.push({change:!0}),[4,this.format(r.resCSStoryChoose)]);case 4:return[2,c.sent()];case 5:return"revive"!==t?[3,7]:(MALL.coin=r.currencnt_coins||0,A.push({dead:r.dead_reson}),[4,this.format(r.resCSStoryChoose)]);case 6:return[2,c.sent()];case 7:return[3,13];case 8:switch(Loading.hide(),s=o.ret){case 2e3:return[3,9];case 2026:return[3,10]}return[3,12];case 9:return"choice"===t&&this.idx>0?(this.isPlaying&&this.pause(),Widget.pop("PopupDialog",{title:"提示",content:"选项数据异常，请重新播放",button:["确认"],callback:function(t){return __awaiter(a,void 0,void 0,function(){return __generator(this,function(t){return this.exit(PlayerFlag.PS_Home),[2]})})}})):(Toast.show("网络异常，请求超时"),this.exit(PlayerFlag.PS_Home)),[3,12];case 10:return[4,Scenes.addUI("Skin.ChapterView",{openChapter:e.block_id})];case 11:return c.sent(),this.exit(PlayerFlag.PS_Story),[3,12];case 12:return[2,null];case 13:return Logger.log("后台耗时为=>"+(performance.now()-i)),[2]}})})},e.prototype.load=function(t,e){var i=this;return void 0===e&&(e=this.dragStart),new Promise(function(n,o){var r=new egret.Timer(15e3,1);i.status=L.loading,e=Number(e.toFixed(5)),i.media.crossOrigin="anonymous",i.media.src=t,i.media.volume=i.vol=USER.volume,i.media.playbackRate=i.playRate,i.checkNode(STORY.blockid,STORY.nodeid),r.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){i.media.removeEventListener("loadedmetadata",s),i.media.removeEventListener("timeupdate",a),Toast.show("网络异常，无法加载视频，请重新尝试"),i.exit(),n({code:-1,result:!1})},i);var s=function(){i.media.removeEventListener("loadedmetadata",s),i.media.removeEventListener("timeupdate",a),(e+1>=i.duration||!i.duration||i.choosing)&&(e=0),i.media.currentTime=e,i.status=L.loaded,r.reset(),r.stop(),n({code:0,result:!0,time:e})},a=function(){i.duration&&(i.media.removeEventListener("loadedmetadata",s),i.media.removeEventListener("timeupdate",a),(e+1>=i.duration||!i.duration||i.choosing)&&(e=0),i.media.currentTime=e,i.status=L.loaded,r.reset(),r.stop(),n({code:0,result:!0,time:e}))};i.media.addEventListener("loadedmetadata",s),i.media.addEventListener("timeupdate",a),r.start(),i.media.load(),i.stage.initRate()})},e.prototype.netWorkListener=function(t){var e=this;if("Skin.VideoView"===Scenes.currentUI){var i=t.data,n=i.state;this.pause(),0===n||USER.use4G||Widget.pop("PopupDialog",{content:"网络发生变化，您目前是"+n+"G网络，继续游戏将会耗费流量。",button:["继续观看","退出"],callback:function(t){t?(e.play(),USER.use4G=!0):e.exit(PlayerFlag.PS_Home)}})}},e.prototype.errorListener=function(t){switch(this.status=L.error,t){case 0:this.pause(),this.stage.videoError("网络连接失败，请稍后重试");break;case 1:this.pause(),this.stage.videoError("网络异常，无法加载视频，请重新尝试");break;case 2:this.stage.onTips("网络不太好，尝试暂停一下加载后再看");break;case 3:this.stage.onTips("当前网络不稳定，建议使用网络诊断");break;case 4:this.pause(),this.stage.videoError("视频加载失败，请稍后重试");break;default:this.pause(),this.stage.videoError("视频加载失败，请稍后重试")}},e.prototype.checkNode=function(t,e){void 0===t&&(t=STORY.blockid),void 0===e&&(e=STORY.nodeid);var i=[];this.event[e+"@playing"]&&(i=i.concat(this.event[e+"@playing"])),this.event[e+"@ended"]&&(i=i.concat(this.event[e+"@ended"]));var n=i.some(function(t){return"qte"===t.action||"textChoice"===t.action||"imageChoice"===t.action||"timeChoice"===t.action||"qteChoice"===t.action});return this.choosing=n,Logger.log(e+" 判断是否为特殊节点 = "+n),this.stage.displayControl(!n),STORY.allPath.indexOf(t)>-1?(this.stage.btnSkipStatus=!n,n?this.stage.hideSkip():this.stage.showSkip(),!n):(Logger.log(t+" 全新节点"),this.stage.btnSkipStatus=!1,this.stage.hideSkip(),!1)},e.prototype.register=function(t){var e=t.nodeid,i=t.type;this.event[e+"@"+i]||(this.event[e+"@"+i]=[]),this.event[e+"@"+i].push(t.data)},e.prototype.unregister=function(t,e){var i=-1,n=this.event[t];if(n&&n.lenght>0)for(var o=0,r=n;r>o;o++)if(n[o].time===e){i=o;break}i>-1&&n.splice(i,1)},e.prototype.action=function(t){var e=t.action;switch(Logger.log(t),e){case"pause":Logger.log("action",this.currentTime+" - 执行暂停操作"),this.pause();break;case"seek":var i=Number(Number(t.seekTo).toFixed(5));Logger.log("action",this.currentTime+" - 执行跳转至"+t.seekTo+" --- 实际调整时间为"+i),this.currentTime=t.seekTo;break;case"preload":this.preload(t.node);break;case"loop":Logger.log("action",this.currentTime+" - 执行循环"),this.currentTime=0,this.media.paused&&this.media.play();break;case"switch":Logger.log("action",this.currentTime+" - 执行切换操作"),this["switch"]({blockid:t.blockid,nodeid:t.nodeid,m3u8:t.m3u8,autoPlay:t.autoPlay});break;case"reset":Logger.log("action",this.currentTime+" - 执行换片操作"),this.reset(this.next);break;case"textChoice":Logger.log("action",this.currentTime+" - 执行显示按钮"),Events.dispatch("playerEvents",t),this.stage.showTextChoice(t);break;case"qteChoice":Logger.log("action",this.currentTime+" - 执行显示按钮"),Events.dispatch("playerEvents",t),this.stage.showQTEChoice(t);break;case"imageChoice":Logger.log("action",this.currentTime+" - 执行显示按钮"),Events.dispatch("playerEvents",t),this.stage.showImageChoice(t);break;case"timeChoice":Logger.log("action",this.currentTime+" - 执行显示按钮"),Events.dispatch("playerEvents",t),this.stage.showTimeChoice(t);break;case"confirm":Logger.log("action","执行确认按钮"),this.media.pause(),this.stage.showConfirmButton(t);break;case"qte":Logger.log("action",this.currentTime+" - 执行qte按钮"),Events.dispatch("playerEvents",t),this.stage.showQTE(t);break;case"hide":Logger.log("action",this.currentTime+" - 执行隐藏按钮"),Events.dispatch("playerEvents",{data:t});break;case"vibrate":Logger.log("action",this.currentTime+" - 执行\b震动"),Vibrator.start(t.timeout);break;case"audio":Logger.log("action",this.currentTime+" - 执行播放音效"),Effect.play(t.audio);break;case"save":Logger.log("action",this.currentTime+" - 执行保存上报 blockid = "+t.blockid),this.save(PlayerFlag.PS_Finish);break;case"complete":Logger.log("action",this.currentTime+" - 执行章节结算"),this.media.pause(),this.complete(t);break;case"thumb":Logger.log("action",this.currentTime+" - 执行加载预览图"),Thumb.init(t.data);break;case"updateChapter":Logger.log("action"," 执行更新章节id"),STORY.chapterid=t.chapterid,this.stage.updataChapter()}},e.prototype.choice=function(t){var e=this;return new Promise(function(i){if(e.reset(t),t.node&&t.node.length>0){var n=-1,o=0;t.node.forEach(function(t,e){STORY.nodeid&&t.nodeid===STORY.nodeid&&(n=e,o=STORY.lastPlayTime)});var r=void 0;n>0?(r=t.node[n],t.node=t.node.filter(function(t,e){return e>=n})):r=t.node.shift(),STORY.blockid=r.blockid,STORY.nodeid=r.nodeid,e.load(r.m3u8,o).then(function(t){0===t.code?(e.initRender(),!e.isPlaying&&e.play().then(function(o){o?(Loading.hide(),n>-1&&t.time>0&&!e.choosing&&e.stage.showContiue(t.time),i(!0)):i(!1)
})):(Loading.hide(),e.errorListener(0),i(!1))})}})},e.prototype.revive=function(t){var e=this;return new Promise(function(i){Loading.show(),e.reset(t);var n=t.node.shift();e.vid=M(n.m3u8),n.blockid&&(STORY.blockid=n.blockid,STORY.nodeid=n.nodeid),e.load(n.m3u8).then(function(t){0===t.code?(Loading.hide(),e.initRender(),!e.isPlaying&&e.play().then(function(t){t?(A.length>0&&e.stage.changeTips(A.pop()),i(!0)):i(!1)})):(Loading.hide(),e.errorListener(0),i(!1))})})},e.prototype.beginfrom=function(t){var e=this;return new Promise(function(i){Loading.show(),e.reset(t);var n=t.node.shift();e.src=n.m3u8,STORY.blockid=n.blockid,STORY.nodeid=n.nodeid,e.load(n.m3u8).then(function(t){0===t.code?(Loading.hide(),e.initRender(),!e.isPlaying&&e.play().then(function(t){t?(A.length>0&&e.stage.changeTips(A.pop()),i(!0)):i(!1)})):(Loading.hide(),e.errorListener(0),i(!1))})})},e.prototype["switch"]=function(t){var e=t.blockid,i=t.nodeid,n=(t.m3u8,t.autoPlay);this.status=L.switching,this.save(PlayerFlag.PS_Finish),this.media.crossOrigin="anonymous",i&&this.blob[i]&&"done"===this.blob[i].status&&!Env.andriod?this.media.src=this.blob[i].data:(Logger.log("没有预下载成功，使用原始地址"),this.media.src=t.m3u8,this.w.clear(i)),this.playbackRate=this.playRate,this.volume=this.vol,n&&this.play(),this.clear(STORY.nodeid),this.status=L.playing,STORY.blockid=e,STORY.nodeid=i,n&&this.save(PlayerFlag.PS_Start),this.checkNode(STORY.blockid,STORY.nodeid)},e.prototype.clear=function(t){var e=this;t?0===t.indexOf("-")?(t=t.slice(1,t.length),Object.keys(this.blob).forEach(function(i){i!==t&&e.blob[i]&&(e.blob[i].data&&e.w.revokeObjectURL(e.blob[i].data),e.blob[i]=void 0)})):this.blob[t]&&(this.blob[t].data&&this.w.revokeObjectURL(this.blob[STORY.nodeid].data),this.blob[t]=void 0):(Object.keys(this.blob).forEach(function(t){e.blob[t]&&(e.blob[t].data&&e.w.revokeObjectURL(e.blob[t].data),e.blob[t]=void 0)}),this.blob={})},e.prototype.handleEnd=function(){var t=this,e=this.event[STORY.nodeid+"@ended"];e&&e.length>0?e.forEach(function(e){Logger.log("执行事件列表->"+JSON.stringify(e)),t.action(e)}):Toast.show("没有找到对应的节点事件 - id = "+STORY.nodeid)},e.prototype.handleWaiting=function(){Logger.log("handleWaiting"),this.status!==L.waiting&&"Skin.VideoView"===Scenes.currentUI&&(this.status=L.waiting,this.timer.running&&this.timer.reset(),this.timer.start()),this.waitingSeek||(this.waitingSeekTimer.reset(),this.waitingSeekTimer.start()),Loading.isShow()&&Loading.reset()},e.prototype.handleWaitingSeek=function(){Logger.log("handleWaitingSeek"),this.waitingSeek||(this.media.currentTime+=.1,this.waitingSeek=!0)},e.prototype.handleTimer=function(){var t=this.timer.currentCount;switch(t){case 3:Loading.show();break;case 10:this.errorListener(2);break;case 20:this.errorListener(3);break;case 90:this.errorListener(4)}},e}();__reflect(N.prototype,"video");var D=function(t){function e(){var e=t.call(this)||this;return e.clone=document.querySelector("#video_clone"),e.attachMedia(e.clone),e.type="mulit",e}return __extends(e,t),e.prototype["switch"]=function(t){var e=t.blockid,i=t.nodeid,n=(t.m3u8,t.autoPlay);if(this.status=L.switching,this.save(PlayerFlag.PS_Finish),this.clone.getAttribute("data-nodeid")===i){var o=this.media;this.media=this.clone,this.clone=o,this.clone.src="",this.clone.removeAttribute("data-nodeid")}else i&&this.blob[i]&&"done"===this.blob[i].status&&!Env.andriod?(this.media.src=this.blob[i].data,this.media.setAttribute("data-nodeid",i)):(this.media.src=t.m3u8,this.media.setAttribute("data-nodeid",i),this.w.clear(i));this.render["switch"](this.media),this.playbackRate=this.playRate,this.volume=this.vol,n&&this.play(),n&&this.save(PlayerFlag.PS_Start),this.clear(STORY.nodeid),STORY.blockid=e,STORY.nodeid=i,this.status=L.playing,this.checkNode(STORY.blockid,STORY.nodeid)},e.prototype.loadNext=function(t){var e=(t.blockid,t.nodeid),i=t.m3u8;this.blob[e]&&"done"===this.blob[e].status?this.clone.src=this.blob[e].data:this.clone.src=i,this.clone.setAttribute("data-nodeid",e),this.clone.load()},e.prototype.action=function(e){var i=e.action;"loadNext"===i?this.loadNext({blockid:e.blockid,nodeid:e.nodeid,m3u8:e.m3u8,autoPlay:e.autoPlay}):t.prototype.action.call(this,e)},e.prototype.format=function(e){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return[4,t.prototype.format.call(this,e)];case 1:if(i=a.sent()){for(n=0,o=i.node.length;o>n;n++)r=i.node[n],s=i.node[n+1],s&&i.event.push({type:"playing",blockid:r.blockid,nodeid:r.nodeid,data:{time:5,action:"loadNext",blockid:s.blockid,nodeid:s.nodeid,m3u8:s.m3u8}});return[2,i]}return[2,!1]}})})},e.prototype.preload=function(t){var e=this;this.status>L.loaded&&(t.forEach(function(t){var i=t.m3u8,n=t.nodeid;e.queue.add(function(){return new Promise(function(t){e.w.loader(i,n).then(function(i){i&&i.nodeid&&i.blob&&(e.clone.getAttribute("data-nodeid")===i.nodeid?(e.clone.src=i.blob,e.clone.load()):e.blob[i.nodeid]={status:"done",data:i.blob}),t()})})})}),Logger.log(this.queue))},e}(N);__reflect(D.prototype,"mulit");var B=function(t){function e(e){void 0===e&&(e="MP4");var i=t.call(this)||this;return i.type="mse",i.source="MP4",i.handleError=i.handleError.bind(i),i}return __extends(e,t),e.prototype.handleError=function(t){t.message&&t.message.indexOf("CHUNK_DEMUXER_ERROR_APPEND_FAILED")>-1&&this.errorListener(4)},e.prototype.load=function(t,e){var i=this;return void 0===e&&(e=this.dragStart),new Promise(function(n,o){"video"===i.media.id&&i.media||(i.media=document.querySelector("#video"),i.media.crossOrigin="anonymous");var r=new egret.Timer(15e3,1);i.status=L.loading,e=Number(e.toFixed(5)),i.MsePlayer=MsePlayer(i.media,t,STORY.nodeid),i.media.playbackRate=i.playRate,i.media.volume=i.vol=USER.volume,r.start(),r.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){i.media.removeEventListener("loadedmetadata",s),Toast.show("网络异常，无法加载视频，请重新尝试"),i.exit(),n({code:-1,ret:-1,result:!1})},i);var s=function(){(e+1>=i.duration||!i.duration)&&(e=0),e&&(i.MsePlayer.loadData(e),i.media.currentTime=e),i.status=L.loaded,i.media.removeEventListener("loadedmetadata",s),r.reset(),r.stop(),n({code:0,ret:0,result:!0,time:e})};i.media.addEventListener("loadedmetadata",s),i.media.removeEventListener("ended",i.handleEnd),i.MsePlayer.on("ended",i.handleEnd),i.MsePlayer.on("error",i.handleError),i.checkNode(STORY.blockid,STORY.nodeid),i.stage.initRate()})},e.prototype.preload=function(t){if(this.status>L.loaded){var e=t.map(function(t){return{id:t.nodeid,url:t.m3u8}});this.MsePlayer.preload(e)}},e.prototype["switch"]=function(t){var e=this,i=t.blockid,n=t.nodeid,o=t.m3u8,r=t.autoPlay;this.save(PlayerFlag.PS_Finish),this.MsePlayer["switch"](n,o).then(function(){STORY.blockid=i,STORY.nodeid=n,e.playbackRate=e.playRate,r&&e.media.paused&&e.play(),e.checkNode(i,n),e.save(PlayerFlag.PS_Start)})},e.prototype.clear=function(t){this.MsePlayer&&this.MsePlayer.clear(t)},e.prototype.setDefn=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return this.defn===t?[2]:(Loading.show(),STORY.lastPlayTime=this.currentTime,this.defn=USER.defn=t,this.pause(),this.MsePlayer.off("ended",this.handleEnd),this.MsePlayer.destroy(),this.MsePlayer=void 0,this.status=L.created,this.event={},this.clear(),I={},this.render.visible=!1,this.timer.reset(),this.timer.running&&this.timer.stop(),this.queue.clear(),this.w.clear(),[4,this.init(this.stage)]);case 1:return e=i.sent(),e&&Loading.hide(),[2]}})})},e.prototype.exit=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return[4,t.prototype.exit.call(this,e)];case 1:return i.sent(),this.MsePlayer.off("ended",this.handleEnd),this.MsePlayer.destroy(),this.MsePlayer=void 0,[2,!0]}})})},Object.defineProperty(e.prototype,"duration",{get:function(){return this.MsePlayer.duration||this.media.duration},enumerable:!0,configurable:!0}),e}(N);__reflect(B.prototype,"mse");var j=function(t){function e(e){void 0===e&&(e="M3U8");var i=t.call(this)||this;return i.players={},i.type="hls",i.source=e,i}return __extends(e,t),e.prototype.load=function(t,e){var i=this;return void 0===e&&(e=this.dragStart),new Promise(function(n,o){var r=new egret.Timer(15e3,1);i.status=L.loading,e=Number(e.toFixed(5)),i.HLSPlayer=new Hls,i.HLSPlayer.loadSource(t),i.HLSPlayer.attachMedia(i.media),i.media.playbackRate=i.playRate,i.media.volume=i.vol=USER.volume,r.start(),r.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){i.HLSPlayer.off(Hls.Events.MANIFEST_PARSED,s),Toast.show("网络异常，无法加载视频，请重新尝试"),n({code:-1,ret:-1,result:!1})},i);var s=function(){e+1>=i.duration&&(e=0),i.HLSPlayer.startLoad(e),i.currentTime=e,i.status=L.loaded,r.reset(),r.stop(),n({code:0,ret:0,result:!0,time:e})};i.HLSPlayer.once(Hls.Events.MANIFEST_PARSED,s),i.checkNode(STORY.blockid,STORY.nodeid),i.stage.initRate()})},e.prototype["switch"]=function(t){var e=t.blockid,i=t.nodeid,n=(t.m3u8,t.autoPlay);if(this.status=L.switching,this.save(PlayerFlag.PS_Finish),this.HLSPlayer.detachMedia(),i&&this.players[i]&&"done"===this.players[i].status){var o=this.players[i].hls;o.attachMedia(this.media),this.HLSPlayer=o}else{var r=new Hls;r.loadSource(t.m3u8),r.attachMedia(this.media),this.HLSPlayer=r}this.playbackRate=this.playRate,this.volume=this.vol,n&&this.play(),this.clear(STORY.nodeid),this.status=L.playing,STORY.blockid=e,STORY.nodeid=i,n&&this.save(PlayerFlag.PS_Start),this.checkNode(STORY.blockid,STORY.nodeid)},e.prototype.preload=function(t){var e=this;if(this.status>L.loaded){var i=t.map(function(t){return{id:t.nodeid,url:t.m3u8}});i.forEach(function(t){var i=new Hls;i.loadSource(t.url),e.players[t.id]={status:"done",hls:i}})}},e.prototype.clear=function(t){var e=this;t?0===t.indexOf("-")?(t=t.slice(1,t.length),Object.keys(this.players).forEach(function(i){i!==t&&e.players[i]&&(e.players[i].hls.destroy(),e.players[i]=void 0)})):this.players[t]&&(this.players[t].hls.destroy(),this.players[t]=void 0):(Object.keys(this.players).forEach(function(t){e.players[t]&&(e.players[t].hls.destroy(),e.players[t]=void 0)}),this.players={})},e.prototype.setDefn=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return this.defn===t?[2]:(Loading.show(),STORY.lastPlayTime=this.currentTime,this.defn=USER.defn=t,this.pause(),this.HLSPlayer.detachMedia(),this.HLSPlayer=void 0,this.status=L.created,this.event={},this.clear(),I={},this.render.visible=!1,this.timer.reset(),this.timer.running&&this.timer.stop(),this.queue.clear(),this.w.clear(),[4,this.init(this.stage)]);case 1:return e=i.sent(),e&&Loading.hide(),[2]}})})},e.prototype.exit=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return[4,t.prototype.exit.call(this,e)];case 1:return i.sent(),this.HLSPlayer&&(this.HLSPlayer.detachMedia(),this.HLSPlayer=void 0),[2,!0]}})})},e}(N);__reflect(j.prototype,"hls");var V=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return __extends(i,e),i.prototype.format=function(e){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,s,a,c,h,u,d,l,p,g,f,v,_,m,y,b,S,E,w,T,C,k,R,O,P,x,L,U,I=this;return __generator(this,function(A){switch(A.label){case 0:return this.idx=e.idx,i=STORY.chapterInfo(STORY.chapterid),n=i&&"steam"===Env.app,n?[4,DLC.checkChapter(i.index)]:[3,2];case 1:n=!A.sent(),A.label=2;case 2:if(n)return Widget.pop("PopupDialog",{title:"提示",content:"请前往商店购买并安装",button:["确认","取消"],callback:function(e){return __awaiter(I,void 0,void 0,function(){return __generator(this,function(i){return e&&Steam.toSteamStore(),t.exit(PlayerFlag.PS_Home),Scenes.addUI("Skin.StartView"),[2]})})}}),[2,null];if(!e.button_control)return[3,11];for(o={drag:[],node:[],event:[]},r=e.button_control,s=!1,a="",r.mcache_node&&r.mcache_node.length>0&&r.mcache_node.forEach(function(t){t.m3u8&&t.m3u8_md5&&(t.m3u8="file:\\\\"+USER.path+"\\videos\\720\\"+t.m3u8+".mp4")}),r.button_info&&r.button_info.buttons&&r.button_info.buttons.length>0&&r.button_info.buttons.forEach(function(t){t.m3u8&&t.m3u8_md5&&(t.m3u8="file:\\\\"+USER.path+"\\videos\\720\\"+t.m3u8+".mp4")}),c=0,h=r.mcache_node.length;h>c;c++)u=r.mcache_node[c],!u.m3u8&&u.blockid&&u.node_id?(-1===STORY.allPath.indexOf(u.blockid)&&STORY.allPath.push(u.blockid),d=Net.ws(),d.send("savegame",{last_play_time:0,cur_play_block:u.blockid,cur_play_node:u.node_id,block_played:[u.blockid],node_played:[u.node_id],flag:PlayerFlag.PS_Finish})):(o.node.push({m3u8:u.m3u8,duration:u.duration,blockid:u.blockid,nodeid:u.node_id}),u.vedio_info&&u.vedio_info.url&&u.vedio_info.ppic?(l=M(u.vedio_info.url[0]),o.event.push({type:"playing",blockid:u.blockid,nodeid:u.node_id,data:{time:0,action:"thumb",data:Object.assign({vid:l},u.vedio_info.ppic)}})):(s=!0,a="没有找到视频地址"),u.chapter_id!==STORY.chapterid&&o.event.push({type:"playing",blockid:u.blockid,nodeid:u.node_id,data:{time:0,action:"updateChapter",chapterid:u.chapter_id}}));if(p=o.node.length,0===p)return[2,null];g=o.node[p-1],f=g.blockid,v=g.nodeid,_=o.node[0],m=p>2?o.node[p-2]:_,p>1&&o.event.push({type:"playing",blockid:_.blockid,nodeid:_.nodeid,data:{time:5,action:"preload",blockid:u.blockid,node:o.node.slice(1,p)}}),y=0,b=o.node.length,A.label=3;case 3:return b>y?(S=o.node[y],E=o.node[y+1],E?[4,Component.QTECheck(S.blockid,S.nodeid)]:[3,5]):[3,6];case 4:w=A.sent(),w?(T={succ:{action:[],destroy:[]},fail:{action:[],destroy:[]}},T.succ.action.push({action:"switch",blockid:E.blockid,nodeid:E.nodeid,m3u8:E.m3u8,autoPlay:!0}),o.event.push({type:"playing",blockid:w.blockid,nodeid:w.nodeid,data:{action:"qte",time:0,info:w,events:T}}),o.event.push({type:"ended",blockid:w.blockid,nodeid:w.nodeid,data:{action:"loop",loop:!0}})):o.event.push({type:"ended",blockid:S.blockid,nodeid:S.nodeid,data:{action:"switch",blockid:E.blockid,nodeid:E.nodeid,m3u8:E.m3u8,autoPlay:!0}}),A.label=5;case 5:return y++,[3,3];case 6:return r.button_info&&r.button_info.buttons&&r.button_info.buttons.length>0?(C="textChoice",[4,Component.QTECheck(f,v)]):[3,8];case 7:k=A.sent(),k&&k.buttons&&(R=[],r.button_info.buttons.forEach(function(t,e){r.button_info.buttons[e]=Object.assign(k.buttons[e],t),t.imgage&&R.push(t.imgage)}),R.length>0?(C="imageChoice",R.length>0&&R.forEach(function(t){t&&RES.getResByUrl("https://www.npcstudio.cn/images/qte/"+t,function(){},I)})):C="qteChoice"),r.button_info.limit_time>0&&(-1===r.button_info.default_button&&(r.button_info.default_button=0),C="timeChoice"),O=r.button_info,P=[],x={},O.buttons.forEach(function(t){var e=t.blockid,i=t.node_id;if(t.nodeid=i,x[i]={action:[],destroy:[]},x[i].action.push({action:"switch",blockid:e,nodeid:i,m3u8:t.m3u8,autoPlay:!1}),t.vedio_info&&t.vedio_info.url&&t.vedio_info.ppic){var n=M(t.vedio_info.url[0]);x[i].action.push({action:"thumb",blockid:e,nodeid:i,data:Object.assign({vid:n},t.vedio_info.ppic)})}P.push({blockid:e,nodeid:i,m3u8:t.m3u8})}),o.event.push({type:"playing",blockid:m.blockid,nodeid:m.nodeid,data:{time:5,action:"preload",node:P}}),L=O.show_time,L>10?(L=L,o.event.push({type:"playing",blockid:f,nodeid:v,data:{time:L,idx:this.idx+1,action:C,events:x,info:O}}),o.event.push({type:"playing",blockid:f,nodeid:v,data:{action:"pause",time:O.deadline-2}})):(o.event.push({type:"playing",blockid:f,nodeid:v,data:{time:0,idx:this.idx+1,action:C,events:x,info:O}}),o.event.push({type:"ended",blockid:f,nodeid:v,data:{action:"loop",loop:!0}})),A.label=8;case 8:return r.is_end?[4,STORY.blockInfo(f)]:[3,10];case 9:U=A.sent(),o.event.push({type:"ended",blockid:f,nodeid:v,data:{action:0===r.end_type&&U.cmd&&-1!==U.cmd.indexOf("ConfirmAtEnd")?"confirm":"complete",type:r.end_type,blockid:g.blockid,nodeid:v,confirmMsg:U.confirmMsg}}),A.label=10;case 10:return[2,o];case 11:return[2]}})})},i}(N);__reflect(V.prototype,"local"),t.screenshot=i,t.type=n,t.play=o,t.pause=r,t.exit=s,t.skip=a,t.choosing=c,t.seekAble=h,t.bufferEnd=u,t.status=d,t.playing=l,t.destroy=p,t.save=g,t.listener=f,t.load=v,t.currentTime=_,t.setVolume=m,t.currentVid=y,t.currentDefn=b,t.setDefn=S,t.dragStart=E,t.dragEnd=w,t.dragable=T,t.duration=C,t.currentTimeRate=k,t.playbackRate=R,t.checkNetWork=O,t.completeChapter=P,t.clearButton=x}(Player||(Player={}));var Pool;!function(t){function e(e,i){var n;if(!t.cache[e]||t.cache[e].length<1){var o=egret.getDefinitionByName(e);try{n=new o(i)}catch(r){Logger.log(e+"创建对象失败")}}else n=t.cache[e].pop();if(i)for(var s in i)n[s]=i[s];return n}function i(e){var i=egret.getQualifiedClassName(e);t.cache[i]||(t.cache[i]=[]),t.cache[i].push(e)}function n(t){}function o(t){}t.cache={},t.get=e,t.set=i,t.add=n,t.clear=o}(Pool||(Pool={}));var PROMPT={get award(){return LS.get("PROMPT.award")||{}},set award(t){LS.set("PROMPT.award",t)},get achieve(){return LS.get("PROMPT.achieve")||{}},set achieve(t){LS.set("PROMPT.achieve",t)},get olachieve(){return LS.get("PROMPT.olachieve")||{}},set olachieve(t){LS.set("PROMPT.olachieve",t)},set concurrentusers(t){Database.set("PROMPT.concurrentusers",t)},get concurrentusers(){return Database.get("PROMPT.concurrentusers")||1}},Prompt;!function(t){function e(e){return new Promise(function(i){if(console.log(a),e&&a.length>0){var n=a.some(function(t){return t.text==e.text?!0:void 0});if(n)return}if(e&&a.push(e),t.promptSwitch)if(0==a.length)console.log("+++++++++++++++++++prompt队列已空"),i(!0);else if(c.promptStatus)console.log("+++++++++++++++++++prompt提示中，当前提示信息进入队列"),i(!1);else{console.log("+++++++++++++++++++prompt队列还有"+a.length+"个");var o=a.shift();c.show(o.type,o.text)}})}function i(){c.visible=!1,a=[]}function n(e){h=e,c=new Component.PromptComponet,console.log(c),h.stage.addChild(c),a=[],Events.register("explore_change",t.explore,this),Events.register("achieve_unlock",t.achieve,this)}function o(t){var i=t.data,n=i.expore;if(console.log("+++++++++++++章节探索度变为："+n),!(50>n)){var o=PROMPT.award,r=Net.ws();r.send("getsettlereward",{chapter_id_list:[STORY.chapterid]}).then(function(t){if(0==t.ret&&t.data&&t.data.settle_reward_info_map&&t.data.settle_reward_info_map[STORY.chapterid]){var i=t.data.settle_reward_info_map[STORY.chapterid].reward_list;i.some(function(t){return 2!=t.condition||1!=t.status||o[t.reward_id]?void 0:(o[t.reward_id]=1,PROMPT.award=o,e({type:1,text:STORY.chapterInfo(STORY.chapterid).ChapterLabel+" 探索度"+Math.floor(t.value/100)+"%"}),!0)})}})}}function r(t){return __awaiter(this,void 0,void 0,function(){var i,n,o,r,a,c,h;return __generator(this,function(u){switch(u.label){case 0:return 0!==Object.keys(RECORD.localdata).length?[3,2]:(i=RECORD,[4,s()]);case 1:i.localdata=u.sent(),u.label=2;case 2:return n=t.data,o=PROMPT.achieve,r=PROMPT.olachieve,a=RECORD.localdata.achieve,c=new Q.PromiseQueue({concurrency:1}),h=[31,32,33,34],n.achieve.map(function(t){a.some(function(i){return i.recoed_show_type<2?void 0:i.id==t.achievement_id?(o[i.id]||(!n.is_all&&e({type:2,text:i.name}),o[i.id]=1,PROMPT.achieve=o),!r[i.id]&&h.indexOf(i.id)<0&&c.add(function(){var t="ACH_"+i.id;return Steam.getAchievement(t).then(function(e){e||(r[i.id]=1,Steam.activateAchievement(t))})}),!0):void 0})}),[2]}})})}function s(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/recordData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})}var a,c,h;t.show=e,t.clear=i,t.init=n,t.explore=o,t.achieve=r}(Prompt||(Prompt={}));var Q;!function(t){var e=function(){function t(t){if(this._resolveEmpty=function(){},this._queue=[],this._pause=!1,t=Object.assign({concurrency:1,callback:function(){}},t),t.concurrency<1)throw new TypeError("Expected `concurrency` to be an integer which is bigger than 0");this._ongoingCount=0,this._concurrency=t.concurrency,this._callback=t.callback}return t.prototype.pause=function(){this._pause=!0},t.prototype.resume=function(){this._pause=!1,this._next()},t.prototype.clear=function(){this._pause=!0,this._ongoingCount=0,this._queue=[],this._pause=!1},t.prototype.add=function(t){var e=this;if(Array.isArray(t)){if(t.length>1){var i=this.add(t.shift());if(!(i instanceof TypeError))return this.add(t)}return this.add(t[0])}return new Promise(function(i,n){var o=function(){e._ongoingCount++,t().then(function(t){i(t),e._next()},function(t){n(t),e._next()})};e._ongoingCount<e._concurrency&&!e._pause?o():e._queue.push(o)}),this},Object.defineProperty(t.prototype,"waitingCount",{get:function(){return this._queue.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ongoingCount",{get:function(){return this._ongoingCount},enumerable:!0,configurable:!0}),t.prototype._next=function(){if(!this._pause)if(this._ongoingCount--,this._queue.length>0){var t=this._queue.shift();t&&t()}else this._callback(),this._resolveEmpty()},t}();t.PromiseQueue=e,__reflect(e.prototype,"Q.PromiseQueue")}(Q||(Q={}));var Resize;!function(t){function e(t){var e=document.querySelector("#"+t);e&&p.push(t)&&s(e)}function i(t){if(p.indexOf(t)>-1){var e=p.indexOf(t);p.splice(e,1)}}function n(){return!!(document.documentElement.clientWidth>document.documentElement.clientHeight)}function o(){return!!h}function r(){return Math.abs(u)}function s(t){if(t){var e=h?"90deg":"0deg";t instanceof HTMLVideoElement||t instanceof HTMLCanvasElement?(t.style.webkitTransform="rotate("+e+")",t.style.transform="rotate("+e+")",t.style.width=d*u+"px",t.style.height=l*u+"px",t.style.marginLeft="-"+d*u/2+"px",t.style.marginTop="-"+l*u/2+"px"):(t.style.webkitTransform="scale("+u+") rotate("+e+")",t.style.transform="scale("+u+") rotate("+e+")")}}function a(){var t=document.documentElement.clientWidth,e=document.documentElement.clientHeight,i=!!(t>e),n=i?t/e:e/t,o=i?t:e,r=i?e:t;u=n>1920/1080?r/l:o/d,h=e>t?1:0,p.forEach(function(t){s(document.querySelector(t))})}function c(){a(),window.addEventListener("resize",a)}var h,u,d=1920,l=1080,p=["#precontent"];t.push=e,t.remove=i,t.islandscape=n,t.getRotated=o,t.getScale=r,t.transform=s,t.vscale=a,t.init=c}(Resize||(Resize={}));var Scenes;!function(t){function e(e){t.mainStage=e}function i(e,i){if(!e)return null;if(!t.pool[e]){var n=egret.getDefinitionByName(e);if(!n)return void Logger.log("className = "+e+" Error");t.pool[e]=new n}if(i){t.pool[e];for(var o in i)t.pool[e][o]=i[o]}return t.pool[e]}function n(e){t.pool[e]&&(t.pool[e]=null,delete t.pool[e])}function o(e){return void 0===e&&(e=t.currentUI),__awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(o){return t.stage.forEach(function(o){return __awaiter(n,void 0,void 0,function(){var n,s,a;return __generator(this,function(c){switch(c.label){case 0:return o===e?[3,5]:(n=i(o))?(s=n.beforeExit&&"function"==typeof n.beforeExit,s?[4,n.beforeExit()]:[3,2]):[2];case 1:s=c.sent(),c.label=2;case 2:return r(o),t.mainStage.removeChild(n),a=n.afterExit&&"function"==typeof n.afterExit,a?[4,n.afterExit(t.currentUI)]:[3,4];case 3:a=c.sent(),c.label=4;case 4:c.label=5;case 5:return[2]}})})}),t.stage.indexOf(e)>-1?t.stage=[e]:t.stage=[],[2]})})}function r(t){var e=i(t);e&&e.BGM&&BGM.stop()}function s(e,n){return __awaiter(this,void 0,void 0,function(){var o,s,a,c,h,u;return __generator(this,function(d){switch(d.label){case 0:return e==t.currentUI?[2]:(Logger.log(t.currentUI+" =>"+e),o=!0,(s=i(e,n))?(a=i(t.currentUI),c=t.currentUI,s?(s.horizonCenter=0,s.beforeAdd&&"function"==typeof s.beforeAdd?[4,s.beforeAdd(t.currentUI)]:[3,2]):[3,5]):[2]);case 1:o=d.sent(),d.label=2;case 2:return o?(t.mainStage.addChild(s),t.currentUI=e,a&&s.BGM&&a.BGM!==s.BGM||!a&&s.BGM?s.BGM&&BGM.play(s.BGM,s.BGMOnce?!1:!0):a&&a.BGM&&!s.BGM&&r(c),-1===t.stage.indexOf(e)?t.stage.push(e):(h=t.stage.indexOf(e),t.stage.splice(h,1),t.stage.push(e)),u=s.afterAdd&&"function"==typeof s.afterAdd,u?[4,s.afterAdd(c)]:[3,4]):[2,!1];case 3:u=d.sent(),d.label=4;case 4:return[2,!0];case 5:return[2]}})})}function a(e){return void 0===e&&(e=t.currentUI),__awaiter(this,void 0,void 0,function(){var n,o,r,s,a;return __generator(this,function(c){switch(c.label){case 0:return n=i(e),n&&t.stage.indexOf(e)>-1?(Logger.log("当前要退出UI："+e),o=n.beforeExit&&"function"==typeof n.beforeExit,o?[4,n.beforeExit()]:[3,2]):[3,5];case 1:o=c.sent(),c.label=2;case 2:for(t.stage.splice(t.stage.indexOf(e),1),t.mainStage.removeChild(n),r=t.mainStage.$children.length-1;r>=0;){if(s=t.mainStage.$children[r],0===egret.getQualifiedClassName(s).indexOf("Skin.")){t.currentUI=egret.getQualifiedClassName(s);break}r-=1}return a=n.afterExit&&"function"==typeof n.afterExit,a?[4,n.afterExit(t.currentUI)]:[3,4];case 3:a=c.sent(),c.label=4;case 4:return[2,!0];case 5:return[2]}})})}t.pool={},t.stage=[],t.loadLabel=new egret.TextField,t.init=e,t.get=i,t.clear=n,t.clean=o,t.stop=r,t.addUI=s,t.exitUI=a}(Scenes||(Scenes={}));var Share;!function(t){function e(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/shareData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})}function i(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return 0!==Object.keys(RECORD.localdata).length?[3,2]:[4,e().then(function(t){return SHARE.localdata=t})];case 1:t.sent(),t.label=2;case 2:return s=new eui.Group,s.x=0,s.y=0,a=new egret.Bitmap,a.fillMode=egret.BitmapFillMode.SCALE,a.x=0,a.y=0,c=new egret.Bitmap,RES.getResAsync("dangan_erweima_png",function(t){c.texture=t,c.width=t.textureWidth?t.textureWidth:110,c.height=t.textureHeight?t.textureHeight:110},this),c.fillMode=egret.BitmapFillMode.SCALE,s.addChild(a),s.addChild(c),Env.tvideo&&TenvideoJSBridge.on("onShareFinish",function(t){r(t)}),[2]}})})}function n(e){var i;if(t.sharetype=e.type,e.showtype)i=e.showtype;else{var n=void 0;e.type==SHARE_TYPE.achieve?(n=Math.random()*(SHARE.value[VAR_ID.achievepic]+SHARE.value[VAR_ID.achievetext]),i=n>SHARE.value[VAR_ID.achievepic]?1:2):e.type==SHARE_TYPE.ranklist&&(n=Math.random()*(SHARE.value[VAR_ID.rankpic]+SHARE.value[VAR_ID.ranktext]),i=n>SHARE.value[VAR_ID.rankpic]?1:2)}if(1==i){({title:e.title,subTitle:e.content,singleTitle:e.title,content:e.content,contentTail:e.title,imageUrl:t.imagePath+e.icon,url:e.url,style:"0",coverId:"15位的字符串",videoId:"11位的字符串",programName:"gh_fce17bb0518f",path:"pages/play/index?cid=77jvp2s8fmpu0oi&vid=x0026klw5z1&lid=&ptag=app_share"});h.shareInfo={title:e.title,subTitle:e.content,singleTitle:e.title,content:e.content,contentTail:e.title,imageUrl:t.imagePath+e.icon,url:e.url},Env.tvideo&&TenvideoJSBridge.invoke("setMoreInfo",h,function(t){t.errCode?Toast.show("分享接口调用失败！errCode:"+t.errMsg):TenvideoJSBridge.invoke("openToolsDialog")})}else 2==i&&RES.getResByUrl(t.imagePath+e.bigpic,function(e){t.local(e,1)},this,RES.ResourceItem.TYPE_IMAGE)}function o(e,i,n){a.texture=e,a.width=e.textureWidth?e.textureWidth:1334,a.height=e.textureHeight?e.textureHeight:750,c.x=a.width-c.width-20,c.y=a.height-c.height-20,s.width=a.width,s.height=a.height;var o=new egret.RenderTexture;o.drawToTexture(s,new egret.Rectangle(0,0,s.width,s.height));var r=o.toDataURL("image/png");r=r.replace("data:image/png;base64,",""),0==i?Env.tvideo&&TenvideoJSBridge.invoke("saveImage",{url:t.imagePath+n,imgbase64String:r,needSaveToAlbum:!0},function(t){}):1==i&&Env.tvideo&&TenvideoJSBridge.invoke("shareLocalImage",{imgbase64String:r},function(t){})}function r(e){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){switch(n.label){case 0:return e=Net.ws(),[4,e.send("sharereport",{share_type:t.sharetype})];case 1:return i=n.sent(),i.data&&i.data.now_money&&i.data.now_money.coins&&(Toast.show("获得首日分享奖励"+i.data.reward_money.coins+"金币"),MALL.coin=i.data.now_money.coins,"Component.PopupShare"==egret.getQualifiedClassName(Widget.currentPop)&&(Widget.currentPop.gTips.visible=!1)),[2]}})})}t.imagePath="https://www.npcstudio.cn/images/share/";var s,a,c,h={hasRefresh:!1,hasShare:!0,hasFollow:!1,shareInfo:{},source:"隐形守护者",isShareImageOnly:!0};t.init=i,t.sns=n,t.local=o,t.finish=r}(Share||(Share={}));var BGM;!function(t){function e(){a=!1,s.removeEventListener(egret.Event.SOUND_COMPLETE,e,this)}function i(i,o){if(void 0===o&&(o=!0),i!==t.currentBGM||!t.playing()){n();var r=RES.getRes(i);r.type=egret.Sound.MUSIC,a=!0,s=r.play(0,o?0:1),USER.bgm?s.volume=.5*USER.volume:s.volume=0,t.currentBGM=i,o||s.addEventListener(egret.Event.SOUND_COMPLETE,e,this)}}function n(){s&&s.stop(),s=null,t.currentBGM="",a=!1}function o(){return a}function r(t){s&&(s.volume=USER.bgm?t:0)}var s,a=!1;t.play=i,t.stop=n,t.playing=o,t.setVolume=r}(BGM||(BGM={}));var Effect;!function(t){function e(t,e){if(void 0===e&&(e=!1),0!=USER.effect){var i,n=RES.getRes(t);return n?(i=n.play(0,1),i.volume=USER.effect?.5*USER.volume:0,i):(n=new egret.Sound,n.addEventListener(egret.Event.COMPLETE,function(t){var n=t.target;i=n.play(0,e?0:1),i.volume=USER.effect?.5*USER.volume:0},this),n.load(t),i)}}t.play=e}(Effect||(Effect={}));var Volume;!function(t){function e(){return new Promise(function(t,e){"tvideo"===Env.app?TenvideoJSBridge.invoke("getVolume",null,function(e){e="string"==typeof e?JSON.parse(e):e,(0===e.errCode||"0"===e.errCode)&&t(e.result.volume)}):"steam"===Env.app&&t(USER.volume)})}function i(t){"tvideo"===Env.app?TenvideoJSBridge.invoke("setVolume",{volume:t}):"steam"===Env.app&&(USER.volume=t,BGM.setVolume(t),Player.setVolume(t))}t.get=e,t.set=i}(Volume||(Volume={}));var Steam;!function(t){function e(t,e){var i=this;return new Promise(function(n){S++;var o=new egret.Timer(1e3,15);o.addEventListener(egret.TimerEvent.TIMER,function(){1===o.currentCount&&Loading.show(),15===o.currentCount&&(Loading.isShow()&&Loading.hide(),Toast.show("网络异常，steam通信超时，请稍后再试:"+t+" - "+S),Logger.error(S+" - "+t+" -"+JSON.stringify(e)),n({code:2e3,ret:2e3,msg:"网络异常，steam通信超时，请稍后再试"}))},i),o.start(),w[t+"_"+S]={resolve:n,cmd:t,sn:S,timer:o},E.send("ipcMain-async-listener",JSON.stringify({cmd:t,sn:S,data:e}))})}function i(){return new Promise(function(t){T=t})}function n(e){return new Promise(function(i){if(!e)return void i({ret:-1,code:-1,msg:"网络异常，没有订单信息，购买失败"});var n=function(e,i){return new Promise(function(e){Widget.pop("PopupDialog",{title:"提示",content:i+" - 订单异常，请重新登录",button:["确认"],callback:function(e){t.relauchGame(),t.exitGame()}})})},o=Net.ws();o.send("finishBuy",{order_id:e}).then(function(t){0===t.ret?i(t):2084!==t.ret&&n(e,t.ret)})})}function o(){return new Promise(function(t){e("getSteamId").then(function(e){t(0===e.ret?{id:e.data.id,appid:e.data.appid}:{id:"",appid:""})})})}function r(t){return new Promise(function(i){e("activateAchievement",{name:t}).then(function(t){i(t.data?t.data.result:!1)})})}function s(t){return new Promise(function(i){e("getAchievement",{name:t}).then(function(t){i(t.data?t.data.result:!1)})})}function a(t){return new Promise(function(i){e("clearAchievement",{name:t}).then(function(t){i(t.data?t.data.result:!1)})})}function c(){return e("getSteamInfo")}function h(){p({volume:USER.volume}).then(function(){e("exitGame")})}function u(){e("relauchGame")}function d(){return e("getSteamAppid")}function l(){return e("getSystemInfo")}function p(t){return new Promise(function(i){e("updateSetting",t).then(function(t){i(0===t.ret)})})}function g(t){return new Promise(function(i){e("setVolume",t).then(function(t){i(0===t.ret)})})}function f(t){return __awaiter(this,void 0,void 0,function(){var e,o,r;return __generator(this,function(s){switch(s.label){case 0:return e=Net.ws(),[4,e.send("buy",t)];case 1:return o=s.sent(),0!==o.ret?[3,6]:[4,i()];case 2:return r=s.sent(),r.authorized?[4,n(r.orderid)]:[3,4];case 3:return[2,s.sent()];case 4:return[4,e.send("cancelBuy",{order_id:r.orderid})];case 5:return s.sent(),[2,{ret:-1,code:-1}];case 6:return[2,{ret:o.ret,code:-1,msg:o.msg||"网络异常，购买失败，请检查网络后再试"}]}})})}function v(t){return new Promise(function(i){e("saveFile",{url:t}).then(function(t){i(0===t.ret)})})}function _(t){e("activeOverlay",{type:t})}function m(t){void 0===t&&(t="https://store.steampowered.com/app/1012220/_The_Invisible_Guardian__610/"),e("toSteamStore",{url:t})}function y(t){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return t||(t=DLC.getAppid()),[4,e("checkDLC",{appid:t})];
case 1:return i=n.sent(),0===i.ret?[2,i.data.result]:[2,!1]}})})}function b(t){e("showError",{title:"异常提示",msg:t})}var S=0,E=require("electron").ipcRenderer,w={},T=void 0;E.on("ipcRenderer-async-listener",function(t,e){if(e=JSON.parse(e)){var i=e.sn,n=e.cmd;w[n+"_"+i]&&w[n+"_"+i].timer&&w[n+"_"+i].timer.running&&w[n+"_"+i].timer.reset(),w[n+"_"+i]&&w[n+"_"+i].resolve({ret:e.ret,msg:e.msg,data:e.data}),w[n+"_"+i]=void 0,Loading.isShow()&&Loading.hide()}}),E.on("ipcRenderer-listener",function(t,e){var i=JSON.parse(e);"micropay"===i.channel?T&&(T({orderid:i.orderid,authorized:i.authorized}),T=void 0):Events.dispatch("steam-listener-"+i.channel,i)}),t.getSteamId=o,t.activateAchievement=r,t.getAchievement=s,t.clearAchievement=a,t.getSteamInfo=c,t.exitGame=h,t.relauchGame=u,t.getSteamAppid=d,t.getSystemInfo=l,t.updateSetting=p,t.setVolume=g,t.micropay=f,t.saveFile=v,t.activeOverlay=_,t.toSteamStore=m,t.checkDLC=y,t.showError=b}(Steam||(Steam={}));var StoryData;!function(t){function e(){var t=Net.ws();return t.send("loadgame")}function i(){return __awaiter(this,void 0,void 0,function(){var t,e,i;return __generator(this,function(n){switch(n.label){case 0:return t=Net.ws(),[4,t.send("blockpath")];case 1:return e=n.sent(),0===e.ret?(i=e.data,STORY.currentPath=i.block_path,[2,!0]):[2,!1]}})})}function n(){return __awaiter(this,void 0,void 0,function(){var t,i,n,o;return __generator(this,function(r){switch(r.label){case 0:return t=STORY,[4,Utils.getJSON("nodeInfo.json")];case 1:return t.node2Block=r.sent(),[4,Promise.all([Utils.getJSON("chapterInfo.json"),e(),Coins.init(),DLC.init()])];case 2:return i=r.sent(),STORY.allChaptersInfo=i[0],STORY.chapterInfo(0).unlocked=!0,n=i[1],0===n.ret?(o=n.data,o.roledata?(o.roledata&&(STORY.allPath=o.roledata.block_played,STORY.data=o.roledata.value_system,STORY.blockid=o.roledata.cur_play_block,STORY.chapterid=o.roledata.cur_play_chapter,STORY.lastPlayTime=o.roledata.last_play_time,STORY.nodeid=o.roledata.arrive_node,o.roledata.complete_chapter.forEach(function(t){var e=t.chapter;STORY.allChaptersInfo[e]&&(STORY.allChaptersInfo[e].complete=!0,STORY.allChaptersInfo[e].completeTime=t.timestamp)})),o.complete_percent&&(STORY.exportData=[{chapter_id:"global",chapter_percent:o.complete_percent.whole_percent||0}].concat(o.complete_percent.chapter_percent)),[2,!0]):[2,!1]):[2,!1]}})})}function o(t){return Promise.all([Utils.getJSON(t+".json")]).then(function(e){STORY.allChaptersInfo[t].nodes=e[0]})}function r(t){return RECORD.personinfo.find(function(e){return t===e.person_id})}t.blockPath=i,t.init=n,t.getBlockInfo=o,t.getPerson=r}(StoryData||(StoryData={}));var Thumb;!function(t){function e(e){if(e){o={},r=[],t.smallLoaded=0,o={vsmall:{cnt:e.vsmall.cnt,cd:e.vsmall.cd,vw:e.vsmall.vw,vh:e.vsmall.vh,vr:e.vsmall.vr,vc:e.vsmall.vc,vurl:[]},vbig:{cnt:e.vbig.cnt,cd:e.vbig.cd,vw:e.vbig.vw,vh:e.vbig.vh,vr:e.vbig.vr,vc:e.vbig.vc,vurl:[]}};for(var i=0;i<e.vsmall.cnt;i++){var s=i+1,a=""+e.vsmall.vurl+e.vid+"."+e.vsmall.fn+"."+s+".jpg/0";o.vsmall.vurl.push(a)}for(var i=0;i<e.vbig.cnt;i++){var s=i+1,a=""+e.vbig.vurl+e.vid+"."+e.vbig.fn+"."+s+".jpg/0";o.vbig.vurl.push(a)}n(o)}}function i(t){var e,i,n,r,a,c,h;e=o,i=t;var u=e.vsmall;n=i/u.cd+1,c=Math.floor(n/(u.vc*u.vr)),h=u.vurl[c],r=Math.floor(n%(u.vc*u.vr)%u.vc),a=Math.floor(n%(u.vc*u.vr)/u.vr);var d,l,p,g,f=e.vbig;d=Math.floor(n/(f.vc*f.vr)),l=f.vurl[d],p=Math.floor(n%(f.vc*f.vr)%f.vc),g=Math.floor(n%(f.vc*f.vr)/f.vr);var v=s.filter(function(t){return t==l});if(v.length<1){if(l){var _=new Image;_.onload=function(){s.push(l)},_.src=l}return{img:h,x:r,y:a,width:u.vw,height:u.vh}}return{img:l,x:p,y:g,width:f.vw,height:f.vh}}function n(e){e.vsmall.vurl.map(function(e){var i=new Image,n={src:e,loaded:null};r.push(n),i.onload=function(){r.filter(function(e){e.src==i.src&&(e.loaded=!0,t.smallLoaded+=100/r.length,Logger.log("缩略图小图已加载："+t.smallLoaded+"% of "+r.length))})},i.src=e})}var o={},r=[],s=[];t.smallLoaded=0,t.init=e,t.get=i}(Thumb||(Thumb={}));var Time;!function(t){function e(){var t=(new Date).getTime()/1e3;return t}function i(t){var e=new Date(1e3*t).getDate(),i=(new Date).getDate();return e==i}function n(i,n){var o=new egret.Timer(1e3,0),r=function(){var n=Math.ceil(t.unlockend-e()+t.difference),r=[Math.floor(n/60/60),Math.floor(n/60%60),n%60];i.text=r.join(":").replace(/\b(\d)\b/g,"0$1"),n--,1>n&&(o.stop(),s())},s=function(){Logger.log("计时结束"),n&&n()};return o.addEventListener(egret.TimerEvent.TIMER,r,this),o.addEventListener(egret.TimerEvent.TIMER_COMPLETE,s,this),r(),o.start(),o}function o(i){var n=Math.ceil(i-e()+t.difference);return n}function r(t){var e=[Math.floor(t/60/60),Math.floor(t/60%60),t%60];return e.join(":").replace(/\b(\d)\b/g,"0$1")}function s(e){t.difference=Math.floor(e)}function a(){return t.difference}function c(e){t.queueData=e}function h(){return t.queueData}function u(e){t.hpTime=e}function d(){return t.hpTime}function l(e){t.hpRecovery=e}function p(){return t.hpRecovery}function g(e){t.hpExecuted=e}function f(){return t.hpExecuted}function v(e,i){t.unlockid=e,t.unlockend=i}function _(){return t.unlockend}t.hpRecovery=300,t.now=e,t.isToday=i,t.countdown=n,t.remain=o,t.format=r,t.setDiff=s,t.getDiff=a,t.setQueueData=c,t.getQueueData=h,t.setHpTime=u,t.getHpTime=d,t.setHpRecovery=l,t.getHpRecovery=p,t.setHpExecuted=g,t.getHpExecuted=f,t.setUnlockend=v,t.getUnlockend=_}(Time||(Time={}));var Tips;!function(t){function e(t){a||r||(r=new Component.ToastComponet(t),r.verticalCenter=0,r.horizontalCenter=0,r.alpha=0,o.addChild(r),egret.Tween.get(r).to({alpha:1},300),s.start(),a=!0)}function i(){r&&egret.Tween.get(r).to({alpha:0},300).call(function(){o.removeChild(r),r=null,a=!1,s.reset()})}function n(t){o=t,s=new egret.Timer(2e3,1),s.addEventListener(egret.TimerEvent.TIMER,i,this)}var o,r,s,a=!1;t.show=e,t.hide=i,t.init=n}(Tips||(Tips={}));var Toast;!function(t){function e(t){return s?void(c?(s.text=t,a.reset(),a.start()):(c=!0,s.verticalCenter=0,s.horizontalCenter=0,s.alpha=0,s.text=t,r.stage.addChild(s),egret.Tween.get(s).to({alpha:1},300),a.start())):void Steam.showError(t)}function i(){c&&egret.Tween.get(s).to({alpha:0},300).call(function(){r.stage.removeChild(s),c=!1,a.reset()})}function n(t){r=t,a=new egret.Timer(2e3,1),a.addEventListener(egret.TimerEvent.TIMER,i,this),s=new Component.ToastComponet,console.log(s)}function o(){return c}var r,s,a,c=!1;t.show=e,t.hide=i,t.init=n,t.inShow=o}(Toast||(Toast={}));var Utils;!function(t){function e(t,i,n,o){var r=i.length,s="undefined"!=typeof n?n:0,a="undefined"!=typeof o?o:r-1,c=s+Math.floor((a-s)/2);return 0==r?void i.push(t):t>i[a]?void i.splice(a+1,0,t):t<i[s]?void i.splice(s,0,t):s>=a?void 0:t<i[c]?void e(t,i,s,c-1):t>i[c]?void e(t,i,c+1,a):void 0}function i(t){return a||n(),a[t]}function n(t){t=t||window.location.search,"?"===t.substring(0,1)&&(t=t.substring(1)),t=t.replace(/\+/," ");for(var e,i=/([^&;=]+)=?([^&;]*)/g,n={};e=i.exec(t);){var o=decodeURIComponent(e[1]),r=decodeURIComponent(e[2]);n[o]=void 0===n[o]?r:n[o]instanceof Array?n[o].push(r):n[o]=[n[o],r]}return a=n}function o(t){Env.tvideo?TenvideoJSBridge.invoke("openUrl",{url:t,style:"1",close:"0"}):window.open(t)}function r(t){return"resource/json/"+t}function s(t){var e=this,i=r(t);return new Promise(function(t){RES.getResByUrl(i,function(e){t(e)},e,RES.ResourceItem.TYPE_JSON)})}t.binaryInsert=e;var a=null;t.getParams=i,t.openPage=o,t.getJSON=s}(Utils||(Utils={}));var Vibrator;!function(t){function e(t){void 0===t&&(t=1e3);var e=document.getElementById("video"),i=e.className;e.className=i+" shake-constant  "+(Resize.getRotated()?"shake-hard-90":"shake-hard");var n=new egret.Timer(t,1);n.addEventListener(egret.TimerEvent.TIMER,function(){e.className=i,n=null},this),n.start(),navigator&&navigator.vibrate&&navigator.vibrate(t)}t.start=e}(Vibrator||(Vibrator={}));var Watcher;!function(t){function e(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,Env.getNetwork()];case 1:return t=e.sent(),t!==s&&(1!==s||3!==t&&4!==t||(Events.dispatch(NETWORK.lostWIFI,{state:t}),Logger.log("网络状态变化")),0===t&&(Events.dispatch(NETWORK.out,{state:t}),Logger.log("网络状态丢失")),0===s&&t>0&&(Events.dispatch(NETWORK.reconnect,{state:t}),Logger.log("网络重连")),Events.dispatch(NETWORK.change,{state:t}),s=t),Player.playing()&&Scenes.get("Skin.VideoView").gMute&&Scenes.get("Skin.VideoView").gMute.visible?[4,Volume.get().then(function(t){t>0&&(Scenes.get("Skin.VideoView").gMute.visible=!1)})]:[3,3];case 2:e.sent(),e.label=3;case 3:return"Skin.VideoView"!==Scenes.currentUI&&Player.playing()&&Player.pause(),[2]}})})}function i(){Player.playing()&&Player.pause(),BGM.playing&&BGM.stop(),USER.hideTime=Date.now(),r.stop()}function n(){var t=this;TenvideoJSBridge.invoke("isViewVisible",null,function(e){return __awaiter(t,void 0,void 0,function(){var t,i;return __generator(this,function(n){switch(n.label){case 0:return 1!==parseInt(e)?[3,2]:(t=Net.ws(),[4,t.login()]);case 1:i=n.sent(),0==i.ret&&USER.pageHide&&(Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}),USER.pageHide=!1),USER.hideTime=0,r.start(),n.label=2;case 2:return[2]}})})})}function o(){return __awaiter(this,void 0,void 0,function(){var t,o,r=this;return __generator(this,function(c){switch(c.label){case 0:return[4,Env.getNetwork()];case 1:switch(s=c.sent(),Env.app){case"minigame":wx.onHide(i),wx.onShow(n),wx.onAudioInterruptionBegin(i),wx.onAudioInterruptionEnd(n),wx.onNetworkStatusChange(function(t){t.isConnected?1!==s||"3g"!==t.networkType&&"4g"!==t.networkType||(Events.dispatch(NETWORK.lostWIFI,{state:a[t.networkType]}),Logger.log("网络状态变化")):(Events.dispatch(NETWORK.out,{state:0}),Logger.log("网络状态丢失"))});case"tvideo":TenvideoJSBridge.on("onPageDisappear",i),TenvideoJSBridge.on("onPageAppear",n),TenvideoJSBridge.on("onAppEnterBackground",i),TenvideoJSBridge.on(" ",n),t=new egret.Timer(3e3,0),Logger.log("初始化网络状态为"+s),t.addEventListener(egret.TimerEvent.TIMER,function(){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,e()];case 1:return t.sent(),[2]}})})},this),t.start();break;case"steam":o=new egret.Timer(3e3,0),Logger.log("初始化网络状态为"+s),o.addEventListener(egret.TimerEvent.TIMER,function(){return __awaiter(r,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,e()];case 1:return t.sent(),[2]}})})},this),o.start()}return[2]}})})}var r,s=0,a={wifi:1,"4g":4,"3g":3,"2g":2,none:0,unknown:5};t.init=o}(Watcher||(Watcher={}));var Wheel;!function(t){function e(){document.addEventListener("mousewheel",function(t){var e=Scenes.get(Scenes.currentUI),i=t.wheelDelta;e.mouseWheel&&e.onWheel(i)})}t.init=e}(Wheel||(Wheel={}));var Whitelist;!function(t){function e(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return t=new Net.http,[4,t.get("https://api.hg.qq.com/cgi-bin/checkAuthor",{openid:USER.openid,project:"qianfu"})];case 1:return e=i.sent(),[2,e.code]}})})}function i(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return t=new Net.http,[4,t.get("https://api.hg.qq.com/cgi-bin/applyAuthor",{openid:USER.openid,project:"qianfu",nickname:USER.nickname,avatar:USER.avatar})];case 1:switch(e=i.sent(),e.code){case 0:Toast.show("申请成功，请等待管理员审核。");break;case-1100:Toast.show("申请已经提交，不要着急哦！");break;case-1003:Toast.show("黑名单，请关闭游戏！");break;default:Toast.show("网络异常，请求超时")}return[2]}})})}t.check=e,t.apply=i}(Whitelist||(Whitelist={}));var Widget;!function(t){function e(e,i){if("PopupBuy"===e&&3===Env.platformid)return Toast.show("MAC版本暂不支持此功能"),0;t.currentPop&&t.currentPop.parent.removeChild(t.currentPop);var n=egret.getDefinitionByName("Component."+e);return t.currentPop=i?new n(i):new n,Scenes.mainStage.addChild(t.currentPop),t.currentPop.sn=i&&i.sn?i.sn:++a,Logger.log("打开弹窗："+egret.getQualifiedClassName(t.currentPop)),t.currentPop.sn}function i(e){if(e||t.currentPop){var i=e?egret.getDefinitionByName("Component."+e):t.currentPop;i.parent.removeChild(i),t.currentPop=void 0,i.callback&&i.callback(!1),Logger.log("关闭弹窗："+egret.getQualifiedClassName(i))}}function n(e){if(e||t.currentPop){var i=e?egret.getDefinitionByName("Component."+e):t.currentPop;!i||i&&!i.button||i&&i.button&&0===i.button.length||(i.parent.removeChild(i),t.currentPop=void 0,i.callback&&i.callback(!0),Logger.log("关闭弹窗："+egret.getQualifiedClassName(i)))}}function o(e){return t.currentPop?e?t.currentPop.sn===e:!0:!1}function r(e,i){if(!t.pool[e]){var n=egret.getDefinitionByName("Component."+e);t.pool[e]=new n}if(i){t.pool[e];for(var o in i)t.pool[e][o]=i[o]}return t.pool[e]}function s(t,e,i){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(o){return n=r(t,i),"Component.PopupBuy"===t&&3===Env.platformid?(Toast.show("MAC版本暂不支持此功能"),[2]):(n&&e&&e.addChild(n),[2])})})}var a=0;t.pool={},t.pop=e,t.closePop=i,t.confirmPop=n,t.hasPop=o,t.get=r,t.add=s}(Widget||(Widget={}));var WebWorker;!function(t){var e=workerize('\n        var reg = /.m3u8$/;\n\n        var XHRS = {}\n\n        var xhrMP4Range = function (url, nodeid) {\n            return new Promise(function(resolve) {\n                 var max = 3;\n\n                var getTotalRange = function (url) {\n                    return new Promise(function(resolve, reject){\n                        var xhr = new XMLHttpRequest();\n                        xhr.open("GET", url, true);\n\n                        xhr.setRequestHeader("Range", "bytes=0-1")\n\n                        xhr.onload = function (response) {\n\n                            if (xhr.status === 206 || xhr.status === 200) {\n                                var contentRange = xhr.getResponseHeader("Content-Range");\n                                if (contentRange) {\n                                    var num = contentRange.split("/")[1]\n                                    resolve(parseInt(num))\n                                }\n                            }\n                        }\n\n                        xhr.send();\n                    })\n                }\n\n                var getRange = function (start, end) {\n                    return new Promise(function(resolve, reject){\n                        var xhr = new XMLHttpRequest();\n                        xhr.open("GET", url, true);\n\n                        xhr.setRequestHeader("Range", "bytes=" + start + "-" + end)\n\n                        xhr.responseType = "arraybuffer"\n\n\n                        var key = nodeid + "@" + start + "-" + end;\n\n                        xhr.onload = function (response) {\n                            XHRS[key] = undefined;\n                            resolve(xhr.response)\n                        }\n                        xhr.send();\n                        XHRS[key] = xhr\n                    })\n                }\n\n                getTotalRange(url).then(function(totalRange) {\n                    var part = Math.floor(totalRange / max)\n                    var queue = []\n\n                    for (var i = 0; i < max; i++) {\n                        var start = part * i;\n                        var end = part * (i + 1);\n\n                        if (start) start = start + 1\n                        if (i == 3) end = totalRange\n                        queue.push(getRange(start, end))\n                    }\n\n                    Promise.all(queue).then(function(response){\n                        var data = new Uint8Array(totalRange)\n\n                        var bufferLength = 0\n\n                        response.forEach(function(v,i){\n                            data.set(new Uint8Array(v), bufferLength)\n                            bufferLength += v.byteLength\n                        })\n\n                        var blob = new Blob([data], { type: "video/mp4" });\n\n                        resolve(URL.createObjectURL(blob))\n                    })\n                })\n            })\n        }\n\n        export function loader(url, nodeid) {\n            return new Promise(function(resolve) {\n                if (reg.test(url)) {\n\n                } else {\n                    xhrMP4Range(url, nodeid).then(function(blob) {\n                        resolve({ nodeid: nodeid, blob: blob })\n                    })\n                }\n            })\n        }\n\n        export function clear(id) {\n            if (id) {\n                Object.keys(XHRS).forEach(function(key) {\n                    if (key.indexOf(id) == 0 && XHRS[key]) {\n                        XHRS[key].abort()\n                    }\n                })\n            } else {\n                Object.keys(XHRS).forEach(function(key) {\n                    XHRS[key] && XHRS[key].abort()\n                })\n                XHRS = {}\n            }\n        }\n\n        export function revokeObjectURL(blob){\n            URL.revokeObjectURL(blob)\n        }\n     ');t.fn=e}(WebWorker||(WebWorker={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.line=new Object,e.keyboard=!0,e.mouseWheel=!0,e.skinName="ChapterSkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.scrollChapter.addEventListener(eui.UIEvent.CHANGE_START,function(t){e.scrollH=e.scrollChapter.viewport.scrollH,Effect.play(AUDIO.Storyline_Slide_ogg)},this),this.scrollChapter.addEventListener(eui.UIEvent.CHANGE_END,function(t){e.scrollH=e.scrollChapter.viewport.scrollH},this)},e.prototype.beforeAdd=function(t){return this.preUI=t,this.init()},e.prototype.afterAdd=function(t){},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){Widget.add("Topbar",Scenes.get("Skin.StoryView"))},e.prototype.getJSON=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/eggInfo.json",function(i){t.egg=i,e(i)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.onReturn=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Scenes.exitUI(),"Skin.GoodEndView"==this.preUI&&Scenes.addUI("Skin.StartView")},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return NOVICE[NOVICE_TYPE.chapter]?this.gNovice.visible=!1:(this.gNovice.visible=!0,Novice.set(NOVICE_TYPE.chapter),t=Movie.getMC("liuguang"),t.play(-1),t.x=55,t.y=-16,this.gNovice.addChildAt(t,0)),this.egg?[3,2]:[4,this.getJSON()];case 1:i.sent(),i.label=2;case 2:return this.gList.$children.length<1&&this.chapter(),this.lightTween.play(0),[4,this.update()];case 3:return e=i.sent(),e?(this.currentLocation(),[2,!0]):[2,!1]}})})},e.prototype.chapter=function(){var t=this,e=this.gScroller,i=this.gList,n=this.gLine,o=this.gChapter.width,r=0,s=-100,a=STORY.allChaptersInfo;Object.keys(a).map(function(e,a){if("global"!=e){var c=STORY.chapterInfo(e),h=c.ChapterLabel.split("·"),u=new Component.Chapter_item;u.skinName="SmallNode"==c.type?"Chapter_item_smallSkin":"Chapter_itemSkin",u.index=c.index,u.id=c.id,u.title=h[1],u.image="zjk00"+(c.index+1),u.unlocked=c.unlocked,u.type=c.type,u.x=c.x-u.width/2+r,u.y=-c.y-u.height/2+s,u.fillData(),u.name=c.id,u.time=0,c.id==STORY.chapterid&&(t.curX=u.x,t.curY=u.y),i.addChild(u),o=u.x+u.width>o?u.x+u.width:o,c.line&&c.line.map(function(e){var i=new egret.Shape;i.graphics.lineStyle(2,5921111),i.graphics.moveTo(e.pos[0].x+r,-e.pos[0].y+s);for(var o=1;o<e.pos.length;o++)i.graphics.lineTo(e.pos[o].x+r,-e.pos[o].y+s);i.graphics.endFill(),i.name=e.to,t.line[e.to]=e.pos,n.addChildAt(i,0)})}}),Object.keys(this.egg).map(function(e){var n=new Component.Chapter_egg,a=t.egg[e];n.id=a.id,n.name=a.id,n.label=a.ChapterLabel,n.x=a.x-n.width/2+r,n.y=-a.y-n.height/2+s,n.fillData(),i.addChild(n),o=n.x+n.width>o?n.x+n.width:o}),e.width=o+42},e.prototype.update=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s,a,c,h,u=this;return __generator(this,function(d){switch(d.label){case 0:return t=this.gList,e=STORY.allChaptersInfo,i=0,n=-100,o=[],this.baseLine(),Object.keys(e).map(function(e,i){if("global"!=e){var n=STORY.chapterInfo(e);o.push(e);var r=STORY.allPath.some(function(t){return t==e}),s=STORY.currentPath.some(function(t){return t==e}),a=t.getChildByName(e);n.fromBlockid;(r||s)&&(n.unlocked=!0),a.fillData(),e==STORY.chapterid?a.currentOn():a.currentOff()}}),Object.keys(this.egg).map(function(e){var i=u.egg[e],n=t.getChildByName(i.id),o=STORY.currentPath.some(function(t){return t==i.block});console.log("+++++++++++++++egg block:"+i.block+","+o+","+i.id+",checkawrd:"+STORY.checkAwardNode(i.id)),o&&STORY.checkAwardNode(i.id)&&u.currentLine(i.id),n.fillData()}),r=Net.ws(),[4,r.send("getsettlereward",{chapter_id_list:o})];case 1:if(s=d.sent(),0===s.ret&&s.data&&s.data.settle_reward_info_map){a=s.data.settle_reward_info_map;for(c in a)h=t.getChildByName(c),h.iconReward.visible=a[c].has_new?!0:!1}return[2,!0]}})})},e.prototype.baseLine=function(){var t=this;this.gLine.$children.length<1||Object.keys(this.line).map(function(e){var i=t.gLine.getChildByName(e),n=t.line[e],o=0,r=-100,s=STORY.currentPath.some(function(t){return t==e});if(i){s?i.graphics.lineStyle(2,15920091):i.graphics.lineStyle(2,5921111),i.graphics.moveTo(n[0].x+o,-n[0].y+r);for(var a=1;a<n.length;a++)i.graphics.lineTo(n[a].x+o,-n[a].y+r);i.graphics.endFill(),s?t.gLine.addChild(i):t.gLine.addChildAt(i,0)}else console.error("没有找到 id = "+e+" 的线")})},e.prototype.currentLine=function(t){var e=this.gLine.getChildByName(t),i=this.line[t],n=0,o=-100;if(e){e.graphics.lineStyle(2,15920091),e.graphics.moveTo(i[0].x+n,-i[0].y+o);for(var r=1;r<i.length;r++)e.graphics.lineTo(i[r].x+n,-i[r].y+o);e.graphics.endFill(),this.gLine.addChild(e)}else console.error("没有找到 id = "+t+" 的线")},e.prototype.currentLocation=function(){var t=this.gScroller.width,e=this.gChapter.width,i=this.curX<e/2?0:t-this.curX>e/2?this.curX-e/2:t-e;this.scrollChapter.viewport.scrollH=i,Logger.log("gw:"+e+",vw:"+t+",ratio:"+i)},e.prototype.cachePop=function(t){this.chapterPop=t},e.prototype.clearPop=function(){this.chapterPop&&(this.chapterPop.onClose?this.chapterPop.onClose():this.removeChild(this.chapterPop),this.chapterPop=void 0)},e.prototype.onKeyboard=function(t){switch(t){case 27:this.chapterPop?this.clearPop():this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e.prototype.onWheel=function(t){this.chapterPop||(t=-t,this.gScroller.contentWidth<this.scrollChapter.viewport.width||0>t&&0===this.scrollChapter.viewport.scrollH||t>0&&this.scrollChapter.viewport.scrollH===this.gScroller.contentWidth-this.scrollChapter.viewport.width+42||(clearTimeout(this.scrollTimer),0>t&&this.scrollChapter.viewport.scrollH+t<0?this.scrollChapter.viewport.scrollH=0:t>0&&this.scrollChapter.viewport.scrollH+t>this.gScroller.contentWidth-this.scrollChapter.viewport.width?this.scrollChapter.viewport.scrollH=this.gScroller.contentWidth-this.scrollChapter.viewport.width+42:this.scrollChapter.viewport.scrollH+=t,this.scrollTimer=setTimeout(function(){Effect.play(AUDIO.Storyline_Slide_ogg)},200)))},e}(eui.Component);t.ChapterView=e,__reflect(e.prototype,"Skin.ChapterView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i.keyboard=!1,Events.register("playerEvents",i.listener,i),i.skinName="BadEndSkin",i.data=e,i.BGM=AUDIO.BEUI_BGM_ogg,i.BGMOnce=!0,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return t.prototype.childrenCreated.call(this),this.btnPass.addEventListener(egret.TouchEvent.TOUCH_TAP,this.revive,this),this.btnFree.addEventListener(egret.TouchEvent.TOUCH_TAP,this.revive,this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStart,this),this.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStory,this),Component.buttonMousemove(this.btnReturn),Component.buttonMousemove(this.btnStory),Component.buttonMousemove(this.btnPass),Component.buttonMousemove(this.btnFree),[2]})})},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.data?[3,2]:(t=this,[4,STORY.blockInfo(STORY.blockid)]);case 1:t.data=e.sent(),e.label=2;case 2:return this.data.contentLst&&(this.textTitle.text="【"+this.data.contentLst.InRect+"】 结局达成",this.textInfo.text=this.data.contentLst.BellowRect),this.waiting=!1,this.orderid=Date.now(),[2,!0]}})})},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return Widget.add("Topbar",this),this.showType&&Widget.pop("PopupShare",{id:0,type:SHARE_TYPE.badend,showtype:this.showType}),this.startTween.addEventListener(egret.Event.COMPLETE,function(){t.btnStory.enabled=!0,t.btnFree.enabled=!0,t.btnPass.enabled=!0},this),this.init(),[2]})})},e.prototype.beforeExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.afterExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.init=function(){this.startTween.play(0),this.btnStory.enabled=!1,this.btnFree.enabled=!1,this.btnPass.enabled=!1;var t;NOVICE[NOVICE_TYPE.badend]&&NOVICE[2]||(t=Movie.getMC("liuguang"),t.play(-1),t.x=68,t.y=-16),this.gMedal.y=290,this.image1.visible=!0,this.imgMedal.source="jiesuan_huizhang_icon_png",this.data.bigpic?(this.gMedal.y=217.5,this.image1.visible=!1,this.imgMedal.source=this.data.bigpic+"_png",this.btnPass.visible=!1,this.btnFreepass.visible=!1,this.gStory.x=0):NOVICE[NOVICE_TYPE.badend]?NOVICE[2]?(this.gFirstbadend.visible=!1,this.gFirstrevive.visible=!1,this.btnPass.visible=!0,this.btnFreepass.visible=!1,this.image5.visible=!1,this.image6.visible=!1,this.image7.visible=!1,this.firstTween.stop(),this.freeTween.stop(),this.gStory.x=385):(this.gFirstbadend.visible=!1,this.gFirstrevive.visible=!0,this.btnPass.visible=!1,this.btnFreepass.visible=!0,this.image5.visible=!1,this.image6.visible=!1,this.image7.visible=!1,this.firstTween.stop(),this.freeTween.play(0),this.gStory.x=385,t&&this.gFirstrevive.addChildAt(t,0)):(this.gFirstbadend.visible=!0,this.gFirstrevive.visible=!1,this.btnPass.visible=!1,this.btnFreepass.visible=!1,this.freeTween.stop(),this.firstTween.play(),this.gStory.x=0,t&&this.gFirstbadend.addChildAt(t,0))},e.prototype.listener=function(t){var e=t.data;e&&"exit"===e.channel&&this.complete()},e.prototype.revive=function(){Effect.play(AUDIO.NormalButton_Press_ogg),this.freeTween.play(0),this.freeTween.stop(),Widget.pop("PopupRevive",this.orderid)},e.prototype.toStory=function(){var t=this;this.waiting||(Effect.play(AUDIO.NormalButton_Press_ogg),this.waiting=!0,Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid}).then(function(e){t.waiting=!1,NOVICE[NOVICE_TYPE.badend]?NOVICE[2]||Novice.set(2):Novice.set(NOVICE_TYPE.badend),e&&Scenes.exitUI("Skin.BadEndView").then(function(t){Player.exit()})}))},e.prototype.toStart=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.UI_back_ogg),Scenes.addUI("Skin.StartView").then(function(e){t.waiting=!1,NOVICE[NOVICE_TYPE.badend]?NOVICE[2]||Novice.set(2):Novice.set(NOVICE_TYPE.badend),e&&Scenes.exitUI("Skin.BadEndView").then(function(t){Player.exit()})}))},e.prototype.complete=function(){Scenes.exitUI("Skin.BadEndView"),BGM.currentBGM=void 0},e.prototype.onKeyboard=function(t){switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.BadEndView=e,__reflect(e.prototype,"Skin.BadEndView");var i=function(t){function e(){var e=t.call(this)||this;return e.keyboard=!1,e.skinName="GoodEndSkin",e.BGM=AUDIO.CompleteUI_BGM_ogg,e.BGMOnce=!1,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStart,this),this.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStory,this),this.btnNext.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){if(!e.waiting){e.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg);var t;1===STORY.nextChapterid.length?t=STORY.nextChapterid[0]:Object.keys(STORY.allChaptersInfo).forEach(function(e){var i=STORY.allChaptersInfo[e];i.fromBlockid===STORY.blockid&&STORY.nextChapterid.indexOf(e)>-1&&(t=e)});var i=STORY.chapterInfo(t);STORY.chapterUnlock.length>0&&-1===STORY.chapterUnlock.indexOf(i.index)?Widget.pop("PopupDialog",{title:"提示",content:"2070 - 未完待续，预计3月5日前解锁",button:["确认"],callback:function(t){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(t){return Scenes.exitUI("Skin.GoodEndView"),Player.exit(),Scenes.addUI("Skin.StartView"),[2]})})}}):DLC.checkChapter(i.index).then(function(i){i?Player.listener({channel:"beginfrom",id:t}).then(function(t){BGM.stop(),Scenes.exitUI("Skin.GoodEndView"),e.waiting=!1}):Widget.pop("PopupDialog",{title:"提示",content:"2075 - 请前往商店购买DLC并安装",button:["确认","取消"],callback:function(t){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(e){return t&&(Steam.toSteamStore(),localStorage.setItem("steamInfo","")),Scenes.exitUI("Skin.GoodEndView"),Player.exit(),Scenes.addUI("Skin.StartView"),[2]})})}})})}},this),Component.buttonMousemove(this.btnReturn),Component.buttonMousemove(this.btnStory),Component.buttonMousemove(this.btnNext),this.clearTween.addEventListener(egret.Event.COMPLETE,function(){e.btnNext.enabled=!0,e.btnStory.enabled=!0},this)},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.waiting=!1,[4,this.init()];case 1:return t=e.sent(),[2,t]}})})},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return Widget.add("Topbar",this),[2]})})},e.prototype.beforeExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.afterExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s,a,c=this;return __generator(this,function(h){switch(h.label){case 0:return this.gAward.visible=!1,this.nextTween.stop(),this.image1.alpha=0,this.image2.alpha=0,this.image3.alpha=0,this.btnNext.enabled=!1,this.btnStory.enabled=!1,t=function(){c.firstTween.removeEventListener(egret.Event.COMPLETE,t,c),c.btnNext.enabled=!0,c.btnStory.enabled=!0,NOVICE[NOVICE_TYPE.next]||(c.nextTween.play(0),Novice.set(NOVICE_TYPE.next))},this.firstTween.addEventListener(egret.Event.COMPLETE,t,this),2==this.type?(this.gNext.visible=!1,this.btnStory.x=191):(this.gNext.visible=!0,this.btnStory.x=0),e=Net.ws(),[4,e.send("getsettlereward",{chapter_id_list:[this.id]})];case 1:return i=h.sent(),i.data.settle_reward_info_map&&i.data.settle_reward_info_map[this.id]?(n=i.data.settle_reward_info_map[this.id],n.reward_list.length>0&&1==n.reward_list[0].status?(this.textAward.text=n.reward_list[0].reward_money.coins,this.textAward.visible=!1,this.firstTween.play(0),o=function(){c.textAward.visible=!0},this.firstTween.addEventListener(egret.Event.COMPLETE,o,this),setTimeout(function(){c.gAward.visible=!0},1e3),r=Net.ws(),[4,r.send("recvsettlereward",{chapter_id:this.id,reward_id:n.reward_list[0].reward_id})]):[3,3]):[3,5];case 2:return s=h.sent(),0!==s.ret?[2,!1]:(MALL.coin=s.data.cur_money.coins,[3,4]);
case 3:this.gAward.visible=!1,this.gInfo.y=308,this.clearTween.play(0),h.label=4;case 4:return this.chapterTitle.text=STORY.chapterInfo(STORY.chapterid).ChapterLabel||"没有标题",a=STORY.chapterInfo(this.id),a.complete||(a.complete=!0,a.completeTime=Date.now()),[2,!0];case 5:return[2,!1]}})})},e.prototype.toStory=function(t){var e=this;this.waiting||(Effect.play(AUDIO.NormalButton_Press_ogg),this.waiting=!0,Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid}).then(function(t){e.waiting=!1,t&&(Player.exit(),Scenes.exitUI("Skin.GoodEndView"))}))},e.prototype.toStart=function(){var t=this;this.waiting||(Effect.play(AUDIO.UI_back_ogg),this.waiting=!0,Scenes.addUI("Skin.StartView").then(function(e){t.waiting=!1,e&&(Player.exit(),Scenes.exitUI("Skin.GoodEndView"))}))},e.prototype.onKeyboard=function(t){switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.GoodEndView=i,__reflect(i.prototype,"Skin.GoodEndView",["eui.UIComponent","egret.DisplayObject"]);var n=function(t){function e(e){var i=t.call(this)||this;return i.keyboard=!1,Events.register("playerEvents",i.listener,i),i.skinName="StoryEndSkin",i.data=e,i.BGM=AUDIO.CompleteUI_BGM_ogg,i.BGMOnce=!1,i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){return __awaiter(this,void 0,void 0,function(){var e=this;return __generator(this,function(i){return t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStart,this),this.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStory,this),Component.buttonMousemove(this.btnReturn),Component.buttonMousemove(this.btnStory),this.startTween.addEventListener(egret.Event.COMPLETE,function(){e.btnStory.enabled=!0},this),[2]})})},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.data?[3,2]:(t=this,[4,STORY.blockInfo(STORY.blockid)]);case 1:t.data=e.sent(),e.label=2;case 2:return this.data.contentLst&&(this.textTitle.text="【"+this.data.contentLst.InRect+"】 结局达成",this.textInfo.text=this.data.contentLst.BellowRect),this.waiting=!1,this.orderid=Date.now(),[2,!0]}})})},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return Widget.add("Topbar",this),this.startTween.addEventListener(egret.Event.COMPLETE,function(){t.btnStory.enabled=!0},this),this.init(),[2]})})},e.prototype.beforeExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.afterExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s,a,c,h=this;return __generator(this,function(u){switch(u.label){case 0:return this.btnStory.enabled=!1,this.startTween.play(0),this.gMedal.y=290,this.image1.visible=!0,this.gMedal.y=217.5,this.image1.visible=!1,this.gStory.x=0,this.data.bigpic&&(this.imgMedal.visible=!1,t="jiesuan_ge04"==this.data.bigpic?"jiesuan_ge04":"jiesuan_ge",e=Movie.getDB(this.data.bigpic,this.data.bigpic,t),e.x=0,e.y=240,e.touchEnabled=!1,this.gDB.removeChildren(),this.gDB.addChild(e),e.animation.play(),i=Movie.getDB(this.data.bigpic+"_loop",this.data.bigpic+"_loop",t),i.x=0,i.y=240,i.touchEnabled=!1,n=function(){e.removeEventListener(dragonBones.EventObject.COMPLETE,n,h),h.gDB.removeChildren(),h.gDB.addChild(i),i.animation.play(void 0,0)},e.addEventListener(dragonBones.EventObject.COMPLETE,n,this)),o=Net.ws(),[4,o.send("getsettlereward",{chapter_id_list:[this.id]})];case 1:return r=u.sent(),r.data.settle_reward_info_map&&r.data.settle_reward_info_map[this.id]?(s=r.data.settle_reward_info_map[this.id],s.reward_list.length>0&&1==s.reward_list[0].status&&1==s.reward_list[0].type?(a=Net.ws(),[4,a.send("recvsettlereward",{chapter_id:this.id,reward_id:s.reward_list[0].reward_id})]):[3,3]):[3,3];case 2:if(c=u.sent(),0!==c.ret)return[2,!1];MALL.coin=c.data.cur_money.coins,u.label=3;case 3:return[2]}})})},e.prototype.listener=function(t){var e=t.data;e&&"exit"===e.channel&&this.complete()},e.prototype.toStory=function(){var t=this;this.waiting||(Effect.play(AUDIO.NormalButton_Press_ogg),this.waiting=!0,Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid}).then(function(e){t.waiting=!1,NOVICE[NOVICE_TYPE.badend]?NOVICE[2]||Novice.set(2):Novice.set(NOVICE_TYPE.badend),e&&Scenes.exitUI("Skin.StoryEndSkin").then(function(t){Player.exit()})}))},e.prototype.toStart=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.UI_back_ogg),Scenes.addUI("Skin.StartView").then(function(e){t.waiting=!1,NOVICE[NOVICE_TYPE.badend]?NOVICE[2]||Novice.set(2):Novice.set(NOVICE_TYPE.badend),e&&Scenes.exitUI("Skin.StoryEndSkin").then(function(t){Player.exit()})}))},e.prototype.complete=function(){Scenes.exitUI("Skin.StoryEndSkin"),BGM.currentBGM=void 0},e.prototype.onKeyboard=function(t){switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.StoryEndView=n,__reflect(n.prototype,"Skin.StoryEndView")}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i.keyboard=!0,i.index=0,i.buttonList=["btnResume","btnHome","btnStory","btnSetting","btnExit"],i.waiting=!1,i.skinName="EscSkin",i.btnExit.addEventListener(egret.TouchEvent.TOUCH_TAP,i.exit,i),i.btnResume.addEventListener(egret.TouchEvent.TOUCH_TAP,i.resume,i),i.btnSetting.addEventListener(egret.TouchEvent.TOUCH_TAP,i.toSetting,i),i.btnHome.addEventListener(egret.TouchEvent.TOUCH_TAP,i.toHome,i),i.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,i.toStory,i),i.buttonList.forEach(function(t,e){i[t].addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){i.moveOn(e)},i)}),i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return t.prototype.childrenCreated.call(this),[2]})})},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,!0]})})},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.index&&(this[this.buttonList[this.index]].textColor=16777215),this.index=0,this.btnResume.textColor=16737321,[2]})})},e.prototype.beforeExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.afterExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.exit=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg),Net.ws().logout().then(function(){t.waiting=!1,Steam.exitGame()}))},e.prototype.resume=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.UI_back_ogg),Scenes.exitUI("Skin.EscView").then(function(){t.waiting=!1,Scenes.get("Skin.VideoView").showAllChoice(),Logger.log("------------->"+t.playing+"------------->"),t.playing&&Player.play()}))},e.prototype.toSetting=function(){var t=this;this.waiting||(this.waiting=!0,Scenes.addUI("Skin.SettingView").then(function(e){t.waiting=!1}))},e.prototype.toHome=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg),Scenes.addUI("Skin.StartView").then(function(e){e&&(Scenes.exitUI("Skin.EscView"),Player.exit(PlayerFlag.PS_Home)),t.waiting=!1}))},e.prototype.toStory=function(){var t=this;if(NOVICE[NOVICE_TYPE.choice]){if(this.waiting)return;this.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg),Player.save(PlayerFlag.PS_Story).then(function(e){Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid}).then(function(e){e&&(Scenes.exitUI("Skin.EscView"),Player.exit(PlayerFlag.PS_Story)),t.waiting=!1})})}else Effect.play(AUDIO.UI_Warn_ogg),Toast.show("完成第一个选择后解锁"),this.waiting=!1},e.prototype.moveOut=function(t){this[this.buttonList[t]].textColor=16777215},e.prototype.moveOn=function(t){this.index!==t&&this.moveOut(this.index),this[this.buttonList[t]].textColor=16737321,this.index=t},e.prototype.setIndex=function(t){var e=this.index+t;-1===e&&(e=4),e>4&&(e=0),this.moveOut(this.index),this.moveOn(e)},e.prototype.onKeyboard=function(t){switch(t){case 38:case 40:this.setIndex(t-39);break;case 27:this.btnResume.dispatchEvent(new egret.TouchEvent(mouse.MouseEvent.MOUSE_OVER)),this.btnResume.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP));break;case 13:this[this.buttonList[this.index]].dispatchEvent(new egret.TouchEvent(mouse.MouseEvent.MOUSE_OVER)),this[this.buttonList[this.index]].dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.EscView=e,__reflect(e.prototype,"Skin.EscView")}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.scale=.4985,e.offset=510,e.pool={},e.keyboard=!0,e.skinName="HiddenStorySkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.beforeAdd=function(t){return this.preUI=t,!0},e.prototype.afterAdd=function(t){this.init()},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){},e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.btnLeft.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onRight,this),this.btnRight.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onLeft,this),this.gList.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onStart,this),this.gList.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onMove,this),this.gList.addEventListener(egret.TouchEvent.TOUCH_END,this.onEnd,this),this.gList.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onEnd,this)},e.prototype.onReturn=function(){this.gList.$children.forEach(function(t){t.playing&&t.reset()}),Effect.play(AUDIO.CloseButton_Press_ogg),Scenes.exitUI(),Scenes.get("Skin.RecordView").init()},e.prototype.init=function(){var t=this;this.gList.$children.length>0&&this.groupCache(this.gList);var e=RECORD.localdata.person.story,i=RECORD.hiddenstory,n=RECORD.redpoint,o=[],r=this.scale,s=this.offset,a=0;if(e.map(function(e){if(e.person_id==t.id){var r=i.indexOf(e.id)>-1?!0:!1,s=r&&n.indexOf(e.red_point_id)>-1?!0:!1,c={id:e.id,unlock:r,"new":s,name:e.story_name,tips:e.unlock_tips,image:e.story_pic,video:e.vedio_name,redpoint:e.red_point_id};o.push(c),r&&a++}}),o.length>0)for(var c=0;3>c;c++){var h=c>1&&o.length>3?o.length-1:c;if(o[h]){var u=this.get("Component.HiddenStoryItem",{info:o[h]});u.verticalCenter=0,u.horizontalCenter=2>c?c*s:-s,c>0&&(u.scaleX=r,u.scaleY=r,u.alpha=.4),u.imgCover.visible=!1,u.update(),0==c?this.gList.addChild(u):this.gList.addChildAt(u,0)}}this.list=o,this.step=0,this.textRate.text=this.step+1+"/"+o.length,this.btnLeft.visible=o.length>1?!0:!1,this.btnRight.visible=o.length>1?!0:!1},e.prototype.onLeft=function(){return this.list.length<3&&this.step==this.list.length-1?void Effect.play(AUDIO.UI_Warn_ogg):(Effect.play(AUDIO.NormalButton_Press_ogg),void this.onScroll(-1))},e.prototype.onRight=function(){return this.list.length<3&&0==this.step?void Effect.play(AUDIO.UI_Warn_ogg):(Effect.play(AUDIO.NormalButton_Press_ogg),void this.onScroll(1))},e.prototype.onScroll=function(t){var e=this;if(!this.moveStatus){this.moveStatus=!0;var i=this.list,n=i[this.step-t]?this.step-t:this.step-t>0?0:i.length-1,o=i[n-t]?n-t:n-t>0?0:i.length-1,r=this.gList.$children,s=this.offset*t;this.textRate.text=n+1+"/"+i.length,r.map(function(t){t.info.unlock&&t.onPause();var r=Math.abs(t.horizontalCenter+s)>e.offset?-s:t.horizontalCenter+s,a=0==r?1:e.scale,c=0==r?1:.4;t.btnPlay.touchEnabled=0==r?!0:!1,t.btnPause.touchEnabled=0==r?!0:!1,r==-s&&(t.info=i[o],t.alpha=0,t.update()),0!=r&&e.gList.setChildIndex(t,0),egret.Tween.get(t).to({horizontalCenter:r,scaleX:a,scaleY:a},200).call(function(){t.alpha=c,e.step=n,Logger.log("------this.step"+n),e.moveStatus=!1})})}},e.prototype.onStart=function(t){this.beginX=t.stageX,this.beginY=t.stageY,this.lastX=t.stageX,this.lastY=t.stageY},e.prototype.onMove=function(t){this.lastX=t.stageX,this.lastY=t.stageY},e.prototype.onEnd=function(t){var e=t.stageX-this.beginX;Math.abs(e)>50&&(0>e&&this.onLeft(),e>0&&this.onRight())},e.prototype.unnew=function(t){this.list.some(function(e){return e.id==t?(e["new"]=!1,!0):void 0})},e.prototype.get=function(t,e){var i;if(!this.pool[t]||this.pool[t].length<1){var n=egret.getDefinitionByName(t);try{i=new n}catch(o){Logger.log(t+"创建对象失败")}}else i=this.pool[t].pop();if(e)for(var r in e)i[r]=e[r];return i},e.prototype.cache=function(t){var e=egret.getQualifiedClassName(t);this.pool[e]||(this.pool[e]=[]),this.pool[e].push(t)},e.prototype.groupCache=function(t){for(var e=t.$children,i=0;i<e.length;i++){var n=egret.getQualifiedClassName(e[i]);this.cache(e[i]),"egret.Shape"==n&&e[i].graphics.clear()}t.removeChildren()},e.prototype.onKeyboard=function(t){switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.HiddenStoryView=e,__reflect(e.prototype,"Skin.HiddenStoryView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;e.waiting=!1,e.status=!1,e.skinName="LoginSkin";var i,n=Math.floor(2*Math.random());switch(n){case 0:i="denglu_bg_1920_1080_jpg";break;case 1:i="denglu_bg_1920_1080_2_jpg"}return e.bgLogin.source=i,Logger.log("平台："+Env.app),e.BGM=AUDIO.LoginUI_BGM_ogg,e.keyboard=!0,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnStartGame.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startEvent,this),egret.Tween.get(this.textStart,{loop:!0}).to({alpha:.4},1100,egret.Ease.cubicInOut).to({alpha:1},1100,egret.Ease.cubicInOut),Notice.init().then(function(){e.status=!0})},e.prototype.beforeAdd=function(t){return!0},e.prototype.afterAdd=function(t){Load.group(["common","video","story","qte"]),Effect.play(AUDIO.LoginUI_Jingle_ogg)},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(){},e.prototype.onKeyboard=function(t){this.btnStartGame.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))},e.prototype.startEvent=function(){this.status&&!this.waiting&&(this.waiting=!0,Effect.play(AUDIO.UI_StartPress_ogg),this.startScene())},e.prototype.serverConfig=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return t=[],[4,this.getJSON().then(function(i){var n=i.list_data;n.forEach(function(i,n){var o=new eui.Label("服务器环境选择:"+i.serverName);o.size=30,o.right=0,o.top=55*n,localStorage.getItem("Env_server")||1!=i.releaseServer?localStorage.getItem("Env_server")&&localStorage.getItem("Env_server")==i.serverName&&(Env.server=i):(Env.server=i,localStorage.setItem("Env_server",i.serverName)),o.textColor=i.serverName==localStorage.getItem("Env_server")?14396691:16777215,o.addEventListener(egret.TouchEvent.TOUCH_TAP,function(e){t.map(function(t){return t.textColor=16777215}),e.target.textColor=14396691,Env.server=i,localStorage.setItem("Env_server",i.serverName),Logger.log(Env.server.serverName)},e),t.push(o),e.gServer.addChild(o)})})];case 1:return i.sent(),[2]}})})},e.prototype.getJSON=function(){var t=this,e="resource/json/serverlist.json";return new Promise(function(i){RES.getResByUrl(e,function(t){i(t)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.startScene=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,Login.check()];case 1:return t=i.sent(),0!==t.ret?[3,3]:[4,StoryData.init()];case 2:return(e=i.sent())?(USER.nickname?Scenes.addUI("Skin.StartView"):Scenes.addUI("Skin.NickView"),[3,4]):(Toast.show("网络异常，加载数据失败,请稍后再试。"),this.waiting=!1,[2]);case 3:t.msg?Widget.hasPop()||Toast.show(t.code+" - "+t.msg):Toast.show("通信失败，请1分钟后尝试重新连接。"),i.label=4;case 4:return this.waiting=!1,[2]}})})},e}(eui.Component);t.LoginView=e,__reflect(e.prototype,"Skin.LoginView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.domInput=document.getElementById("egretInput"),e.msg="",e.waiting=!1,e.keyboard=!0,e.skinName="NickSkin",e.width=1920,e.height=1080,e.horizontalCenter=0,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.textInput.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.textNick.visible&&(e.textNick.visible=!1)},this),this.textInput.addEventListener(eui.UIEvent.CHANGE,this.inputCheck,this),this.btnSubmit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSubmit,this),Component.buttonMousemove(this.btnSubmit),this.domInput.addEventListener("compositionstart",function(t){Logger.log("开启非直接输入"),e.composition=!0}),this.domInput.addEventListener("compositionend",function(t){Logger.log("非直接输入完成"),e.composition=!1})},e.prototype.inputCheck=function(){if(!this.composition){var t=this.textInput.text.trim();this.count=0;for(var e="",i=0;i<t.length;i++){var n=t.charAt(i);/^[\u0000-\u00ff]$/.test(n)?this.count+=1:this.count+=2,e=this.count>12?e:e+n}this.count>12&&(this.textInput.text=e,Toast.show("你输入的名字过长"))}},e.prototype.onSubmit=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i;return __generator(this,function(n){switch(n.label){case 0:return this.waiting?[2]:(t=this.textInput.text.trim(),t.length<1?(Toast.show("请输入名字"),[2,!1]):t.length<3?(Toast.show("名字至少2个中文或3个英文，请重新输入"),[2,!1]):/[^\w\u4e00-\u9fa5]+/.test(t)?(Toast.show("该名字包含非法字符，请重新输入"),[2,!1]):(this.waiting=!0,e=Net.ws(),[4,e.send("setnick",{nick:t})]));case 1:return i=n.sent(),0===i.ret&&(USER.nickname=t,Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.NickView")})),this.waiting=!1,[2]}})})},e.prototype.onKeyboard=function(t){switch(t){case 13:this.btnSubmit.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.NickView=e,__reflect(e.prototype,"Skin.NickView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var RANK={},RankStatus;!function(t){t[t.actor_data=0]="actor_data",t[t.explore_status=1]="explore_status",t[t.explore_day_data=2]="explore_day_data",t[t.explore_day_expire=3]="explore_day_expire",t[t.explore_day_timestamp=4]="explore_day_timestamp",t[t.explore_week_data=5]="explore_week_data",t[t.explore_week_expire=6]="explore_week_expire",t[t.explore_week_timestamp=7]="explore_week_timestamp",t[t.explore_total_data=8]="explore_total_data",t[t.explore_total_expire=9]="explore_total_expire",t[t.explore_toggle=10]="explore_toggle",t[t.flower_status=11]="flower_status",t[t.flower_chara_data=12]="flower_chara_data",t[t.flower_chara_expire=13]="flower_chara_expire",t[t.flower_user_day_data=14]="flower_user_day_data",t[t.flower_user_day_expire=15]="flower_user_day_expire",t[t.flower_user_day_timestamp=16]="flower_user_day_timestamp",t[t.flower_user_week_data=17]="flower_user_week_data",t[t.flower_user_week_expire=18]="flower_user_week_expire",t[t.flower_user_week_timestamp=19]="flower_user_week_timestamp",t[t.flower_user_total_data=20]="flower_user_total_data",t[t.flower_user_total_expire=21]="flower_user_total_expire",t[t.flower_user_toggle=22]="flower_user_toggle",t[t.egg_status=23]="egg_status",t[t.egg_chara_data=24]="egg_chara_data",t[t.egg_chara_expire=25]="egg_chara_expire",t[t.egg_user_day_data=26]="egg_user_day_data",t[t.egg_user_day_expire=27]="egg_user_day_expire",t[t.egg_user_day_timestamp=28]="egg_user_day_timestamp",t[t.egg_user_week_data=29]="egg_user_week_data",t[t.egg_user_week_expire=30]="egg_user_week_expire",t[t.egg_user_week_timestamp=31]="egg_user_week_timestamp",t[t.egg_user_total_data=32]="egg_user_total_data",t[t.egg_user_total_expire=33]="egg_user_total_expire",t[t.egg_user_toggle=34]="egg_user_toggle"}(RankStatus||(RankStatus={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.keyboard=!0,e.mouseWheel=!0,e.skinName="RankSkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.beforeAdd=function(t){return this.preUI=t,!0},e.prototype.afterAdd=function(t){Widget.add("Topbar2",this),this.init()},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){},e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.btnExplore.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onExplore,this),this.btnFlower.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onFlower,this),this.btnEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onEgg,this),this.navMousemove(),this.btnExploreAll.addEventListener(egret.TouchEvent.TOUCH_TAP,this.exploreAll,this),this.btnExploreWeek.addEventListener(egret.TouchEvent.TOUCH_TAP,this.exploreWeek,this),this.btnExploreDay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.exploreDay,this),this.btnFlowerAll.addEventListener(egret.TouchEvent.TOUCH_TAP,this.flowerAll,this),this.btnFlowerWeek.addEventListener(egret.TouchEvent.TOUCH_TAP,this.flowerWeek,this),this.btnFlowerDay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.flowerDay,this),this.btnEggAll.addEventListener(egret.TouchEvent.TOUCH_TAP,this.eggAll,this),this.btnEggWeek.addEventListener(egret.TouchEvent.TOUCH_TAP,this.eggWeek,this),this.btnEggDay.addEventListener(egret.TouchEvent.TOUCH_TAP,this.eggDay,this),this.btnFlowerStaff.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("PopupGift",{id:999,name:e.textFlowerStaffName.text,type:"flower",target:e.textFlowerStaff})},this),this.btnEggStaff.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("PopupGift",{id:999,name:e.textEggStaffName.text,type:"egg",target:e.textEggStaff})},this),Component.buttonMousemove(this.btnFlowerStaff),Component.buttonMousemove(this.btnEggStaff),this.flowerandegg(),Events.register("dataChange",this.flowerandegg,this),this.sExplore.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.focusScroller=e.sExplore,e.focusList=e.listExplore},this),this.sFlower.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.focusScroller=e.sFlower,e.focusList=e.listFlower},this),this.sFlowerUser.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.focusScroller=e.sFlowerUser,e.focusList=e.listFlowerUser},this),this.sEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.focusScroller=e.sEgg,e.focusList=e.listEgg},this),this.sEggUser.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.focusScroller=e.sEggUser,e.focusList=e.listEggUser},this)},e.prototype.navMousemove=function(){var t=this,e=[this.btnExplore,this.btnFlower,this.btnEgg,this.btnExploreAll,this.btnExploreWeek,this.btnExploreDay,this.btnFlowerAll,this.btnFlowerWeek,this.btnFlowerDay,this.btnEggAll,this.btnEggWeek,this.btnEggDay];e.map(function(e){e.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){"false"==e.currentState&&(e.currentState="move")},t),e.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){"up"!=e.currentState&&(e.currentState="false")},t),e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"up"!=e.currentState&&(e.currentState="down")},t)})},e.prototype.onReturn=function(){Effect.play(AUDIO.CloseButton_Press_ogg),Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.RankView")})},e.prototype.onExplore=function(){Effect.play(AUDIO.NormalButton_Press_ogg),this.explorelist()},e.prototype.onFlower=function(){this.flowerlist()},e.prototype.onEgg=function(){this.egglist()},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i=this;return __generator(this,function(n){switch(n.label){case 0:return RANK[RankStatus.actor_data]&&0!==RANK[RankStatus.actor_data].length?[3,2]:(t=RANK,e=RankStatus.actor_data,[4,this.getJSON()]);case 1:t[e]=n.sent(),RANK[RankStatus.actor_data].some(function(t){return 999==t.id?(i.textFlowerStaffName.text=t.name,i.textEggStaffName.text=t.name,!0):void 0}),n.label=2;case 2:return this.sExplore.viewport=this.listExplore,this.sFlower.viewport=this.listFlower,this.sFlowerUser.viewport=this.listFlowerUser,this.sEgg.viewport=this.listEgg,this.sEggUser.viewport=this.listEggUser,RANK[RankStatus.explore_status]=!1,RANK[RankStatus.flower_status]=!1,RANK[RankStatus.egg_status]=!1,this.explorelist(),[2]}})})},e.prototype.explorelist=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.btnExplore.currentState="up",this.btnFlower.currentState="false",this.btnEgg.currentState="false",this.gExplore.visible=!0,this.gFlower.visible=!1,this.gEgg.visible=!1,this.focusScroller=this.sExplore,this.focusList=this.listExplore,this.exploreAll(),[2]})})},e.prototype.exploreAll=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnExploreAll.currentState="up",this.btnExploreWeek.currentState="false",this.btnExploreDay.currentState="false",this.gDonate.visible=!0,this.textDonate.text="贡献度",this.textDonate.x=940,this.textUseFlower.text=MALL.flowerUsedTotal.toString(),this.textUseEgg.text=MALL.eggUsedTotal.toString(),this.gExploreUserDay.visible=!1,this.gTipsExploreDay.visible=!1,this.gTipsExploreWeek.visible=!1,this.gTipsExploreTotal.visible=!0,RANK[RankStatus.explore_toggle]="all",t=this.gExploreUserAll.$children,t[0].text=USER.nickname,t[2].text="  探索度  "+STORY.globalExplore,this.textUsedFlower.text="历史送花",this.textUsedEgg.text="历史砸蛋",this.isExpire(RankStatus.explore_total_expire)?[4,this.getRank(11).then(function(i){t[1].text=i.own_rank>0?i.own_rank:"未上榜";var n=[];if(i.fail)n=e.getCache(RankStatus.explore_total_data);else{var o=i.rank_list||[];o.map(function(t){n.push({rank:t.rank,name:t.nick||"",value:(t.exploration/100||0)+"%",donate:!0,flower:t.second_key||0,egg:t.third_key||0})})}n=n.sort(function(t,e){return t.rank-e.rank}),e.setCache(RankStatus.explore_total_data,n),RANK[RankStatus.explore_total_expire]=i.expire_time||0})]:[3,2];case 1:i.sent(),i.label=2;case 2:return this.listRender(RankStatus.explore_total_data,this.listExplore),RANK[RankStatus.explore_status]=!0,[2]}})})},e.prototype.exploreDay=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnExploreAll.currentState="false",this.btnExploreWeek.currentState="false",this.btnExploreDay.currentState="up",this.gDonate.visible=!1,this.textDonate.text="探索度",this.textDonate.x=940,this.gExploreUserDay.visible=!0,this.gTipsExploreDay.visible=!0,this.gTipsExploreWeek.visible=!1,this.gTipsExploreTotal.visible=!1,RANK[RankStatus.explore_toggle]="day",t=this.gExploreUserDay.$children,t[0].text=USER.nickname,this.isExpire(RankStatus.explore_day_expire)?[4,this.getRank(4).then(function(i){t[1].text=i.own_rank>0?i.own_rank:"未上榜",t[2].text="历史最高排名："+(i.own_highest_rank>0?i.own_highest_rank:"未上榜");var n=[];if(i.fail)n=e.getCache(RankStatus.explore_day_data);else{var o=i.rank_list||[];o.map(function(t){n.push({rank:t.rank,name:t.nick||"",value:(t.exploration/100||0)+"%"})})}n=n.sort(function(t,e){return t.rank-e.rank}),e.setCache(RankStatus.explore_day_data,n),RANK[RankStatus.explore_day_expire]=i.expire_time||0})]:[3,2];case 1:i.sent(),i.label=2;case 2:return this.listRender(RankStatus.explore_day_data,this.listExplore),RANK[RankStatus.explore_status]=!0,[2]}})})},e.prototype.exploreWeek=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnExploreAll.currentState="false",this.btnExploreWeek.currentState="up",this.btnExploreDay.currentState="false",this.gDonate.visible=!0,this.textDonate.text="本周贡献度",this.textDonate.x=904,this.textUseFlower.text=MALL.flowerUsedWeek.toString(),this.textUseEgg.text=MALL.eggUsedWeek.toString(),this.gExploreUserDay.visible=!1,this.gTipsExploreDay.visible=!1,this.gTipsExploreWeek.visible=!0,this.gTipsExploreTotal.visible=!1,RANK[RankStatus.explore_toggle]="week",t=this.gExploreUserAll.$children,t[0].text=USER.nickname,t[2].text="  探索度  "+STORY.globalExplore,this.textUsedFlower.text="本周送花",this.textUsedEgg.text="本周砸蛋",this.isExpire(RankStatus.explore_week_expire)?[4,this.getRank(12).then(function(i){t[1].text=i.own_rank>0?i.own_rank:"未上榜";var n=[];if(i.fail)n=e.getCache(RankStatus.explore_week_data);else{var o=i.rank_list||[];o.map(function(t){n.push({rank:t.rank,name:t.nick||"",value:(t.exploration/100||0)+"%",donate:!0,flower:t.second_key||0,egg:t.third_key||0})})}n=n.sort(function(t,e){return t.rank-e.rank}),e.setCache(RankStatus.explore_week_data,n),RANK[RankStatus.explore_week_expire]=i.expire_time||0})]:[3,2];case 1:i.sent(),i.label=2;case 2:return this.listRender(RankStatus.explore_week_data,this.listExplore),RANK[RankStatus.explore_status]=!0,[2]}})})},e.prototype.flowerlist=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return this.btnExplore.currentState="false",this.btnFlower.currentState="up",this.btnEgg.currentState="false",this.gExplore.visible=!1,this.gFlower.visible=!0,this.gEgg.visible=!1,this.focusScroller=this.sFlower,this.focusList=this.listFlower,this.isExpire(RankStatus.flower_chara_expire)?[4,this.getRank(5).then(function(e){var i=[];if(e.fail)i=t.getCache(RankStatus.flower_chara_data);else{var n=e.rank_list||[];n.map(function(e){if(999==e.id)t.textFlowerStaff.text=e.primary_key;else{if(7==e.id||18==e.id)return;RANK[RankStatus.actor_data].some(function(t){if(t.id==e.id){var n={rank:e.rank||0,id:e.id,name:t.name,thumb:t.pic,image:t.img,value:e.primary_key||0,type:"flower"};return i.push(n),!0}})}})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.flower_chara_data,i),RANK[RankStatus.flower_chara_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.flower_chara_data,this.listFlower),this.flowerDay(),[2]}})})},e.prototype.flowerDay=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnFlowerDay.currentState="up",this.btnFlowerWeek.currentState="false",this.btnFlowerAll.currentState="false",this.textFlowerAct.text="今日送花",this.textFlowerUserDay.visible=!0,this.textFlowerUserWeek.visible=!1,this.textFlowerUserAll.visible=!1,RANK[RankStatus.flower_user_toggle]="day",this.isExpire(RankStatus.flower_user_day_expire)?[4,this.getRank(9).then(function(e){RANK[RankStatus.flower_status]||(t.textFlowerUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.flower_user_day_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"flower",day:!0})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.flower_user_day_data,i),RANK[RankStatus.flower_user_day_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.flower_user_day_data,this.listFlowerUser),RANK[RankStatus.flower_status]=!0,[2]
}})})},e.prototype.flowerWeek=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnFlowerDay.currentState="false",this.btnFlowerWeek.currentState="up",this.btnFlowerAll.currentState="false",this.textFlowerAct.text="本周送花",this.textFlowerUserDay.visible=!1,this.textFlowerUserWeek.visible=!0,this.textFlowerUserAll.visible=!1,RANK[RankStatus.flower_user_toggle]="week",this.isExpire(RankStatus.flower_user_week_expire)?[4,this.getRank(13).then(function(e){RANK[RankStatus.flower_status]||(t.textFlowerUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.flower_user_week_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"flower",day:!0})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.flower_user_week_data,i),RANK[RankStatus.flower_user_week_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.flower_user_week_data,this.listFlowerUser),RANK[RankStatus.flower_status]=!0,[2]}})})},e.prototype.flowerAll=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnFlowerDay.currentState="false",this.btnFlowerWeek.currentState="false",this.btnFlowerAll.currentState="up",this.textTipsFlower.visible=!1,this.textFlowerAct.text="历史送花",this.textFlowerUserDay.visible=!1,this.textFlowerUserWeek.visible=!1,this.textFlowerUserAll.visible=!0,RANK[RankStatus.flower_user_toggle]="all",this.focusScroller=this.sFlowerUser,this.focusList=this.listFlowerUser,this.isExpire(RankStatus.flower_user_day_expire)?[4,this.getRank(7).then(function(e){RANK[RankStatus.flower_status]||(t.textFlowerUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.flower_user_total_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"flower"})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.flower_user_total_data,i),RANK[RankStatus.flower_user_total_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.flower_user_total_data,this.listFlowerUser),RANK[RankStatus.flower_status]=!0,[2]}})})},e.prototype.egglist=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return this.btnExplore.currentState="false",this.btnFlower.currentState="false",this.btnEgg.currentState="up",this.gExplore.visible=!1,this.gFlower.visible=!1,this.gEgg.visible=!0,this.focusScroller=this.sEgg,this.focusList=this.listEgg,this.isExpire(RankStatus.egg_chara_expire)?[4,this.getRank(6).then(function(e){var i=[];if(e.fail)i=t.getCache(RankStatus.egg_chara_data);else{var n=e.rank_list||[];n.map(function(e){if(999==e.id)t.textEggStaff.text=e.primary_key;else{if(5==e.id)return;RANK[RankStatus.actor_data].some(function(t){if(t.id==e.id){var n={rank:e.rank||0,id:e.id,name:t.name,thumb:t.pic,image:t.img,value:e.primary_key||0,type:"egg"};return i.push(n),!0}})}})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.egg_chara_data,i),RANK[RankStatus.egg_chara_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.egg_chara_data,this.listEgg),this.eggDay(),[2]}})})},e.prototype.eggDay=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnEggDay.currentState="up",this.btnEggWeek.currentState="false",this.btnEggAll.currentState="false",this.textEggAct.text="今日砸蛋",this.textEggUserDay.visible=!0,this.textEggUserWeek.visible=!1,this.textEggUserAll.visible=!1,RANK[RankStatus.egg_user_toggle]="day",this.isExpire(RankStatus.egg_user_day_expire)?[4,this.getRank(10).then(function(e){RANK[RankStatus.egg_status]||(t.textEggUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.egg_user_day_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"egg",day:!0})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.egg_user_day_data,i),RANK[RankStatus.egg_user_day_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.egg_user_day_data,this.listEggUser),RANK[RankStatus.egg_status]=!0,[2]}})})},e.prototype.eggWeek=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnEggDay.currentState="false",this.btnEggWeek.currentState="up",this.btnEggAll.currentState="false",this.textEggAct.text="本周砸蛋",this.textEggUserDay.visible=!1,this.textEggUserWeek.visible=!0,this.textEggUserAll.visible=!1,RANK[RankStatus.egg_user_toggle]="week",this.isExpire(RankStatus.egg_user_week_expire)?[4,this.getRank(14).then(function(e){RANK[RankStatus.egg_status]||(t.textEggUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.egg_user_week_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"egg",day:!0})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.egg_user_week_data,i),RANK[RankStatus.egg_user_week_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.egg_user_week_data,this.listEggUser),RANK[RankStatus.egg_status]=!0,[2]}})})},e.prototype.eggAll=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return Effect.play(AUDIO.NormalButton_Press_ogg),this.btnEggDay.currentState="false",this.btnEggWeek.currentState="false",this.btnEggAll.currentState="up",this.textTipsEgg.visible=!1,this.textEggAct.text="历史砸蛋",this.textEggUserDay.visible=!1,this.textEggUserWeek.visible=!1,this.textEggUserAll.visible=!0,RANK[RankStatus.egg_user_toggle]="all",this.focusScroller=this.sEggUser,this.focusList=this.listEggUser,this.isExpire(RankStatus.egg_user_total_expire)?[4,this.getRank(8).then(function(e){RANK[RankStatus.egg_status]||(t.textEggUser.text=USER.nickname);var i=[];if(e.fail)i=t.getCache(RankStatus.egg_user_total_data);else{var n=e.rank_list||[];n.map(function(t){i.push({rank:t.rank,name:t.nick||"",value:t.primary_key||0,type:"egg"})})}i=i.sort(function(t,e){return t.rank-e.rank}),t.setCache(RankStatus.egg_user_total_data,i),RANK[RankStatus.egg_user_total_expire]=e.expire_time||0})]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.listRender(RankStatus.egg_user_total_data,this.listEggUser),RANK[RankStatus.egg_status]=!0,[2]}})})},e.prototype.getRank=function(t){return new Promise(function(e){var i=Net.ws();i.send("getRank",{rank_type:t}).then(function(t){0===t.ret?t.data&&e(t.data):(Logger("++++++++++++排行榜数据拉取失败，使用本地缓存"),e({fail:!0}))})})},e.prototype.flowerandegg=function(){this.textUseFlower.text="all"==RANK[RankStatus.explore_toggle]?MALL.flowerUsedTotal.toString():"week"==RANK[RankStatus.explore_toggle]?MALL.flowerUsedWeek.toString():"0",this.textUseEgg.text="all"==RANK[RankStatus.explore_toggle]?MALL.eggUsedTotal.toString():"week"==RANK[RankStatus.explore_toggle]?MALL.eggUsedWeek.toString():"0",this.textFlowerUserDay.text=MALL.flowerUsedDay.toString(),this.textFlowerUserWeek.text=MALL.flowerUsedWeek.toString(),this.textFlowerUserAll.text=MALL.flowerUsedTotal.toString(),this.textEggUserDay.text=MALL.eggUsedDay.toString(),this.textEggUserWeek.text=MALL.eggUsedWeek.toString(),this.textEggUserAll.text=MALL.eggUsedTotal.toString()},e.prototype.charaRefresh=function(t,e,i){var n,o="flower"==t?RANK[RankStatus.flower_chara_data]:RANK[RankStatus.egg_chara_data],r="flower"==t?this.listFlower:this.listEgg;switch(999>e&&(o.some(function(t,o){return t.id==e?(t.value+=i,n=o,!0):void 0}),o=o.sort(function(t,e){return t.value==e.value?t.id-e.id:e.value-t.value}),o.some(function(t,i){return t.id==e?(i!=n&&(r.dataProvider=new eui.ArrayCollection(o)),!0):void 0})),t){case"flower":"day"==RANK[RankStatus.flower_user_toggle]?this.flowerDay():"week"==RANK[RankStatus.flower_user_toggle]?this.flowerWeek():"all"==RANK[RankStatus.flower_user_toggle]&&this.flowerAll();break;case"egg":"day"==RANK[RankStatus.egg_user_toggle]?this.eggDay():"week"==RANK[RankStatus.egg_user_toggle]?this.eggWeek():"all"==RANK[RankStatus.egg_user_toggle]&&this.eggAll()}},e.prototype.listRender=function(t,e){var i=this.getCache(t),n=[];if(i.map(function(t){Object.keys(t).length>0&&n.push(t)}),n=n.sort(function(t,e){return t.rank-e.rank}),t!=RankStatus.egg_chara_data&&t!=RankStatus.flower_chara_data)for(var o=n.length;20>o;)n.push({}),o++;var r=new eui.ArrayCollection(n);e.dataProvider=r,e.itemRenderer=t==RankStatus.egg_chara_data||t==RankStatus.flower_chara_data?Component.RankCharaItem:t==RankStatus.explore_day_data||t==RankStatus.explore_week_data||t==RankStatus.explore_total_data?Component.RankListItem:Component.RankUserItem,e.dataProviderRefreshed()},e.prototype.getJSON=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/actorData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.isExpire=function(t){return!RANK[t]||Time.now()-Time.getDiff()>RANK[t]?!0:!1},e.prototype.setCache=function(t,e){switch(RANK[t]=e,console.log("正确设置"+RankStatus[t]+"列表缓存"),t){case RankStatus.explore_day_data:RANK[RankStatus.explore_day_timestamp]=Time.now(),console.log("正确设置"+RankStatus[t]+"列表时间戳");break;case RankStatus.flower_user_day_data:RANK[RankStatus.flower_user_day_timestamp]=Time.now(),console.log("正确设置"+RankStatus[t]+"列表时间戳");break;case RankStatus.egg_user_day_data:RANK[RankStatus.egg_user_day_timestamp]=Time.now(),console.log("正确设置"+RankStatus[t]+"列表时间戳")}},e.prototype.getCache=function(t){return RANK[t]?(console.log("正确读取"+RankStatus[t]+"列表缓存"),RANK[t]||[]):[]},e.prototype.onKeyboard=function(t){switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP));break;case 13:}},e.prototype.onWheel=function(t){Widget.currentPop||(t=-t,0>t&&0===this.focusScroller.viewport.scrollV||t>0&&this.focusScroller.viewport.scrollV===this.focusList.contentHeight-this.focusScroller.viewport.height||this.focusList.contentHeight<this.focusScroller.viewport.height||(0>t&&this.focusScroller.viewport.scrollV+t<0?this.focusScroller.viewport.scrollV=0:t>0&&this.focusScroller.viewport.scrollV+t>this.focusList.contentHeight-this.focusScroller.viewport.height?this.focusScroller.viewport.scrollV=this.focusList.contentHeight-this.focusScroller.viewport.height:this.focusScroller.viewport.scrollV+=t))},e}(eui.Component);t.RankView=e,__reflect(e.prototype,"Skin.RankView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.index=0,e.mouseWheel=!0,e.keyboard=!0,e.skinName="RecordSkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.beforeAdd=function(t){return this.preUI=t,!0},e.prototype.afterAdd=function(t){Widget.add("Topbar2",this),this.init()},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){},e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.btnPerson.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPerson,this),this.btnAchieve.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onAchieve,this),this.navMousemove(),this.sAchieve.verticalScrollBar=this.scrollbar,this.sAchieve.scrollPolicyV="auto",this.scrollbar.autoVisibility=!1,this.sPerson.addEventListener(eui.UIEvent.CHANGE_START,function(t){Effect.play(AUDIO.Storyline_Slide_ogg)},this),this.sAchieve.addEventListener(eui.UIEvent.CHANGE_START,function(t){Effect.play(AUDIO.Storyline_Slide_ogg)},this)},e.prototype.navMousemove=function(){var t=this,e=[this.btnPerson,this.btnAchieve];e.map(function(e){e.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){"false"==e.currentState&&(e.currentState="move")},t),e.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){"up"!=e.currentState&&(e.currentState="false")},t),e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){"up"!=e.currentState&&(e.currentState="down")},t)})},e.prototype.onReturn=function(){var t=this;switch(Effect.play(AUDIO.UI_back_ogg),this.preUI){case"Skin.VideoView":Scenes.exitUI("Skin.RecordView").then(function(e){e&&(t.status&&Player.play(),BGM.stop(),Scenes.get("Skin.VideoView").btnSkip.currentState="up")});break;case"Skin.StartView":Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.RecordView")});break;default:Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.RecordView")})}Logger.log(this.preUI)},e.prototype.onPerson=function(){Effect.play(AUDIO.NormalButton_Press_ogg),this.personList()},e.prototype.onAchieve=function(){Effect.play(AUDIO.NormalButton_Press_ogg),this.achieveList()},e.prototype.getJSON=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/recordData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return 0!==Object.keys(RECORD.localdata).length?[3,2]:(t=RECORD,[4,this.getJSON()]);case 1:t.localdata=e.sent(),e.label=2;case 2:return this.sPerson.viewport=this.listPerson,this.sAchieve.viewport=this.listAchieve,this.personStatus=!1,this.achieveStatus=!1,this.achieveCount=0,this.personList(),[2]}})})},e.prototype.setIndex=function(t){var e=["btnPerson","btnAchieve"],i=this.index+t;i>1&&(i=0),0>i&&(i=1),this[e[i]].dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))},e.prototype.personList=function(){if(this.btnAchieve.currentState="false",this.btnPerson.currentState="up",this.sAchieve.visible=!1,this.sPerson.visible=!0,this.scrollbar.visible&&(this.scrollbar.visible=!1),this.mouseFocus=1,this.redpoint(),this.iconPersonNew.visible=!1,this.index=0,!this.personStatus&&RECORD.localdata&&RECORD.personinfo){var t=RECORD.localdata.person,e=t.config,i=RECORD.personinfo,n=[];e.map(function(t){var e=i.some(function(e,i){if(t.person_id==e.person_id){var o={id:t.person_id,unlock:!0,name:t.name,image:t.unlock_pic,value:e.person_value_list,desc:e.desc_id_list};return n.push(o),!0}});e||n.push({id:t.person_id,unlock:!1,image:t.lock_pic})}),n.sort(function(t,e){return t.unlock==e.unlock?t.id-e.id:1==t.unlock?-1:1});var o=new eui.ArrayCollection(n);this.listPerson.dataProvider=o,this.listPerson.itemRenderer=Component.Record_PersonListItem,this.listPerson.dataProviderRefreshed(),this.personStatus=!0}},e.prototype.achieveList=function(t){if(this.btnPerson.currentState="false",this.btnAchieve.currentState="up",this.sPerson.visible=!1,this.sAchieve.visible=!0,this.mouseFocus=2,this.index=2,this.redpoint(),this.iconAchieveNew.visible=!1,this.scrollbar.visible=this.achieveCount>8?!0:!1,!this.achieveStatus||t){var e=RECORD.localdata.achieve,i=RECORD.achievement,n=[];e.map(function(t){if(!(t.recoed_show_type<2)){var e=i.some(function(e){return e.achievement_id==t.id?!0:void 0}),o={id:t.id,group:t.group_id,unlock:e,name:t.name,desc:t.desc,smallpic:t.small_pic,bigpic:t.big_pic,quest:t.quest_id,progresstype:t.prgress_showtype,redpoint:t.red_point_id};if(t.group_id>0){var r=n.some(function(i,r){return i.group==t.group_id?(e&&(n[r]=o),!0):void 0});r||n.push(o)}else n.push(o)}});var o=new eui.ArrayCollection(n);this.listAchieve.dataProvider=o,this.listAchieve.itemRenderer=Component.Record_AchieveListItem,this.listAchieve.dataProviderRefreshed(),this.achieveStatus=!0,this.achieveCount=n.length,this.scrollbar.visible=this.achieveCount>8?!0:!1,this.scrollbar.thumb.height=this.scrollbar.viewport.height*(2/(this.achieveCount/4))}},e.prototype.redpoint=function(){var t=RECORD.redpoint,e=RECORD.localdata.achieve,i=RECORD.achievement,n=[];e.map(function(t){var e=i.some(function(e){return e.achievement_id==t.id?!0:void 0}),o={group:t.group_id,unlock:e,redpoint:t.red_point_id};if(t.group_id>0){var r=n.some(function(i,r){return i.group==t.group_id?(e&&(n[r]=o),!0):void 0});r||n.push(o)}else n.push(o)});var o=n.some(function(e){return e.unlock&&e.redpoint&&t.indexOf(e.redpoint)>-1?!0:void 0});this.iconAchieveNew.visible=o;var r=RECORD.localdata.person.story,s=RECORD.hiddenstory.some(function(e){var i=r.some(function(i,n){return i.id==e&&t.indexOf(i.red_point_id)>-1?!0:void 0});return i});this.iconPersonNew.visible=s},e.prototype.onWheel=function(t){if(!Widget.currentPop)switch(t=-t,this.mouseFocus){case 1:if(0>t&&0===this.sPerson.viewport.scrollH||t>0&&this.sPerson.viewport.scrollH===this.listPerson.contentWidth-this.sPerson.viewport.width||this.listPerson.contentWidth<this.sPerson.viewport.width)return;0>t&&this.sPerson.viewport.scrollH+t<0?this.sPerson.viewport.scrollH=0:t>0&&this.sPerson.viewport.scrollH+t>this.listPerson.contentWidth-this.sPerson.viewport.width?this.sPerson.viewport.scrollH=this.listPerson.contentWidth-this.sPerson.viewport.width:this.sPerson.viewport.scrollH+=t;break;case 2:if(0>t&&0===this.sAchieve.viewport.scrollV||t>0&&this.sAchieve.viewport.scrollV===this.listAchieve.contentHeight-this.sAchieve.viewport.height||this.listAchieve.contentHeight<this.sAchieve.viewport.height)return;0>t&&this.sAchieve.viewport.scrollV+t<0?this.sAchieve.viewport.scrollV=0:t>0&&this.sAchieve.viewport.scrollV+t>this.listAchieve.contentHeight-this.sAchieve.viewport.height?this.sAchieve.viewport.scrollV=this.listAchieve.contentHeight-this.sAchieve.viewport.height:this.sAchieve.viewport.scrollV+=t}},e.prototype.onKeyboard=function(t){if(!Widget.currentPop)switch(t){case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP));break;case 38:this.setIndex(1);break;case 40:this.setIndex(t-39)}},e}(eui.Component);t.RecordView=e,__reflect(e.prototype,"Skin.RecordView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.titleList=["soundTitle","effectTitle","bgmTitle","screenTitle"],e.waiting=!1,e.keyboard=!0,e.settingIndex=0,e.origin={fullscreen:!0,displayWidth:0,displayHeight:0,volume:1,bgm:!0,effect:!0},e.skinName="SettingSkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.beforeAdd=function(t){return this.preUI=t,!0},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.settingInit(),[2]})})},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){},e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.sliderSound.addEventListener(egret.TouchEvent.CHANGE,this.onSound,this),this.sliderSound.thumb.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.sliderSound.currentState="move"},this),this.sliderSound.thumb.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.sliderSound.currentState="up"},this),this.sliderSound.thumb.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){e.sliderSound.currentState="down"},this),this.sliderSound.thumb.addEventListener(egret.TouchEvent.TOUCH_END,function(){e.sliderSound.currentState="move"},this),this.btnAudioLeft.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onEffect,this),this.btnAudioRight.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onEffect,this),this.btnResolutionLeft.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onScreenMode,this),this.btnResolutionRight.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onScreenMode,this),this.btnBgmLeft.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBgm,this),this.btnBgmRight.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBgm,this),this.btnAbout.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onAbout,this),Component.buttonMousemove(this.btnAbout),["gSound","gEffect","gBgm","gScreen"].forEach(function(t,i){e[t].addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.moveOver(i)},e),e[t].addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.moveOut(i)},e)}),Events.register("steam-listener-setting",function(t){var i=t.data;e.fullscreen=i.fullscreen,e.changeMode()},this);var i=new eui.Label;i.size=16,i.bottom=20,i.right=20,i.alpha=.5,i.textColor=11250603,i.text="version = "+Env.version+" | steamid = "+USER.openid,this.addChild(i)},e.prototype.onReturn=function(){var t=this;Effect.play(AUDIO.UI_back_ogg);var e=Object.keys(this.customSetting).some(function(e){return t.customSetting[e]!==t.origin[e]});e&&(Logger.log(this.customSetting),Steam.updateSetting(this.customSetting).then(function(t){}),Logger.log("updateSetting succ")),("Skin.VideoView"===this.preUI||"Skin.EscView"===this.preUI)&&(this.status&&Player.play(),this.status=!1,BGM.stop()),Scenes.exitUI("Skin.SettingView").then(function(t){})},e.prototype.settingInit=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,Steam.getSystemInfo()];case 1:return t=e.sent(),0===t.ret&&(this.customSetting=t.data.custom,this.customSetting.displayWidth&&this.customSetting.displayHeight||(this.customSetting.displayWidth=window.screen.width,this.customSetting.displayHeight=window.screen.height),this.origin=Object.assign(this.origin,this.customSetting),this.sliderSound.value=100*USER.volume,this.effect=this.customSetting.effect,this.bgm=this.customSetting.bgm,this.fullscreen=this.customSetting.fullscreen),this.settingIndex=0,this.changeEffect(),this.changeBgm(),this.changeMode(),[2]}})})},e.prototype.onSound=function(){Volume.set(this.sliderSound.value/100),this.customSetting.volume=this.sliderSound.value/100,("Skin.VideoView"==this.preUI||"Skin.EscView"==this.preUI)&&Scenes.get("Skin.VideoView").initSound()},e.prototype.onEffect=function(t){if("disabled"!=t.target.currentState){switch(t.target.skewY){case 0:this.effect=!1;break;case 180:this.effect=!0}Effect.play(AUDIO.NormalButton_Press_ogg),this.changeEffect()}},e.prototype.changeEffect=function(){Logger.log("音效开关："+this.effect),this.customSetting.effect=this.effect,USER.effect=this.effect,this.textAudio.text=this.effect?"开启":"关闭",this.textAudio.alpha=this.effect?1:.35,this.btnAudioLeft.currentState=this.effect?"up":"disabled",this.btnAudioRight.currentState=this.effect?"disabled":"up"},e.prototype.onScreenMode=function(t){if("disabled"!=t.target.currentState){switch(t.target.skewY){case 0:this.fullscreen=!1;break;case 180:this.fullscreen=!0}Effect.play(AUDIO.NormalButton_Press_ogg),this.changeMode()}},e.prototype.changeMode=function(){Logger.log("音效开关："+this.effect),this.customSetting.fullscreen=this.fullscreen,this.textResolution.text=this.fullscreen?"全屏":"窗口",this.btnResolutionLeft.currentState=this.fullscreen?"up":"disabled",this.btnResolutionRight.currentState=this.fullscreen?"disabled":"up"},e.prototype.onBgm=function(t){if("disabled"!=t.target.currentState){switch(t.target.skewY){case 0:this.bgm=!1;break;case 180:this.bgm=!0}Effect.play(AUDIO.NormalButton_Press_ogg),this.changeBgm()}},e.prototype.changeBgm=function(){this.bgm?(this.textBgm.text="开启",this.textBgm.alpha=1,this.btnBgmLeft.currentState="up",this.btnBgmRight.currentState="disabled"):(this.textBgm.text="关闭",this.textBgm.alpha=.35,this.btnBgmLeft.currentState="disabled",this.btnBgmRight.currentState="up"),USER.bgm=this.bgm,this.customSetting.bgm=this.bgm,BGM.setVolume(USER.volume)},e.prototype.onAbout=function(){Effect.play(AUDIO.NormalButton_Press_ogg),Logger.log("关于按钮")},e.prototype.setSettingIndex=function(t){var e=this.settingIndex+t;e>3&&(e=0),0>e&&(e=3),this.moveOver(e)},e.prototype.setSettingValue=function(t){var e=this;if(!this.waiting){this.waiting=!0;var i,n,o=this.settingIndex;switch(o){case 0:this.sliderSound.currentState="down",this.sliderSound.value+=t?-5:5,this.sliderSound.value<0&&(this.sliderSound.value=0),this.sliderSound.value>=100&&(this.sliderSound.value=100),this.onSound(),setTimeout(function(){e.sliderSound.currentState="up",e.waiting=!1},500);break;case 1:i=t?this.btnAudioLeft:this.btnAudioRight,n=i.currentState,"disabled"!=i.currentState&&(i.currentState="down"),setTimeout(function(){i.currentState=n,i.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP)),e.waiting=!1},100);break;case 2:i=t?this.btnBgmLeft:this.btnBgmRight,n=i.currentState,"disabled"!=i.currentState&&(i.currentState="down"),setTimeout(function(){i.currentState=n,i.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP)),e.waiting=!1},100);break;case 3:i=t?this.btnResolutionLeft:this.btnResolutionRight,n=i.currentState,"disabled"!=i.currentState&&(i.currentState="down"),setTimeout(function(){i.currentState=n,i.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP)),e.waiting=!1},100)}}},e.prototype.moveOut=function(t){this[this.titleList[t]].textColor=11053224},e.prototype.moveOver=function(t){this.settingIndex!==t&&(this[this.titleList[this.settingIndex]].textColor=11053224),this[this.titleList[t]].textColor=16777215,this.settingIndex=t},e.prototype.onKeyboard=function(t){switch(t){case 38:this.setSettingIndex(-1);break;case 40:this.setSettingIndex(1);break;case 37:this.setSettingValue(!0);break;case 39:this.setSettingValue(!1);break;case 27:this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))}},e}(eui.Component);t.SettingView=e,__reflect(e.prototype,"Skin.SettingView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.waiting=!1,e.keyboard=!0,e.selectedIndex=0,e.buttonList=["btnStart","btnRank","btnStory","btnSetting","btnRecord","btnExit"],e.initStatus=!1,e.skinName="StartSkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e.btnSetting.label="设置",e.btnExit.label="退出",e.btnRank.label="排行榜",e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnStart.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toPlay,this),this.btnRecord.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toRecord,this),this.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toStory,this),this.btnSetting.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toSetting,this),this.btnExit.addEventListener(egret.TouchEvent.TOUCH_TAP,this.exit,this),this.btnRank.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toRank,this),Load.group(["popup","preload","story","setting","rank"]),NOVICE[NOVICE_TYPE.choice]||Load.group(["novice"]),this.percentBar.minimum=0,this.percentBar.maximum=100,this.percentBar.thumb.width=this.percentBar.width,this.textPercent.text="探索度："+STORY.globalExplore,this.percentBar.value=parseInt(STORY.globalExplore),Events.register("dataChange.STORY.globalExplore",this.onExplore,this),Share.init(),this.btnStart.buttonTween.addEventListener(egret.Event.COMPLETE,function(){0===e.selectedIndex&&(e.btnStart.currentState="move")},this),this.btnExit.buttonTween.addEventListener(egret.Event.COMPLETE,function(){e.redpoint()},this),this.dbEgg=Movie.getDB("caidan","caidan"),this.dbEgg.touchEnabled=!1,this.gDB.addChild(this.dbEgg),this.dbLoop=Movie.getDB("annxunhuan","annxunhuan"),this.dbLoop.touchEnabled=!1,this.dbLoop2=Movie.getDB("hzxunhuang","hzxunhuang"),this.dbLoop2.touchEnabled=!1;var i=function(){e.dbEgg.removeEventListener(dragonBones.EventObject.COMPLETE,i,e),e.gDB.addChild(e.dbLoop),e.dbLoop.animation.play(void 0,-1),e.gDB.addChild(e.dbLoop2),e.dbLoop2.animation.play(void 0,-1)};this.dbEgg.addEventListener(dragonBones.EventObject.COMPLETE,i,this),this.btnEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("HiddenStoryItem",{id:e.egg,name:"红色芳华",video:"https://www.npcstudio.cn/videos/mv/"+e.egg+".mp4"})},this),this.gEgg.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("HiddenStoryItem",{id:e.egg,name:"红色芳华",video:"https://www.npcstudio.cn/videos/mv/"+e.egg+".mp4"})},this),this.gEgg.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){return e.dbEgg.alpha=.8},this),this.gEgg.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){return e.dbEgg.alpha=1},this)},e.prototype.beforeAdd=function(t){Widget.add("Topbar",this);var e,i=Math.floor(4*Math.random());switch(i){case 0:e="shouye_bg1920_1080_jpg";break;case 1:e="zhujiemian1_jpg";break;case 2:e="zhujiemian2_jpg";break;case 3:e="zhujiemian3_jpg"}return this.bgImage.source=e,!0},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return"Skin.LoginView"===t&&Scenes.exitUI(t),this.novice(),this.initStatus&&this.redpoint(),this.initStatus?"move"!==this[this.buttonList[this.selectedIndex]].currentState&&(this[this.buttonList[this.selectedIndex]].currentState="move"):this.init(),UNGET&&Widget.pop("PopupGetItem",{list:UNGET}),this.egg="5eb5ccb3864f444fa88080ffcad017ca",this.gEgg.visible=STORY.checkAwardNode("5eb5ccb3864f444fa88080ffcad017ca"),this.gEgg.visible&&(!this.eggSwitch&&this.dbEgg.animation.play(void 0,1),this.eggSwitch=!0),Prompt.promptSwitch||(Prompt.promptSwitch=!0,Prompt.show()),[2]})})},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(){},e.prototype.init=function(){var t=this;this.selectedIndex=0,this.gNew.visible=!1,setTimeout(function(){t.btnStart.buttonTween.play(0),t.btnStory.buttonTween.play(0),t.btnRecord.buttonTween.play(0),t.btnRank.buttonTween.play(0),t.btnSetting.buttonTween.play(0),t.btnExit.buttonTween.play(0)},500),this.initStatus=!0},e.prototype.novice=function(){this.btnStart.label=NOVICE[NOVICE_TYPE.start]?"继续潜伏":"开始潜伏",this.btnStory.currentState=NOVICE[NOVICE_TYPE.choice]?"up":"disabled",this.btnRecord.currentState=NOVICE[NOVICE_TYPE.choice]?"up":"disabled",this.btnRank.currentState="up"},e.prototype.toPlay=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return this.waiting?[2]:(this.waiting=!0,Effect.play(AUDIO.PlayButton_Press_ogg),Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(){t.waiting=!1}),[2])})})},e.prototype.toRecord=function(){var t=this;Logger.log("去档案"),this.waiting||(this.waiting=!0,NOVICE[NOVICE_TYPE.choice]?(Effect.play(AUDIO.BigButton_Press_ogg),Scenes.addUI("Skin.RecordView").then(function(){t.waiting=!1})):(Effect.play(AUDIO.UI_Warn_ogg),Toast.show("完成第一个选择后解锁"),this.waiting=!1))},e.prototype.toStory=function(){var t=this;this.waiting||(this.waiting=!0,NOVICE[NOVICE_TYPE.choice]?(Effect.play(AUDIO.BigButton_Press_ogg),Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid,preUI:"Skin.StartView"}).then(function(){t.waiting=!1})):(Effect.play(AUDIO.UI_Warn_ogg),Toast.show("完成第一个选择后解锁"),this.waiting=!1))},e.prototype.toSetting=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.Set_Press_ogg),Scenes.addUI("Skin.SettingView").then(function(){t.waiting=!1}))},e.prototype.toRank=function(){var t=this;this.waiting||(this.waiting=!0,Effect.play(AUDIO.NormalButton_Press_ogg),Scenes.addUI("Skin.RankView").then(function(){t.waiting=!1}))},e.prototype.exit=function(){Effect.play(AUDIO.BigButton_Press_ogg),setTimeout(function(){"steam"===Env.app&&Steam.exitGame()},200)},e.prototype.onExplore=function(){Logger.log("探索度变化"),this.textPercent.text="探索度："+STORY.globalExplore,this.percentBar.value=parseInt(STORY.globalExplore)},e.prototype.redpoint=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return this.iconStoryNew.visible=!1,this.iconRecordNew.visible=!1,this.gNew.visible=!0,RECORD.redpoint.length>0&&(this.iconRecordNew.visible=!0),t=Net.ws(),[4,t.send("getcharpter")];
case 1:return e=a.sent(),0===e.ret&&e.data&&(i=e.data,i.charpter_list&&i.charpter_list.length>0&&i.charpter_list.map(function(t){var e=t.charpter_id;STORY.chapterInfo(e)&&t.lock_end_time<i.timenow&&!STORY.chapterInfo(e).unlocked&&(STORY.chapterInfo(e).unlocked=!0)})),STORY.chapterhasnew&&STORY.allPath.length>0,n=[],Object.keys(STORY.allChaptersInfo).map(function(t){var e=STORY.allChaptersInfo[t];"global"!=t&&"GeEggNode"!==e.type&&n.push(t)}),[4,t.send("getsettlereward",{chapter_id_list:n})];case 2:if(o=a.sent(),0==o.ret&&o.data&&o.data.settle_reward_info_map){r=o.data.settle_reward_info_map;for(s in r)if(r[s].has_new)return this.iconStoryNew.visible=!0,[2,!0]}return[2]}})})},e.prototype.getEgg=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/eggInfo.json",function(i){Object.keys(i).map(function(e){"红色芳华"==i[e].ChapterLabel&&(t.egg=e)}),e(i)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.onKeyboard=function(t){var e=this,i=function(t,o){var r=n[t][o];return"disabled"===e[e.buttonList[r]].currentState?i(r,o):r},n={0:{L:1,T:4,R:1,B:2},1:{L:0,T:5,R:2,B:3},2:{L:1,T:0,R:3,B:4},3:{L:2,T:1,R:4,B:5},4:{L:3,T:2,R:5,B:0},5:{L:4,T:3,R:0,B:1}},o={87:"T",38:"T",83:"B",40:"B",65:"L",37:"L",68:"R",39:"R"};switch(t){case 87:case 83:case 68:case 65:case 38:case 40:case 37:case 39:var r=o[t],s=i(this.selectedIndex,r);s!==this.selectedIndex&&(this[this.buttonList[this.selectedIndex]].currentState="",this[this.buttonList[s]].currentState="move",this.selectedIndex=s);break;case 13:var a=this[this.buttonList[this.selectedIndex]];a.currentState="down",setTimeout(function(){a.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP))},300)}},e.prototype.setIndex=function(t){var e=this.buttonList.indexOf(t);if(-1!==e){var i=this[t];"disabled"!==i.currentState&&(i.currentState="move",this.selectedIndex!==e&&(this[this.buttonList[this.selectedIndex]].currentState="up",this.selectedIndex=e))}},e}(eui.Component);t.StartView=e,__reflect(e.prototype,"Skin.StartView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.endNum=0,e.pool={},e.keyboard=!0,e.mouseWheel=!0,e.skinName="StorySkin",e.BGM=AUDIO.MainMenu_BGM_ogg,e}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){var e=this;t.prototype.childrenCreated.call(this),this.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onReturn,this),Component.buttonMousemove(this.btnReturn),this.btnHelp.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Widget.pop("PopupHelp"),Effect.play(AUDIO.NormalButton_Press_ogg)},this),Component.buttonMousemove(this.btnHelp),this.btnLocation.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onLocation,this),this.gTitle.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toChapter,this),Component.buttonMousemove(this.btnAllchapter),this.percentBar.minimum=0,this.percentBar.maximum=100,this.percentBar.thumb.width=this.percentBar.width,this.scrollStory.addEventListener(eui.UIEvent.CHANGE_START,function(t){e.scrollH=e.scrollStory.viewport.scrollH,Effect.play(AUDIO.Storyline_Slide_ogg)},this),this.scrollStory.addEventListener(eui.UIEvent.CHANGE_END,function(t){e.scrollH=e.scrollStory.viewport.scrollH},this)},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return[4,StoryData.blockPath()];case 1:return e=i.sent(),e?("Skin.ChapterView"!=t&&(this.preUI=t),this.init(this.chapterId),[2,!0]):[2,!1]}})})},e.prototype.afterAdd=function(t){Widget.add("Topbar",this)},e.prototype.beforeExit=function(){},e.prototype.afterExit=function(t){Widget.add("Topbar",Scenes.get("Skin.StartView"))},e.prototype.onReturn=function(){switch(Effect.play(AUDIO.UI_back_ogg),this.preUI){case"Skin.VideoView":case"Skin.EscView":Scenes.addUI("Skin.VideoView",{cmd:"choice",params:{choice:-1,idx:0}}).then(function(t){t&&Scenes.exitUI("Skin.StoryView")});break;case"Skin.StartView":Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.StoryView")});break;default:Scenes.addUI("Skin.StartView").then(function(t){t&&Scenes.exitUI("Skin.StoryView")})}Logger.log(this.preUI)},e.prototype.toChapter=function(){Effect.play(AUDIO.AllChapButton_Press_ogg),Scenes.addUI("Skin.ChapterView"),this.image.visible&&(this.titleTween.stop(),this.image.visible=!1,this.image0.visible=!1,this.image1.visible=!1)},e.prototype.init=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.endNum=0,this.chapterId=t,this.award=void 0,this.storyPop=void 0,this.chapterId==STORY.chapterid?this.btnLocation.buttonTween.stop():this.btnLocation.buttonTween.play(0),this.lightTween.play(0),this.initKeyPerson(),[4,this.draw(t)];case 1:return e.sent(),this.initEnds(),this.currentLocation(),this.guide(),this.redpoint(),[2]}})})},e.prototype.guide=function(){NOVICE[NOVICE_TYPE.story]?NOVICE[NOVICE_TYPE.allchapter]?(this.gNovice.visible=!1,this.titleTween.stop(),this.image.visible=!1,this.image0.visible=!1,this.image1.visible=!1):(this.gNovice.visible=!1,this.titleTween.play(0),Novice.set(NOVICE_TYPE.allchapter)):(Widget.pop("PopupHelp"),Novice.set(NOVICE_TYPE.story))},e.prototype.initKeyPerson=function(){var t=STORY.chapterInfo(this.chapterId);if(t.keyPerson){var e=0,i=t.keyPerson.personid,n=(t.keyPerson.name,t.keyPerson.valueid),o=StoryData.getPerson(i);o&&o.person_value_list.length>0&&o.person_value_list.some(function(t){return t.value_id===n?(e=t.value,!0):void 0}),this.gPerson.visible=!0,this.personValue.text=t.keyPerson.name+" "+e}else this.gPerson.visible=!1},e.prototype.initEnds=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r;return __generator(this,function(s){switch(s.label){case 0:return 0!==Object.keys(RECORD.localdata).length?[3,2]:(t=RECORD,[4,this.getJSON()]);case 1:t.localdata=s.sent(),s.label=2;case 2:return e=STORY.chapterInfo(this.chapterId),i=e.index+1,n=RECORD.questinfo,o=RECORD.localdata.chaptertoquest,o.some(function(t){return t.charpter_uid==i?(r=t.quest_id,!0):void 0}),r&&(this.textEnds.text=(n[r].progress||0)+"/"+n[r].upper_limit),[2]}})})},e.prototype.getJSON=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/json/recordData.json",function(t){e(t)},t,RES.ResourceItem.TYPE_JSON)})},e.prototype.draw=function(t){return __awaiter(this,void 0,void 0,function(){var e,i,n,o,r,s,a,c,h,u=this;return __generator(this,function(d){switch(d.label){case 0:return Logger.log("this chapter is "+t),e=this.gScroller,e.$children.length>0&&this.groupCache(e),i=this.gStory.width,n=550,o=0,r=0,this.curX=0,this.curY=0,s=STORY.chapterInfo(t),a=STORY.chapterExplore(t),this.textPercent.text="本章探索度："+a,this.percentBar.value=parseInt(a),this.textExplore50.textColor=this.percentBar.value<50?7960953:16706228,this.textExplore75.textColor=this.percentBar.value<75?7960953:16706228,this.textExplore100.textColor=this.percentBar.value<100?7960953:16706228,this.btnReturn.label=s.ChapterLabel,c=void 0,h=function(){var n=s.nodes,a=function(t,e){var i;for(var o in n)if(i=n[o],i[t]==e)break;return i};n.forEach(function(n,s){0==s&&(o=150-n.posX);var h=STORY.allPath.some(function(t){return t==n.id}),d=STORY.currentPath.some(function(t){return t==n.id});if((h||d)&&n.Childs.length>0){if(n.Childs){var l=n.Childs.some(function(t){return STORY.allPath.some(function(e){return e==t})});l&&n.Childs.map(function(t){a("id",t).broPlayed=!0})}n.line&&n.line.map(function(t){var i=a("EditorFlag",t.to),s=STORY.allPath.some(function(t){return t==i.id}),c=STORY.currentPath.some(function(t,e){return t==n.id&&STORY.currentPath[e+1]==i.id}),h=i.id==STORY.blockid,l=function(){var i=u.get("egret.Shape");d&&c||d&&h&&STORY.currentPath.indexOf(STORY.blockid)<0?i.graphics.lineStyle(2,14078148):i.graphics.lineStyle(2,5263440),i.graphics.moveTo(t.pos[0].x+o,-t.pos[0].y+r);for(var n=1;n<t.pos.length;n++)i.graphics.lineTo(t.pos[n].x+o,-t.pos[n].y+r);i.graphics.endFill(),d&&c||d&&h?e.addChild(i):e.addChildAt(i,0)};"SmallBlock"==i.BlockType?t.active||!i.broPlayed||s||c?t.active&&(s||c)&&l():l():(s||c||i.broPlayed)&&l()})}var p;if(h||d){if(n.storyEnd)p=n.id==STORY.blockid?u.get("Component.Storyline_curblock"):STORY.undoneNode(n.id)?d?u.get("Component.Storyline_cannot_curr"):u.get("Component.Storyline_cannot"):u.get("Component.Storyline_StoryEnd",{desc:n.desc});else if(n.chapterEnd)p=n.id==STORY.blockid?u.get("Component.Storyline_curblock"):u.get("Component.Storyline_ChapterEnd",{desc:n.desc});else if(n.keyEvent)p=n.id==STORY.blockid?u.get("Component.Storyline_curblock"):u.get("Component.Storyline_KeyEvent",{keyEventDesc:n.keyEventDesc});else if("SmallBlock"==n.BlockType)p=d?u.get("Component.Storyline_badend_curr"):u.get("Component.Storyline_badend"),p.gPlay.visible=!1;else if("BigBlock"==n.BlockType)p=d?u.get("Component.Storyline_reached_curr"):u.get("Component.Storyline_reached");else{if("LockBlock"!=n.BlockType)return void Logger.log("有节点"+n.id+"没有位置信息");p=n.id==STORY.blockid?u.get("Component.Storyline_curblock"):d?u.get("Component.Storyline_cannot_curr"):u.get("Component.Storyline_cannot"),n.id==STORY.blockid&&(p.btnCurrent.visible=!0,p.btnPlay.visible=!1)}p.x=n.posX-p.width/2+o,p.y=-n.posY-p.height/2+r,n.endNode&&!STORY.undoneNode(n.id)&&u.endNum++}else{if(!n.broPlayed)return;p=u.get("Component.Storyline_notReachedButShow"),p.x=n.lockX-p.width/2+o,p.y=-n.lockY-p.height/2+r}p.imgThumb&&(p.imgThumb.source=n.ChapterImage?"https://www.npcstudio.cn/images/story/node1/"+n.ChapterImage+".png":"BigBlock"==n.BlockType?"gushixian_huisuyulang_png":"SmallBlock"==n.BlockType?"gushixian_huisube_png":"none",p.image=n.ChapterImage?n.ChapterImage:"none"),p.name=n.id;var g=n.contentLst.InRect?n.contentLst.InRect:"",f=n.contentLst.BellowRect?n.contentLst.BellowRect:"";p.info={id:n.id,title:g,text:f,chapterid:t,CanReplay:n.CanReplay},p.EditorFlag=n.EditorFlag,p.textTitle&&(p.textTitle.text=g),n.desc&&p.setDesc&&p.setDesc(n.desc),n.smallpic&&p.setIcon&&p.setIcon(n.smallpic),n.id==STORY.blockid?(c=p,u.curX=n.posX,u.curY=-n.posY,p.gCurrent&&p.currentOn()):(e.addChild(p),p.gCurrent&&p.currentOff()),i=p.x+p.width>i?p.x+p.width+100:i}),Logger.log("xratio:"+o)},s.nodes?(h(),Logger.log("加载本地节点信息，章节ID："+t),[3,3]):[3,1];case 1:return[4,StoryData.getBlockInfo(t).then(function(){h(),Logger.log("加载节点信息json，章节ID："+t)})];case 2:d.sent(),d.label=3;case 3:return c&&e.addChild(c),e.width=i,[2]}})})},e.prototype.get=function(t,e){var i;if(!this.pool[t]||this.pool[t].length<1){var n=egret.getDefinitionByName(t);try{i=new n(e)}catch(o){Logger.log(t+"创建对象失败")}}else i=this.pool[t].pop();if(e)for(var r in e)i[r]=e[r];return i},e.prototype.cache=function(t){var e=egret.getQualifiedClassName(t);this.pool[e]||(this.pool[e]=[]),this.pool[e].push(t)},e.prototype.groupCache=function(t){for(var e=t.$children,i=0;i<e.length;i++){var n=egret.getQualifiedClassName(e[i]);this.cache(e[i]),"egret.Shape"==n&&e[i].graphics.clear()}t.removeChildren()},e.prototype.currentLocation=function(){var t=this.gScroller.width,e=this.gStory.width,i=this.curX<e/2?0:t-this.curX>e/2?this.curX-e/2:t-e;this.scrollStory.viewport.scrollH=i,Logger.log("ratio:"+i+",vw:"+t+",gw"+e)},e.prototype.onLocation=function(){Effect.play(AUDIO.LocationButton_Press_ogg),this.chapterId!=STORY.chapterid?this.init(STORY.chapterid):this.currentLocation()},e.prototype.redpoint=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i,n,o,r,s;return __generator(this,function(a){switch(a.label){case 0:return this.award=void 0,this.rewardTween.stop(),STORY.chapterhasnew&&STORY.allPath.length>0||(this.iconChapterNew.visible=!1),t=[],Object.keys(STORY.allChaptersInfo).map(function(e){var i=STORY.allChaptersInfo[e];"global"!=e&&"GeEggNode"!==i.type&&t.push(e)}),e=Net.ws(),[4,e.send("getsettlereward",{chapter_id_list:t})];case 1:if(i=a.sent(),0!==i.ret)return[2,!1];if(i.data&&i.data.settle_reward_info_map){n=i.data.settle_reward_info_map,o=!1,r=!1;for(s in n)s==this.chapterId?(this.award=n[s].reward_list,this.initReward(),n[s].has_new&&(r=!0)):n[s].has_new&&(o=!0);o&&(this.iconChapterNew.visible=!0),r&&r&&!NOVICE[NOVICE_TYPE.reward]}return[2]}})})},e.prototype.initReward=function(){var t=this;console.log(this.award);var e=this.chapterId;this.award.forEach(function(i){if(2===i.condition){var n=void 0;switch(i.value){case 5e3:n=t.btnExplore50;break;case 7500:n=t.btnExplore75;break;case 1e4:n=t.btnExplore100}switch(i.status){case 0:n.skinName="Storyline_ExploreLockdSkin";break;case 1:n.skinName="Storyline_ExploreUnlockSkin";break;case 2:n.skinName="Storyline_ExploreReceivedSkin"}n.rewardid=i.reward_id,n.chapterid=e,n.coins=i.reward_money.coins}})},e.prototype.onWheel=function(t){this.storyPop||Widget.currentPop||(t=-t,this.gScroller.contentWidth<this.scrollStory.viewport.width||0>t&&0===this.scrollStory.viewport.scrollH||t>0&&this.scrollStory.viewport.scrollH===this.gScroller.contentWidth-this.scrollStory.viewport.width+100||(clearTimeout(this.scrollTimer),0>t&&this.scrollStory.viewport.scrollH+t<0?this.scrollStory.viewport.scrollH=0:t>0&&this.scrollStory.viewport.scrollH+t>this.gScroller.contentWidth-this.scrollStory.viewport.width?this.scrollStory.viewport.scrollH=this.gScroller.contentWidth-this.scrollStory.viewport.width+100:this.scrollStory.viewport.scrollH+=t,this.scrollTimer=setTimeout(function(){Effect.play(AUDIO.Storyline_Slide_ogg)},200)))},e.prototype.cachePop=function(t){this.storyPop=t},e.prototype.clearPop=function(){this.storyPop&&(this.storyPop.parent.removeChild(this.storyPop),this.storyPop=void 0)},e.prototype.onKeyboard=function(t){switch(t){case 27:this.storyPop?this.clearPop():this.btnReturn.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP));break;case 13:}},e}(eui.Component);t.StoryView=e,__reflect(e.prototype,"Skin.StoryView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));var Skin;!function(t){var e=function(t){function e(){var i=t.call(this)||this;switch(i.dataRes=[],i.dataRate=[],i.thumbCache=new egret.Bitmap,i.touchid=0,i.keyboard=!0,i.waiting=!1,i.skinName="VideoSkin",e.that=i,i.showTimer=new egret.Timer(3e3,1),i.showTimer.addEventListener(egret.TimerEvent.TIMER,function(){"paused"!==i.playStatus&&i.showOff()},i),i.gThumbTimer=new egret.Timer(1500,1),i.gThumbTimer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,function(){i.gPreview.visible=!1},i),i.layRect.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){i.controlShow?i.showOff():i.showOn()},i),i.buttonRect.addEventListener(egret.TouchEvent.TOUCH_TAP,i.showTopControl,i),i.gNav.addEventListener(mouse.MouseEvent.MOUSE_OVER,i.stopShowTime,i),i.gNav.addEventListener(mouse.MouseEvent.MOUSE_OUT,i.resetShowTime,i),i.gControl.addEventListener(mouse.MouseEvent.MOUSE_OVER,i.stopShowTime,i),i.gControl.addEventListener(mouse.MouseEvent.MOUSE_OUT,i.resetShowTime,i),i.thumb.fillMode=egret.BitmapFillMode.SCALE,egret.Tween.get(i.thumbLoading,{loop:!0}).to({rotation:360},4e3),egret.Tween.pauseTweens(i.thumbLoading),i.gPanel.touchEnabled=!1,i.gPreview.touchEnabled=!1,i.btnReturn.label=STORY.chapterInfo(STORY.chapterid).ChapterLabel||"隐形守护者",i.btnPlay.currentState="pause",i.playStatus="paused",i.btnPlay.addEventListener(egret.TouchEvent.TOUCH_TAP,i.toggle,i),i.iconPause.addEventListener(egret.TouchEvent.TOUCH_TAP,i.play,i),mouse.setButtonMode(i.iconPause,!0),i.sliderVideo.minimum=0,i.sliderVideo.value=0,i.sliderVideo.maximum=100,i.sliderVideo.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){i.dragStatus=!0},i),i.sliderVideo.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,i.vsChange,i),i.sliderVideo.addEventListener(egret.TouchEvent.TOUCH_END,i.tapChange,i),i.sliderVideo.addEventListener(egret.TouchEvent.CHANGE,i.vsChanging,i),i.btnDefn.visible=!0,i.btnDefn.addEventListener(egret.TouchEvent.TOUCH_TAP,i.openDefnPanel,i),i.btnDefn.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(t){(t.localX<0||t.localX>t.target.width)&&i.closeDefnPanel()},i),USER.defn){case 1:i.btnDefn.label="超清";break;case 2:i.btnDefn.label="高清";break;case 3:i.btnDefn.label="普通"}return i.gRes.addEventListener(mouse.MouseEvent.MOUSE_OVER,i.openDefnPanel,i),i.gRes.addEventListener(mouse.MouseEvent.MOUSE_OUT,i.closeDefnPanel,i),i.btnRate.addEventListener(egret.TouchEvent.TOUCH_TAP,i.openRatePanel,i),i.gRate.addEventListener(mouse.MouseEvent.MOUSE_OVER,i.openRatePanel,i),i.gRate.addEventListener(mouse.MouseEvent.MOUSE_OUT,i.closeRatePanel,i),i.btnRate.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(t){(t.localX<0||t.localX>t.target.width)&&i.closeRatePanel()},i),i.btnSound.addEventListener(egret.TouchEvent.TOUCH_TAP,i.toggleSound,i),i.gSound.addEventListener(mouse.MouseEvent.MOUSE_OVER,i.openSoundPanel,i),i.gSound.addEventListener(mouse.MouseEvent.MOUSE_OUT,i.closeSoundPanel,i),i.sliderSound.addEventListener(egret.TouchEvent.CHANGE,i.onSound,i),i.sliderSound.addEventListener(eui.UIEvent.CHANGE_END,i.saveSound,i),i.btnSound.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(t){(t.localX<0||t.localX>t.target.width)&&i.closeSoundPanel()},i),i.btnSetting.addEventListener(egret.TouchEvent.TOUCH_TAP,i.openSettingPanel,i),i.btnReturn2.label=STORY.chapterInfo(STORY.chapterid).ChapterLabel||"隐形守护者",i.btnReturn2.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Player.exit(PlayerFlag.PS_Home),i.gError.visible=!1},i),i.btnRetry.addEventListener(egret.TouchEvent.TOUCH_TAP,function(t){Player.load(i).then(function(t){t&&(i.gError.visible=!1,Player.play())}),t.stopImmediatePropagation(),t.stopPropagation()},i),i.btnDefnRetry.addEventListener(egret.TouchEvent.TOUCH_TAP,function(t){var e;switch(1===USER.defn?e=2:(2===USER.defn||3===USER.defn)&&(e=1),e){case 1:i.btnDefn.label="超清";break;case 2:i.btnDefn.label="高清";break;case 3:i.btnDefn.label="普通"}!i.initDefnPanel&&i.setDefn(),i.dataRes.forEach(function(t){t.selected=!1,t.currentState="up"}),i.dataRes[e-1].selected=!0,i.dataRes[e-1].currentState="down",Player.setDefn(e).then(function(t){t&&(i.gError.visible=!1,Player.play())}),t.stopImmediatePropagation(),t.stopPropagation()},i),i.btnReturn.addEventListener(egret.TouchEvent.TOUCH_TAP,i["return"],i),i.btnStory.addEventListener(egret.TouchEvent.TOUCH_TAP,i.navStory,i),i.btnRecord.addEventListener(egret.TouchEvent.TOUCH_TAP,i.navRecord,i),Events.register("dataChange",i.showCU,i),i.showCU(),i.timer=new egret.Timer(200,0),i.timer.addEventListener(egret.TimerEvent.TIMER,function(){!i.dragStatus&&i.setProcess(),!i.dragStatus&&i.setText(),i.sliderVideo.enabled=Player.dragable()},i),i.btnSkip.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){Player.skip()},i),i.onMouse(),i}return __extends(e,t),e.prototype.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e.prototype.beforeAdd=function(t){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,Player.checkNetWork()];case 1:return t=i.sent(),t?[4,this.initPlayer()]:[3,3];case 2:return e=i.sent(),[2,e];case 3:return[2,!1]}})})},e.prototype.afterAdd=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.gPanel.visible&&(this.gPanel.visible=!1,this.showOff()),this.waiting=!1,this.initSound(),this.initTitle(),Load.group(["end"]),this.showTimer&&(this.showTimer.reset(),this.showTimer.start()),[2]})})},e.prototype.beforeExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},e.prototype.afterExit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.sliderVideo.value=0,this.textCurrent.text="00:00:00",this.textTime.text="/00:01:00",this.clear(),[2]})})},e.prototype.clearButton=function(){if(this.gQTE.visible=!1,this.button){this.button.timer&&(this.button.timer.reset(),this.button.timer=void 0);var t=this.button.parent;t.removeChild(this.button),this.button=void 0}},e.prototype.clear=function(){this.clearButton(),this.pauseAction(),this.removeVideoError()},e.prototype.displayControl=function(t){this.gControl.visible=t,this.layRect.visible=t,this.buttonRect.visible=!t,this.btnRecord.visible=t,this.btnStory.visible=t,this.gCU.visible=t,!t&&this.gPreview.visible&&(this.gPreview.visible=!1)},e.prototype.onKeyboard=function(t){var e=this;switch(t){case 81:this.btnSkip.dispatchEvent(new egret.TouchEvent(egret.TouchEvent.TOUCH_TAP));break;case 32:!Player.choosing()&&this.toggle();break;case 27:var i=8!==Player.status();console.log(i),Scenes.addUI("Skin.EscView",{playing:i}).then(function(t){t&&(Player.pause(),e.hideAllChoice())});break;case 39:NOVICE[NOVICE_TYPE.firstchapter]&&!Player.choosing()&&5!==Player.status()&&this.seek(Player.currentTime()+5);break;case 37:NOVICE[NOVICE_TYPE.firstchapter]&&!Player.choosing()&&5!==Player.status()&&this.seek(Player.currentTime()-5);break;case 49:case 50:case 51:case 52:case 53:case 54:this.keyboardChoice(t-49);break;case 97:case 98:case 99:case 100:case 101:case 102:this.keyboardChoice(t-97)}},e.prototype.onMouse=function(){var t=this;this.btnPlay.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){switch(t.tipsPlay.visible=!0,t.playStatus){case"playing":t.btnPlay.currentState="playdown",t.tipsPlay.label="暂停";break;case"paused":t.btnPlay.currentState="pausedown",t.tipsPlay.label="播放"}},this),this.btnPlay.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){switch(t.tipsPlay.visible=!1,t.playStatus){case"playing":t.btnPlay.currentState="play";break;case"paused":t.btnPlay.currentState="pause"}},this),this.btnPlay.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.mouseclickPlay=!0},this),this.btnSound.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){t.sliderSound.value>0?t.btnSound.currentState="sounddown":t.btnSound.currentState="mutedown"},this),this.btnSound.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){t.sliderSound.value>0?t.btnSound.currentState=t.gSound.visible?"sounddown":"sound":t.btnSound.currentState=t.gSound.visible?"mutedown":"mute"},this);var e=[this.btnReturn,this.btnReturn2,this.btnRecord,this.btnStory,this.btnDefn,this.btnRate,this.btnSetting];e.map(function(e){var i;e.name&&t["tips"+e.name]&&(i=t["tips"+e.name]),e.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){e.enabled&&(e.currentState="down"),i&&(i.visible=!0)},t),e.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){e.enabled&&(e.currentState="up"),i&&(i.visible=!1)},t)}),this.btnSkip.addEventListener(mouse.MouseEvent.MOUSE_OVER,function(){t.btnSkipStatus&&(t.btnSkip.currentState="down"),t.tipsSkip.visible=!0},this),this.btnSkip.addEventListener(mouse.MouseEvent.MOUSE_OUT,function(){t.btnSkipStatus&&(t.btnSkip.currentState="up"),t.tipsSkip.visible=!1},this)},e.prototype.initSound=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return 0!=USER.volume?[3,2]:[4,Volume.get()];case 1:return t=e.sent(),this.sliderSound.value=100*t,USER.volume=t,[3,3];case 2:this.sliderSound.value=100*USER.volume,e.label=3;case 3:return this.sliderSound.value>0?this.btnSound.currentState="sound":this.btnSound.currentState="mute",[2]}})})},e.prototype.initPlayer=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,Player.load(this,{cmd:this.cmd,data:this.params})];case 1:return t=e.sent(),t?(this.setProcess(),this.setText(),NOVICE[NOVICE_TYPE.start]||Novice.set(NOVICE_TYPE.start),[2,!0]):[2,!1]}})})},e.prototype.showTopControl=function(){this.controlShow?(this.controlShow=!1,this.showOff()):(this.controlShow=!0,this.showTop(),this.resetShowTime())},e.prototype.showOn=function(){Logger.log("打开面板"),this.controlShow=!0,this.showTop(),this.showButtom(),this.resetShowTime(),this.showSkip()},e.prototype.showSkip=function(){console.log("+++++++++++++++++++++++++++++skip status"+this.btnSkipStatus),this.btnSkipStatus&&(this.btnSkip.enabled=!0,this.btnSkip.currentState="up")},e.prototype.hideSkip=function(){this.btnSkip.currentState="disabled"},e.prototype.showTop=function(){this.gPanel.visible=!0,this.gNav.visible=!0,this.gNav.top=-this.gNav.height,egret.Tween.get(this.gNav).to({top:0},200,egret.Ease.sineIn)},e.prototype.showButtom=function(){this.closeDefnPanel(),this.closeRatePanel(),this.closeSoundPanel(),this.sliderVideo.visible=NOVICE[NOVICE_TYPE.firstchapter]?!0:!1,this.textCurrent.visible=NOVICE[NOVICE_TYPE.firstchapter]?!0:!1,this.textTime.visible=NOVICE[NOVICE_TYPE.firstchapter]?!0:!1,this.gPanel.visible=!0,this.gControl.visible=!0,this.btnStory.visible=!0,this.gControl.bottom=-this.btnStory.bottom-this.btnStory.height-20;var t=0;egret.Tween.get(this.gControl).to({bottom:t},200,egret.Ease.sineIn)},e.prototype.showOff=function(){var t=this;Logger.log("关闭面板");var e=200;egret.Tween.get(this.gNav).to({top:-this.gNav.height},e,egret.Ease.sineIn),egret.Tween.get(this.gControl).to({bottom:-this.btnStory.bottom-this.btnStory.height-20},e,egret.Ease.sineIn).call(function(){t.controlShow=!1,t.gPanel.visible=!1,t.gControl.visible=!1,t.btnStory.visible=!1,t.hideSkip()})},e.prototype.resetShowTime=function(){this.controlShow&&(this.showTimer.reset(),this.showTimer.start())},e.prototype.stopShowTime=function(){this.showTimer.running&&this.showTimer.stop()},e.prototype.initTitle=function(){this.btnReturn.label=STORY.chapterInfo(STORY.chapterid).ChapterLabel||"隐形守护者",this.btnReturn2.label=STORY.chapterInfo(STORY.chapterid).ChapterLabel||"隐形守护者"},e.prototype.initQTE=function(){var t=this.width/this.gQTE.width,e=this.height/this.gQTE.height,i=Math.min(e,t);this.QTEratio=i,this.gQTE.width=Math.floor(this.gQTE.width*i),this.gQTE.height=Math.floor(this.gQTE.height*i),this.gQTE.x=Math.floor((this.width-this.gQTE.width*i)/2),this.gQTE.y=Math.floor((this.height-this.gQTE.height*i)/2),this.initQteStatus=!0},e.prototype.keyboardChoice=function(t){this.button&&this.button.choose(t)},e.prototype.showTextChoice=function(t){this.gError.visible||(this.showOff(),this.clearButton(),this.button=new Component.TextChoice(t),this.addChild(this.button))},e.prototype.showQTEChoice=function(t){this.gError.visible||(this.initQteStatus||this.initQTE(),this.showOff(),this.clearButton(),this.button=new Component.QTEChoice(t,this.QTEratio),this.button.width=this.gQTE.width,this.button.height=this.gQTE.height,this.gQTE.visible=!0,this.gQTE.touchEnabled=!1,this.gQTE.addChild(this.button))},e.prototype.showImageChoice=function(t){this.gError.visible||(this.initQteStatus||this.initQTE(),this.showOff(),this.clearButton(),this.button=new Component.ImageChoice(t,this.QTEratio),this.button.width=this.gQTE.width,this.button.height=this.gQTE.height,this.gQTE.visible=!0,this.gQTE.touchEnabled=!1,this.gQTE.addChild(this.button))},e.prototype.showConfirmButton=function(t){this.gError.visible||(this.keyboard=!1,this.showOff(),this.clearButton(),this.button=new Component.ConfirmButton(t),this.addChild(this.button))},e.prototype.showTimeChoice=function(t){this.gError.visible||(this.showOff(),this.clearButton(),this.button=new Component.TimeChoice(t),this.addChild(this.button))},e.prototype.hideAllChoice=function(){this.button&&(this.button.visible=!1,this.button.timer&&this.button.timer.stop())},e.prototype.showAllChoice=function(){this.button&&(this.button.visible=!0,this.button.timer&&this.button.timer.start())},e.prototype.showQTE=function(t){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(i){switch(i.label){case 0:return this.gError.visible?[2]:(this.initQteStatus||this.initQTE(),this.showOff(),this.clearButton(),e=this,[4,Component.QTEinit(t,this.QTEratio)]);case 1:return e.button=i.sent(),this.button.width=this.gQTE.width,this.button.height=this.gQTE.height,this.gQTE.visible=!0,this.gQTE.touchEnabled=!1,this.gQTE.addChild(this.button),[2]}})})},e.prototype.showContiue=function(t){var e=this;this.textContinue.text="上次观看至"+this.formatTime(t)+"，将为您续播",this.textContinue.visible=!0,setTimeout(function(){egret.Tween.get(e.textContinue).to({alpha:0},300).call(function(){e.textContinue.visible=!1,e.textContinue.alpha=1})},1e3)},e.prototype.navStory=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return NOVICE[NOVICE_TYPE.choice]?this.waiting?[2]:(this.waiting=!0,[4,Player.save(PlayerFlag.PS_Story)]):[3,5];case 1:return(t=e.sent())?(Effect.play(AUDIO.UI_back_ogg),Player.destroy(),[4,Scenes.addUI("Skin.StoryView",{chapterId:STORY.chapterid})]):[3,3];case 2:return e.sent(),Player.exit(),this.waiting=!1,[2,!0];case 3:return this.waiting=!1,[2,!1];case 4:return[3,6];case 5:return Effect.play(AUDIO.UI_Warn_ogg),Toast.show("完成第一个选择后解锁"),[2,!1];case 6:return[2]}})})},e.prototype.navRecord=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return NOVICE[NOVICE_TYPE.choice]?this.waiting?[2]:(this.waiting=!0,[4,Player.save(PlayerFlag.PS_Story)]):[3,5];case 1:return(t=i.sent())?(e=8!==Player.status(),[4,Scenes.addUI("Skin.RecordView",{status:e})]):[3,3];case 2:return i.sent(),Effect.play(AUDIO.UI_back_ogg),Player.pause(),this.waiting=!1,[2,!0];case 3:return this.waiting=!1,[2,!1];case 4:return[3,6];case 5:return Effect.play(AUDIO.UI_Warn_ogg),Toast.show("完成第一个选择后解锁"),[2,!1];case 6:return[2]}})})},e.prototype["return"]=function(){var t=this;this.waiting||(this.waiting=!0,Scenes.addUI("Skin.StartView").then(function(e){Effect.play(AUDIO.UI_back_ogg),e&&Player.exit(PlayerFlag.PS_Home),t.waiting=!1}))},e.prototype.setProcess=function(){var t=Player.currentTimeRate();this.sliderVideo.value=100*t,this.sliderVideo.trackBuffer.width=Player.bufferEnd()/Player.duration()*this.sliderVideo.width},e.prototype.setText=function(){var t=Player.duration(),e=Player.currentTime();e>t&&(t=e);var i=[Player.dragStart(),Player.dragEnd()],n=i[0];i[1];this.textCurrent.text=this.formatTime(e-n>0?e-n:0),this.textTime.text="/"+this.formatTime(t-n)},e.prototype.toggle=function(){switch(Logger.log(this.playStatus),this.playStatus){case"playing":this.pause();break;case"paused":this.play()}},e.prototype.pause=function(){Player.pause()},e.prototype.pauseAction=function(){this.timer.stop(),this.gPreview.visible=!1,this.stopShowTime(),this.playStatus="paused","Skin.VideoView"==Scenes.currentUI&&(this.iconPause.visible=!0,this.showOn()),this.mouseclickPlay?(this.btnPlay.currentState="pausedown",this.tipsPlay.label="播放",this.mouseclickPlay=!1):this.btnPlay.currentState="pause"},e.prototype.play=function(){Player.play()},e.prototype.playAction=function(){this.timer.start(),this.gPreview.visible=!1,this.resetShowTime(),this.playStatus="playing",this.iconPause.visible=!1,this.mouseclickPlay?(this.btnPlay.currentState="playdown",this.tipsPlay.label="暂停",this.mouseclickPlay=!1):this.btnPlay.currentState="play"},e.prototype.seek=function(t){Player.seekAble()&&Player.currentTime(t)},e.prototype.vsChange=function(t){var e=this.sliderVideo.value;this.dragStatus=!1,Player.currentTimeRate(e/100>1?1:e/100),this.gPreview.visible=!1,this.setText(),egret.Tween.pauseTweens(this.thumbLoading),this.resetShowTime(),"paused"==this.playStatus&&this.play()},e.prototype.tapChange=function(t){this.tapEvent(t,this.vsChange,this.vsChange)},e.prototype.vsChanging=function(t){this.dragStatus=!0,this.sliderVideo.currentState="down",this.stopShowTime(),this.videoPreview(this.sliderVideo.value/100*(Player.duration()-Player.dragStart())+Player.dragStart())},e.prototype.formatTime=function(t){t=Math.ceil(t)||0;var e=[Math.floor(t/60/60),Math.floor(t/60%60),t%60];return e.join(":").replace(/\b(\d)\b/g,"0$1")},e.prototype.openDefnPanel=function(){this.closeRatePanel(),this.closeSoundPanel(),!this.initDefnPanel&&this.setDefn(),this.gRes.visible=!0},e.prototype.closeDefnPanel=function(){this.gRes.visible=!1},e.prototype.setDefn=function(){for(var t=this,e=[{name:"超清",defn:1},{name:"高清",defn:2},{name:"普通",defn:3}],i=0;i<e.length;i++){var n=new Component.DefnChange;
n.name=e[i].name,n.label=e[i].name,n.defn=e[i].defn,n.horizontalCenter=0,n.y=41*i,n.selected=n.defn==USER.defn?!0:!1,n.currentState=n.defn==USER.defn?"down":"up",this.dataRes.push(n),this.gResButton.addChild(n),n.addEventListener(eui.UIEvent.CHANGE,function(e){var i=e.target;Logger.log("切换清晰度为"+i.name);for(var n=0;n<t.dataRes.length;n++)t.dataRes[n].selected=!1,t.dataRes[n].currentState="up";i.selected=!0,i.currentState="down",t.btnDefn.label=i.name.split(" ")[0];var o=new eui.Label;o.size=22,o.fontFamily="Microsoft Yahei",o.textColor=16777215,o.horizontalCenter=0,o.y=59,o.textFlow=[{text:"正在为您切换为"},{text:i.name,style:{textColor:16740352}},{text:"清晰度，请稍候..."}],t.addChild(o),Player.setDefn(i.defn).then(function(){t.removeChild(o)})},this)}this.initDefnPanel=!0},e.prototype.openRatePanel=function(){this.closeDefnPanel(),this.closeSoundPanel(),!this.initRatePanel&&this.setRate(),this.gRate.visible=!0},e.prototype.closeRatePanel=function(){this.gRate.visible=!1},e.prototype.setRate=function(){for(var t=this,e=[{name:"1.0x",rate:1},{name:"1.25x",rate:1.25},{name:"1.5x",rate:1.5}],i=0;i<e.length;i++){var n=new Component.DefnChange;n.name=e[i].name,n.label=e[i].name,n.defn=e[i].rate,n.horizontalCenter=0,n.y=41*i,this.dataRate.push(n),this.gRateButton.addChild(n),n.addEventListener(eui.UIEvent.CHANGE,function(e){var i=e.target;Logger.log("切换倍速播放为"+i.name);for(var n=0;n<t.dataRate.length;n++)t.dataRate[n].selected=!1,t.dataRate[n].currentState="up";i.selected=!0,i.currentState="down",Player.playbackRate(Number(i.defn)),t.btnRate.label=1==i.defn?"倍速":i.name,t.onTips([{text:"已为您切换倍速"},{text:i.label,style:{textColor:16740352}}])},this)}this.dataRate[0].selected=!0,this.initRatePanel=!0},e.prototype.initRate=function(){this.btnRate.label=1===Player.playbackRate()?"倍速":Player.playbackRate()+"x",this.dataRate.length>0&&this.dataRate.forEach(function(t,e){0===e?(t.selected=!0,t.currentState="down"):(t.selected=!1,t.currentState="up")})},e.prototype.saveSound=function(){var t=this.sliderSound.value/100;Steam.updateSetting({volume:t})},e.prototype.toggleSound=function(){this.gSound.visible?(this.sliderSound.value>0?(this.btnSound.currentState="mutedown",this.currentSound=this.sliderSound.value,this.sliderSound.value=0):(this.btnSound.currentState="sounddown",this.sliderSound.value=this.currentSound?this.currentSound:50),Volume.set(this.sliderSound.value/100),this.saveSound()):this.openSoundPanel()},e.prototype.openSoundPanel=function(){this.closeDefnPanel(),this.closeRatePanel(),this.gSound.visible=!0,this.sliderSound.value>0?this.btnSound.currentState="sounddown":this.btnSound.currentState="mutedown"},e.prototype.closeSoundPanel=function(){this.gSound.visible=!1,this.sliderSound.value>0?this.btnSound.currentState="sound":this.btnSound.currentState="mute"},e.prototype.onSound=function(){Volume.set(this.sliderSound.value/100),Logger.log(this.sliderSound.value+","+USER.volume),this.sliderSound.value>0?this.btnSound.currentState="sounddown":this.btnSound.currentState="mutedown"},e.prototype.onTips=function(t,e){var i=this;"string"==typeof t?this.textTips.text=t:this.textTips.textFlow=t;var n=e?e:1e3;this.gTips.visible=!0,setTimeout(function(){return i.gTips.visible=!1},n)},e.prototype.videoError=function(t){Logger.error("videoError---->"),this.clearButton(),this.textError.text=t,this.gError.visible=!0,this.errorStatus=!0},e.prototype.removeVideoError=function(){this.errorStatus=!1,this.gError.visible=!1},e.prototype.openSettingPanel=function(){var t=this;this.waiting||(this.waiting=!0,Scenes.addUI("Skin.SettingView",{status:Player.playing()}).then(function(e){e&&(Effect.play(AUDIO.Set_Press_ogg),Player.pause()),t.waiting=!1}))},e.prototype.videoPreview=function(t){var e=this;if(this.textCurrent.text=this.posLabel.text=this.formatTime(t-Player.dragStart()),this.gPreview.visible=this.gPanel.visible?!0:!1,this.gThumbTimer.running&&this.gThumbTimer.reset(),Thumb.smallLoaded>90)if(t<Player.dragEnd()){var i=Thumb.get(t);i.img?RES.getResByUrl(i.img,function(t){if(t){e.thumbLoading.visible=!1,egret.Tween.pauseTweens(e.thumbLoading),e.thumbCache.texture=t;var n=new egret.RenderTexture;n.drawToTexture(e.thumbCache,new egret.Rectangle(i.x*i.width,i.y*i.height,i.width,i.height)),e.thumb.visible=!0,e.thumb.texture=n,e.gThumb.visible=!0}else e.gThumb.visible=!1},this,RES.ResourceItem.TYPE_IMAGE):(this.thumb.visible=!1,egret.Tween.resumeTweens(this.thumbLoading),this.thumbLoading.visible=!0,this.gThumb.visible=!1)}else this.thumb.visible=!1,egret.Tween.resumeTweens(this.thumbLoading),this.thumbLoading.visible=!0;this.gThumbTimer.start()},e.prototype.tapEvent=function(t,e,i){var n=this;this.tapTimer?(clearTimeout(this.tapTimer),this.tapTimer=null,i.call(n,t)):this.tapTimer=setTimeout(function(){e.call(n,t),n.tapTimer=null},500)},e.prototype.onStart=function(t){this.tapStatus=!0,this.beginX=t.stageX,this.beginY=t.stageY,this.lastY=t.stageY},e.prototype.onMove=function(t){var e=Math.abs(t.stageX-this.beginX),i=Math.abs(t.stageY-this.beginY);(e>40||i>40)&&(this.tapStatus=!1);var n=e/this.width;if(e>40&&40>i||this.dragStatus&&"horizontal"===this.dragMode){this.controlShow?this.resetShowTime():this.showOn();var o=void 0,r=Player.duration(),s=Player.dragStart(),a=Player.currentTime(),c=0;n=t.stageX>this.beginX?n:-n,r>0&&60>r?c=60*n+a:r>60&&120>r?c=120*n+a:r>120&&240>r?c=240*n+a:r>240&&(c=n*(r/4)*1.01+a),c=s>c?s:c>r?r:c,o=c/r*100,this.sliderVideo.currentState="down",this.sliderVideo.value=o,this.videoPreview(c),this.dragStatus=!0,this.dragMode="horizontal","paused"==this.playStatus&&this.play()}this.lastY=t.stageY},e.prototype.onEnd=function(t){if(this.dragStatus){if("horizontal"===this.dragMode){this.gPreview.visible=!1,egret.Tween.pauseTweens(this.thumbLoading);var e=this.sliderVideo.value;Player.currentTimeRate(e/100>1?1:e/100),this.setText(),this.setProcess()}this.dragStatus=!1,this.dragMode=""}else this.controlShow?this.showOff():this.showOn()},e.prototype.onTapTap=function(t){this.tapStatus?this.tapEvent(t,this.onEnd,this.toggle):(this.onEnd(t),this.tapTimer&&clearTimeout(this.tapTimer))},e.prototype.changeTips=function(t){t.change||(1==t.dead?Toast.show("已回到出错选项，请重新选择"):2==t.dead&&Toast.show("已补齐缺失条件，以便您继续潜伏"))},e.prototype.updataChapter=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.initTitle(),NOVICE[NOVICE_TYPE.firstchapter]||Novice.set(NOVICE_TYPE.firstchapter),[2]})})},e.prototype.showCU=function(){var t=PROMPT.concurrentusers<1e4?PROMPT.concurrentusers:Math.floor(PROMPT.concurrentusers/1e3)/10+"万";this.textCU.text=t+"人正在观看"},e}(eui.Component);t.VideoView=e,__reflect(e.prototype,"Skin.VideoView",["eui.UIComponent","egret.DisplayObject"])}(Skin||(Skin={}));